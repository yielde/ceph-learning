
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>rbdmap – map RBD devices at boot time &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
    <link rel="next" title="ceph-rbdnamer – udev helper to name RBD devices" href="../ceph-rbdnamer/" />
    <link rel="prev" title="rbd-ggate – map rbd images via FreeBSD GEOM Gate" href="../rbd-ggate/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../ceph-rbdnamer/" title="ceph-rbdnamer – udev helper to name RBD devices"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../rbd-ggate/" title="rbd-ggate – map rbd images via FreeBSD GEOM Gate"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../rbd/" >Ceph Block Device</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../rbd/man/" accesskey="U">Ceph Block Device Manpages</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">rbdmap – map RBD devices at boot time</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="rbdmap-map-rbd-devices-at-boot-time">
<h1>rbdmap – map RBD devices at boot time<a class="headerlink" href="#rbdmap-map-rbd-devices-at-boot-time" title="Permalink to this heading">¶</a></h1>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this heading">¶</a></h2>
<div class="line-block">
<div class="line"><strong>rbdmap map</strong></div>
<div class="line"><strong>rbdmap unmap</strong></div>
</div>
</section>
<section id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p><strong>rbdmap</strong> is a shell script that automates <code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">map</span></code> and <code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">unmap</span></code>
operations on one or more RBD (RADOS Block Device) images. While the script can be
run manually by the system administrator at any time, the principal use case is
automatic mapping/mounting of RBD images at boot time (and unmounting/unmapping
at shutdown), as triggered by the init system (a systemd unit file,
<code class="docutils literal notranslate"><span class="pre">rbdmap.service</span></code> is included with the ceph-common package for this purpose).</p>
<p>The script takes a single argument, which can be either “map” or “unmap”.
In either case, the script parses a configuration file (defaults to <code class="docutils literal notranslate"><span class="pre">/etc/ceph/rbdmap</span></code>,
but can be overridden via an environment variable <code class="docutils literal notranslate"><span class="pre">RBDMAPFILE</span></code>). Each line
of the configuration file corresponds to an RBD image which is to be mapped, or
unmapped.</p>
<p>The configuration file format is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">IMAGESPEC</span> <span class="n">RBDOPTS</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">IMAGESPEC</span></code> should be specified as <code class="docutils literal notranslate"><span class="pre">POOLNAME/IMAGENAME</span></code> (the pool
name, a forward slash, and the image name), or merely <code class="docutils literal notranslate"><span class="pre">IMAGENAME</span></code>, in which
case the <code class="docutils literal notranslate"><span class="pre">POOLNAME</span></code> defaults to “rbd”. <code class="docutils literal notranslate"><span class="pre">RBDOPTS</span></code> is an optional list of
parameters to be passed to the underlying <code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">map</span></code> command. These parameters
and their values should be specified as a comma-separated string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PARAM1</span><span class="o">=</span><span class="n">VAL1</span><span class="p">,</span><span class="n">PARAM2</span><span class="o">=</span><span class="n">VAL2</span><span class="p">,</span><span class="o">...</span><span class="p">,</span><span class="n">PARAMN</span><span class="o">=</span><span class="n">VALN</span>
</pre></div>
</div>
<p>This will cause the script to issue an <code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">map</span></code> command like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rbd</span> <span class="nb">map</span> <span class="n">POOLNAME</span><span class="o">/</span><span class="n">IMAGENAME</span> <span class="o">--</span><span class="n">PARAM1</span> <span class="n">VAL1</span> <span class="o">--</span><span class="n">PARAM2</span> <span class="n">VAL2</span>
</pre></div>
</div>
<p>(See the <code class="docutils literal notranslate"><span class="pre">rbd</span></code> manpage for a full list of possible options.)
For parameters and values which contain commas or equality signs, a simple
apostrophe can be used to prevent replacing them.</p>
<p>When run as <code class="docutils literal notranslate"><span class="pre">rbdmap</span> <span class="pre">map</span></code>, the script parses the configuration file, and for
each RBD image specified attempts to first map the image (using the <code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">map</span></code>
command) and, second, to mount the image.</p>
<p>When run as <code class="docutils literal notranslate"><span class="pre">rbdmap</span> <span class="pre">unmap</span></code>, images listed in the configuration file will
be unmounted and unmapped.</p>
<p><code class="docutils literal notranslate"><span class="pre">rbdmap</span> <span class="pre">unmap-all</span></code> attempts to unmount and subsequently unmap all currently
mapped RBD images, regardless of whether or not they are listed in the
configuration file.</p>
<p>If successful, the <code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">map</span></code> operation maps the image to a <code class="docutils literal notranslate"><span class="pre">/dev/rbdX</span></code>
device, at which point a udev rule is triggered to create a friendly device
name symlink, <code class="docutils literal notranslate"><span class="pre">/dev/rbd/POOLNAME/IMAGENAME</span></code>, pointing to the real mapped
device.</p>
<p>In order for mounting/unmounting to succeed, the friendly device name must
have a corresponding entry in <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>.</p>
<p>When writing <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> entries for RBD images, it’s a good idea to specify
the “noauto” (or “nofail”) mount option. This prevents the init system from
trying to mount the device too early - before the device in question even
exists. (Since <code class="docutils literal notranslate"><span class="pre">rbdmap.service</span></code>
executes a shell script, it is typically triggered quite late in the boot
sequence.)</p>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">¶</a></h2>
<p>Example <code class="docutils literal notranslate"><span class="pre">/etc/ceph/rbdmap</span></code> for three RBD images called “bar1”, “bar2” and “bar3”,
which are in pool “foopool”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foopool</span><span class="o">/</span><span class="n">bar1</span>    <span class="nb">id</span><span class="o">=</span><span class="n">admin</span><span class="p">,</span><span class="n">keyring</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">keyring</span>
<span class="n">foopool</span><span class="o">/</span><span class="n">bar2</span>    <span class="nb">id</span><span class="o">=</span><span class="n">admin</span><span class="p">,</span><span class="n">keyring</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">keyring</span>
<span class="n">foopool</span><span class="o">/</span><span class="n">bar3</span>    <span class="nb">id</span><span class="o">=</span><span class="n">admin</span><span class="p">,</span><span class="n">keyring</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">keyring</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="s1">&#39;lock_on_read,queue_depth=1024&#39;</span>
</pre></div>
</div>
<p>Each line in the file contains two strings: the image spec and the options to
be passed to <code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">map</span></code>. These two lines get transformed into the following
commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rbd</span> <span class="nb">map</span> <span class="n">foopool</span><span class="o">/</span><span class="n">bar1</span> <span class="o">--</span><span class="nb">id</span> <span class="n">admin</span> <span class="o">--</span><span class="n">keyring</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">keyring</span>
<span class="n">rbd</span> <span class="nb">map</span> <span class="n">foopool</span><span class="o">/</span><span class="n">bar2</span> <span class="o">--</span><span class="nb">id</span> <span class="n">admin</span> <span class="o">--</span><span class="n">keyring</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">keyring</span>
<span class="n">rbd</span> <span class="nb">map</span> <span class="n">foopool</span><span class="o">/</span><span class="n">bar2</span> <span class="o">--</span><span class="nb">id</span> <span class="n">admin</span> <span class="o">--</span><span class="n">keyring</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">ceph</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">keyring</span> <span class="o">--</span><span class="n">options</span> <span class="n">lock_on_read</span><span class="p">,</span><span class="n">queue_depth</span><span class="o">=</span><span class="mi">1024</span>
</pre></div>
</div>
<p>If the images had XFS file systems on them, the corresponding <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>
entries might look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">rbd</span><span class="o">/</span><span class="n">foopool</span><span class="o">/</span><span class="n">bar1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">bar1</span> <span class="n">xfs</span> <span class="n">noauto</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">rbd</span><span class="o">/</span><span class="n">foopool</span><span class="o">/</span><span class="n">bar2</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">bar2</span> <span class="n">xfs</span> <span class="n">noauto</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">rbd</span><span class="o">/</span><span class="n">foopool</span><span class="o">/</span><span class="n">bar3</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">bar3</span> <span class="n">xfs</span> <span class="n">noauto</span> <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
</div>
<p>After creating the images and populating the <code class="docutils literal notranslate"><span class="pre">/etc/ceph/rbdmap</span></code> file, making
the images get automatically mapped and mounted at boot is just a matter of
enabling that unit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">rbdmap</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</section>
<section id="options">
<h2>Options<a class="headerlink" href="#options" title="Permalink to this heading">¶</a></h2>
<p>None</p>
</section>
<section id="availability">
<h2>Availability<a class="headerlink" href="#availability" title="Permalink to this heading">¶</a></h2>
<p><strong>rbdmap</strong> is part of Ceph, a massively scalable, open-source, distributed
storage system. Please refer to the Ceph documentation at
<a class="reference external" href="http://ceph.com/docs">http://ceph.com/docs</a> for more information.</p>
</section>
<section id="see-also">
<h2>See also<a class="headerlink" href="#see-also" title="Permalink to this heading">¶</a></h2>
<p><a class="reference internal" href="../rbd/"><span class="doc">rbd</span></a>(8),</p>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../">
              <img class="logo" src="../../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cephfs/">Ceph File System</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../rbd/">Ceph Block Device</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../rbd/rados-rbd-cmds/">Basic Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../rbd/rbd-operations/">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../rbd/rbd-integrations/">Integrations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../rbd/man/">Manpages</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../rbd/">rbd</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-fuse/">rbd-fuse</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-nbd/">rbd-nbd</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-ggate/">rbd-ggate</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">rbd-map</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#synopsis">Synopsis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#examples">Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="#options">Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#availability">Availability</a></li>
<li class="toctree-l4"><a class="reference internal" href="#see-also">See also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../ceph-rbdnamer/">ceph-rbdnamer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-replay-prep/">rbd-replay-prep</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-replay/">rbd-replay</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-replay-many/">rbd-replay-many</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../rbd/api/">APIs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../ceph-rbdnamer/" title="ceph-rbdnamer – udev helper to name RBD devices"
             >next</a> |</li>
        <li class="right" >
          <a href="../rbd-ggate/" title="rbd-ggate – map rbd images via FreeBSD GEOM Gate"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../rbd/" >Ceph Block Device</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../../rbd/man/" >Ceph Block Device Manpages</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">rbdmap – map RBD devices at boot time</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>