
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>RBD Exclusive Locks &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="RBD Mirroring" href="../rbd-mirroring/" />
    <link rel="prev" title="Snapshots" href="../rbd-snapshot/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../rbd-mirroring/" title="RBD Mirroring"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../rbd-snapshot/" title="Snapshots"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph Block Device</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../rbd-operations/" accesskey="U">Ceph Block Device Operations</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">RBD Exclusive Locks</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="rbd-exclusive-locks">
<span id="id1"></span><h1>RBD Exclusive Locks<a class="headerlink" href="#rbd-exclusive-locks" title="Permalink to this heading">¶</a></h1>
<p id="index-0">Exclusive locks are mechanisms designed to prevent multiple processes from
accessing the same Rados Block Device (RBD) in an uncoordinated fashion.
Exclusive locks are used heavily in virtualization (where they prevent VMs from
clobbering each other’s writes) and in <a class="reference external" href="../rbd-mirroring">RBD mirroring</a> (where they are a
prerequisite for journaling in journal-based mirroring and fast generation of
incremental diffs in snapshot-based mirroring).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">exclusive-lock</span></code> feature is enabled on newly created images. This default
can be overridden via the <code class="docutils literal notranslate"><span class="pre">rbd_default_features</span></code> configuration option or the
<code class="docutils literal notranslate"><span class="pre">--image-feature</span></code> and <code class="docutils literal notranslate"><span class="pre">--image-shared</span></code> options for <code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">create</span></code> command.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Many image features, including <code class="docutils literal notranslate"><span class="pre">object-map</span></code> and <code class="docutils literal notranslate"><span class="pre">fast-diff</span></code>, depend upon
exclusive locking. Disabling the <code class="docutils literal notranslate"><span class="pre">exclusive-lock</span></code> feature will negatively
affect the performance of some operations.</p>
</div>
<p>To maintain multi-client access, the <code class="docutils literal notranslate"><span class="pre">exclusive-lock</span></code> feature implements
automatic cooperative lock transitions between clients. It ensures that only
a single client can write to an RBD image at any given time and thus protects
internal image structures such as the object map, the journal or the <a class="reference external" href="../rbd-persistent-write-log-cache">PWL
cache</a> from concurrent modification.</p>
<p>Exclusive locking is mostly transparent to the user:</p>
<ul class="simple">
<li><p>Whenever a client (a <code class="docutils literal notranslate"><span class="pre">librbd</span></code> process or, in case of a <code class="docutils literal notranslate"><span class="pre">krbd</span></code> client,
a client node’s kernel) needs to handle a write to an RBD image on which
exclusive locking has been enabled, it first acquires an exclusive lock on
the image. If the lock is already held by some other client, that client is
requested to release it.</p></li>
<li><p>Whenever a client that holds an exclusive lock on an RBD image gets
a request to release the lock, it stops handling writes, flushes its caches
and releases the lock.</p></li>
<li><p>Whenever a client that holds an exclusive lock on an RBD image terminates
gracefully, the lock is also released gracefully.</p></li>
<li><p>A graceful release of an exclusive lock on an RBD image (whether by request
or due to client termination) enables another, subsequent, client to acquire
the lock and start handling writes.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">exclusive-lock</span></code> feature does not prevent two or more
concurrently running clients from opening the same RBD image and writing to
it in turns (whether on the same node or not). In effect, their writes just
get linearized as the lock is automatically transitioned back and forth in
a cooperative fashion.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To disable automatic lock transitions between clients, the
<code class="docutils literal notranslate"><span class="pre">RBD_LOCK_MODE_EXCLUSIVE</span></code> flag may be specified when acquiring the
exclusive lock. This is exposed by the <code class="docutils literal notranslate"><span class="pre">--exclusive</span></code> option for <code class="docutils literal notranslate"><span class="pre">rbd</span>
<span class="pre">device</span> <span class="pre">map</span></code> command.</p>
</div>
<section id="blacklisting">
<h2>Blacklisting<a class="headerlink" href="#blacklisting" title="Permalink to this heading">¶</a></h2>
<p>Sometimes a client that previously held an exclusive lock on an RBD image does
not terminate gracefully, but dies abruptly. This may be because the client
process received a <code class="docutils literal notranslate"><span class="pre">KILL</span></code> or <code class="docutils literal notranslate"><span class="pre">ABRT</span></code> signal, or because the client node
underwent a hard reboot or suffered a power failure. In cases like this, the
lock is never gracefully released. This means that any new client that comes up
and attempts to write to the image must break the previously held exclusive
lock.</p>
<p>However, a process (or kernel thread) may hang or merely lose network
connectivity to the Ceph cluster for some amount of time. In that case,
breaking the lock would be potentially catastrophic: the hung process or
connectivity issue could resolve itself and the original process might then
compete with one that started in the interim, thus accessing RBD data in an
uncoordinated and destructive manner.</p>
<p>In the event that a lock cannot be acquired in the standard graceful manner,
the overtaking process not only breaks the lock but also blocklists the
previous lock holder. This is negotiated between the new client process and the
Ceph Monitor.</p>
<ul class="simple">
<li><p>Upon receiving the blocklist request, the monitor instructs the relevant OSDs
to no longer serve requests from the old client process;</p></li>
<li><p>after the associated OSD map update is complete, the new client can break the
previously held lock;</p></li>
<li><p>after the new client has acquired the lock, it can commence writing
to the image.</p></li>
</ul>
<p>Blocklisting is thus a form of storage-level resource <a class="reference external" href="https://en.wikipedia.org/wiki/Fencing_(computing)">fencing</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In order for blocklisting to work, the client must have the <code class="docutils literal notranslate"><span class="pre">osd</span>
<span class="pre">blocklist</span></code> capability. This capability is included in the <code class="docutils literal notranslate"><span class="pre">profile</span>
<span class="pre">rbd</span></code> capability profile, which should be set generally on all Ceph
<a class="reference internal" href="../../rados/operations/user-management/#user-management"><span class="std std-ref">client identities</span></a> using RBD.</p>
</div>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph File System</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph Block Device</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../rados-rbd-cmds/">Basic Commands</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../rbd-operations/">Operations</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../rbd-snapshot/">Snapshots</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Exclusive Locking</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#blacklisting">Blacklisting</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-mirroring/">Mirroring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-live-migration/">Live-Migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-persistent-read-only-cache/">Persistent Read-only Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-persistent-write-back-cache/">Persistent Write-back Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-encryption/">Encryption</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-config-ref/">Config Settings (librbd)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-replay/">RBD Replay</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-integrations/">Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../man/">Manpages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/">APIs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../rbd-mirroring/" title="RBD Mirroring"
             >next</a> |</li>
        <li class="right" >
          <a href="../rbd-snapshot/" title="Snapshots"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph Block Device</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../rbd-operations/" >Ceph Block Device Operations</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">RBD Exclusive Locks</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>