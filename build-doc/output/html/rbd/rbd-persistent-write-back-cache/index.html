
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>RBD Persistent Write-back Cache &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Image Encryption" href="../rbd-encryption/" />
    <link rel="prev" title="RBD Persistent Read-only Cache" href="../rbd-persistent-read-only-cache/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../rbd-encryption/" title="Image Encryption"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../rbd-persistent-read-only-cache/" title="RBD Persistent Read-only Cache"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph Block Device</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../rbd-operations/" accesskey="U">Ceph Block Device Operations</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">RBD Persistent Write-back Cache</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="rbd-persistent-write-back-cache">
<h1>RBD Persistent Write-back Cache<a class="headerlink" href="#rbd-persistent-write-back-cache" title="Permalink to this heading">¶</a></h1>
<section id="persistent-write-back-cache">
<span id="index-0"></span><h2>Persistent Write-back Cache<a class="headerlink" href="#persistent-write-back-cache" title="Permalink to this heading">¶</a></h2>
<p>The persistent write-back cache provides a persistent, fault-tolerant write-back
cache for librbd-based RBD clients.</p>
<p>This cache uses a log-ordered write-back design which maintains checkpoints
internally so that writes that get flushed back to the cluster are always
crash consistent. Even if the client cache is lost entirely, the disk image is
still consistent but the data will appear to be stale.</p>
<p>This cache can be used with PMEM or SSD as a cache device.</p>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<p>The persistent write-back cache manages the cache data in a persistent device.
It looks for and creates cache files in a configured directory, and then caches
data in the file.</p>
<p>The persistent write-back cache can’t be enabled without the exclusive-lock
feature. It tries to enable the write-back cache only when the exclusive lock
is acquired.</p>
<p>The cache provides two different persistence modes. In persistent-on-write mode,
the writes are completed only when they are persisted to the cache device and
will be readable after a crash. In persistent-on-flush mode, the writes are
completed as soon as it no longer needs the caller’s data buffer to complete
the writes, but does not guarantee that writes will be readable after a crash.
The data is persisted to the cache device when a flush request is received.</p>
<p>Initially it defaults to the persistent-on-write mode and it switches to
persistent-on-flush mode after the first flush request is received.</p>
</section>
<section id="enable-persistent-write-back-cache">
<h2>Enable Persistent Write-back Cache<a class="headerlink" href="#enable-persistent-write-back-cache" title="Permalink to this heading">¶</a></h2>
<p>To enable the persistent write-back cache, the following Ceph settings
need to be enabled.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rbd</span> <span class="n">persistent</span> <span class="n">cache</span> <span class="n">mode</span> <span class="o">=</span> <span class="p">{</span><span class="n">cache</span><span class="o">-</span><span class="n">mode</span><span class="p">}</span>
<span class="n">rbd</span> <span class="n">plugins</span> <span class="o">=</span> <span class="n">pwl_cache</span>
</pre></div>
</div>
<p>Value of {cache-mode} can be <code class="docutils literal notranslate"><span class="pre">rwl</span></code>, <code class="docutils literal notranslate"><span class="pre">ssd</span></code> or <code class="docutils literal notranslate"><span class="pre">disabled</span></code>. By default the
cache is disabled.</p>
<p>Here are some cache configuration settings:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rbd_persistent_cache_path</span></code> A file folder to cache data. This folder must
have DAX enabled (see <a class="reference external" href="https://www.kernel.org/doc/Documentation/filesystems/dax.txt">DAX</a>) when using <code class="docutils literal notranslate"><span class="pre">rwl</span></code> mode to avoid performance
degradation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rbd_persistent_cache_size</span></code> The cache size per image. The minimum cache
size is 1 GB.</p></li>
</ul>
<p>The above configurations can be set per-host, per-pool, per-image etc. Eg, to
set per-host, add the overrides to the appropriate <a class="reference external" href="../../rados/configuration/ceph-conf/#configuration-sections">section</a> in the host’s
<code class="docutils literal notranslate"><span class="pre">ceph.conf</span></code> file. To set per-pool, per-image, etc, please refer to the
<code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">config</span></code> <a class="reference external" href="../../man/8/rbd#commands">commands</a>.</p>
<section id="cache-status">
<h3>Cache Status<a class="headerlink" href="#cache-status" title="Permalink to this heading">¶</a></h3>
<p>The persistent write-back cache is enabled when the exclusive lock is acquired,
and it is closed when the exclusive lock is released. To check the cache status,
users may use the command <code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">status</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rbd</span> <span class="n">status</span> <span class="p">{</span><span class="n">pool</span><span class="o">-</span><span class="n">name</span><span class="p">}</span><span class="o">/</span><span class="p">{</span><span class="n">image</span><span class="o">-</span><span class="n">name</span><span class="p">}</span>
</pre></div>
</div>
<p>The status of the cache is shown, including present, clean, cache size and the
location as well as some basic metrics.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ rbd status rbd/foo
Watchers:
        watcher=10.10.0.102:0/1061883624 client.25496 cookie=140338056493088
Persistent cache state:
        host: sceph9
        path: /mnt/nvme0/rbd-pwl.rbd.101e5824ad9a.pool
        size: 1 GiB
        mode: ssd
        stats_timestamp: Sun Apr 10 13:26:32 2022
        present: true   empty: false    clean: false
        allocated: 509 MiB
        cached: 501 MiB
        dirty: 338 MiB
        free: 515 MiB
        hits_full: 1450 / 61%
        hits_partial: 0 / 0%
        misses: 924
        hit_bytes: 192 MiB / 66%
        miss_bytes: 97 MiB
</pre></div>
</div>
</section>
<section id="flush-cache">
<h3>Flush Cache<a class="headerlink" href="#flush-cache" title="Permalink to this heading">¶</a></h3>
<p>To flush a cache file with <code class="docutils literal notranslate"><span class="pre">rbd</span></code>, specify the <code class="docutils literal notranslate"><span class="pre">persistent-cache</span> <span class="pre">flush</span></code>
command, the pool name and the image name.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rbd</span> <span class="n">persistent</span><span class="o">-</span><span class="n">cache</span> <span class="n">flush</span> <span class="p">{</span><span class="n">pool</span><span class="o">-</span><span class="n">name</span><span class="p">}</span><span class="o">/</span><span class="p">{</span><span class="n">image</span><span class="o">-</span><span class="n">name</span><span class="p">}</span>
</pre></div>
</div>
<p>If the application dies unexpectedly, this command can also be used to flush
the cache back to OSDs.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ rbd persistent-cache flush rbd/foo
</pre></div>
</div>
</section>
<section id="invalidate-cache">
<h3>Invalidate Cache<a class="headerlink" href="#invalidate-cache" title="Permalink to this heading">¶</a></h3>
<p>To invalidate (discard) a cache file with <code class="docutils literal notranslate"><span class="pre">rbd</span></code>, specify the
<code class="docutils literal notranslate"><span class="pre">persistent-cache</span> <span class="pre">invalidate</span></code> command, the pool name and the image name.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rbd</span> <span class="n">persistent</span><span class="o">-</span><span class="n">cache</span> <span class="n">invalidate</span> <span class="p">{</span><span class="n">pool</span><span class="o">-</span><span class="n">name</span><span class="p">}</span><span class="o">/</span><span class="p">{</span><span class="n">image</span><span class="o">-</span><span class="n">name</span><span class="p">}</span>
</pre></div>
</div>
<p>The command removes the cache metadata of the corresponding image, disables
the cache feature and deletes the local cache file if it exists.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ rbd persistent-cache invalidate rbd/foo
</pre></div>
</div>
</section>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph File System</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph Block Device</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../rados-rbd-cmds/">Basic Commands</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../rbd-operations/">Operations</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../rbd-snapshot/">Snapshots</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-exclusive-locks/">Exclusive Locking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-mirroring/">Mirroring</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-live-migration/">Live-Migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-persistent-read-only-cache/">Persistent Read-only Cache</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Persistent Write-back Cache</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#persistent-write-back-cache">Persistent Write-back Cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enable-persistent-write-back-cache">Enable Persistent Write-back Cache</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#cache-status">Cache Status</a></li>
<li class="toctree-l5"><a class="reference internal" href="#flush-cache">Flush Cache</a></li>
<li class="toctree-l5"><a class="reference internal" href="#invalidate-cache">Invalidate Cache</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-encryption/">Encryption</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-config-ref/">Config Settings (librbd)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rbd-replay/">RBD Replay</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rbd-integrations/">Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../man/">Manpages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/">APIs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../rbd-encryption/" title="Image Encryption"
             >next</a> |</li>
        <li class="right" >
          <a href="../rbd-persistent-read-only-cache/" title="RBD Persistent Read-only Cache"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph Block Device</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../rbd-operations/" >Ceph Block Device Operations</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">RBD Persistent Write-back Cache</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>