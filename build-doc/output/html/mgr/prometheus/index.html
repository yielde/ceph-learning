
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Prometheus Module &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Influx Module" href="../influx/" />
    <link rel="prev" title="Zabbix Module" href="../zabbix/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../influx/" title="Influx Module"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../zabbix/" title="Zabbix Module"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Ceph Manager Daemon</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Prometheus Module</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="prometheus-module">
<span id="mgr-prometheus"></span><h1>Prometheus Module<a class="headerlink" href="#prometheus-module" title="Permalink to this heading">¶</a></h1>
<p>Provides a Prometheus exporter to pass on Ceph performance counters
from the collection point in ceph-mgr.  Ceph-mgr receives MMgrReport
messages from all MgrClient processes (mons and OSDs, for instance)
with performance counter schema data and actual counter data, and keeps
a circular buffer of the last N samples.  This module creates an HTTP
endpoint (like all Prometheus exporters) and retrieves the latest sample
of every counter when polled (or “scraped” in Prometheus terminology).
The HTTP path and query parameters are ignored; all extant counters
for all reporting entities are returned in text exposition format.
(See the Prometheus <a class="reference external" href="https://prometheus.io/docs/instrumenting/exposition_formats/#text-format-details">documentation</a>.)</p>
<section id="enabling-prometheus-output">
<h2>Enabling prometheus output<a class="headerlink" href="#enabling-prometheus-output" title="Permalink to this heading">¶</a></h2>
<p>The <em>prometheus</em> module is enabled with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "$ ";
}
</style><span class="prompt1">ceph<span class="w"> </span>mgr<span class="w"> </span>module<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>prometheus</span>
</pre></div></div><section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Prometheus manager module needs to be restarted for configuration changes to be applied.</p>
</div>
<p>By default the module will accept HTTP requests on port <code class="docutils literal notranslate"><span class="pre">9283</span></code> on all IPv4
and IPv6 addresses on the host.  The port and listen address are both
configurable with <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">config</span> <span class="pre">set</span></code>, with keys
<code class="docutils literal notranslate"><span class="pre">mgr/prometheus/server_addr</span></code> and <code class="docutils literal notranslate"><span class="pre">mgr/prometheus/server_port</span></code>.  This port
is registered with Prometheus’s <a class="reference external" href="https://github.com/prometheus/prometheus/wiki/Default-port-allocations">registry</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/server_addr<span class="w"> </span><span class="m">0</span>.0.0.</span>
<span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/server_port<span class="w"> </span><span class="m">9283</span></span>
</pre></div></div><div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">scrape_interval</span></code> of this module should always be set to match
Prometheus’ scrape interval to work properly and not cause any issues.</p>
</div>
<p>The scrape interval in the module is used for caching purposes
and to determine when a cache is stale.</p>
<p>It is not recommended to use a scrape interval below 10 seconds.  It is
recommended to use 15 seconds as scrape interval, though, in some cases it
might be useful to increase the scrape interval.</p>
<p>To set a different scrape interval in the Prometheus module, set
<code class="docutils literal notranslate"><span class="pre">scrape_interval</span></code> to the desired value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/scrape_interval<span class="w"> </span><span class="m">20</span></span>
</pre></div></div><p>On large clusters (&gt;1000 OSDs), the time to fetch the metrics may become
significant.  Without the cache, the Prometheus manager module could, especially
in conjunction with multiple Prometheus instances, overload the manager and lead
to unresponsive or crashing Ceph manager instances.  Hence, the cache is enabled
by default.  This means that there is a possibility that the cache becomes
stale.  The cache is considered stale when the time to fetch the metrics from
Ceph exceeds the configured <code class="docutils literal notranslate"><span class="pre">mgr/prometheus/scrape_interval</span></code>.</p>
<p>If that is the case, <strong>a warning will be logged</strong> and the module will either</p>
<ul class="simple">
<li><p>respond with a 503 HTTP status code (service unavailable) or,</p></li>
<li><p>it will return the content of the cache, even though it might be stale.</p></li>
</ul>
<p>This behavior can be configured. By default, it will return a 503 HTTP status
code (service unavailable). You can set other options using the <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">config</span>
<span class="pre">set</span></code> commands.</p>
<p>To tell the module to respond with possibly stale data, set it to <code class="docutils literal notranslate"><span class="pre">return</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/stale_cache_strategy<span class="w"> </span><span class="k">return</span></span>
</pre></div></div><p>To tell the module to respond with “service unavailable”, set it to <code class="docutils literal notranslate"><span class="pre">fail</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/stale_cache_strategy<span class="w"> </span>fail</span>
</pre></div></div><p>If you are confident that you don’t require the cache, you can disable it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/cache<span class="w"> </span><span class="nb">false</span></span>
</pre></div></div><p>If you are using the prometheus module behind some kind of reverse proxy or
loadbalancer, you can simplify discovering the active instance by switching
to <code class="docutils literal notranslate"><span class="pre">error</span></code>-mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/standby_behaviour<span class="w"> </span>error</span>
</pre></div></div><p>If set, the prometheus module will repond with a HTTP error when requesting <code class="docutils literal notranslate"><span class="pre">/</span></code>
from the standby instance. The default error code is 500, but you can configure
the HTTP response code with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/standby_error_status_code<span class="w"> </span><span class="m">503</span></span>
</pre></div></div><p>Valid error codes are between 400-599.</p>
<p>To switch back to the default behaviour, simply set the config key to <code class="docutils literal notranslate"><span class="pre">default</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/standby_behaviour<span class="w"> </span>default</span>
</pre></div></div></section>
<section id="ceph-health-checks">
<span id="prometheus-rbd-io-statistics"></span><h3>Ceph Health Checks<a class="headerlink" href="#ceph-health-checks" title="Permalink to this heading">¶</a></h3>
<p>The mgr/prometheus module also tracks and maintains a history of Ceph health checks,
exposing them to the Prometheus server as discrete metrics. This allows Prometheus
alert rules to be configured for specific health check events.</p>
<p>The metrics take the following form;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># HELP ceph_health_detail healthcheck status by type (0=inactive, 1=active)</span>
<span class="c1"># TYPE ceph_health_detail gauge</span>
<span class="n">ceph_health_detail</span><span class="p">{</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;OSDMAP_FLAGS&quot;</span><span class="p">,</span><span class="n">severity</span><span class="o">=</span><span class="s2">&quot;HEALTH_WARN&quot;</span><span class="p">}</span> <span class="mf">0.0</span>
<span class="n">ceph_health_detail</span><span class="p">{</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;OSD_DOWN&quot;</span><span class="p">,</span><span class="n">severity</span><span class="o">=</span><span class="s2">&quot;HEALTH_WARN&quot;</span><span class="p">}</span> <span class="mf">1.0</span>
<span class="n">ceph_health_detail</span><span class="p">{</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;PG_DEGRADED&quot;</span><span class="p">,</span><span class="n">severity</span><span class="o">=</span><span class="s2">&quot;HEALTH_WARN&quot;</span><span class="p">}</span> <span class="mf">1.0</span>
</pre></div>
</div>
<p>The health check history is made available through the following commands;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">healthcheck</span> <span class="n">history</span> <span class="n">ls</span> <span class="p">[</span><span class="o">--</span><span class="nb">format</span> <span class="p">{</span><span class="n">plain</span><span class="o">|</span><span class="n">json</span><span class="o">|</span><span class="n">json</span><span class="o">-</span><span class="n">pretty</span><span class="p">}]</span>
<span class="n">healthcheck</span> <span class="n">history</span> <span class="n">clear</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ls</span></code> command provides an overview of the health checks that the cluster has
encountered, or since the last <code class="docutils literal notranslate"><span class="pre">clear</span></code> command was issued. The example below;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ceph</span><span class="p">:</span> <span class="n">root</span><span class="nd">@c8</span><span class="o">-</span><span class="n">node1</span> <span class="o">/</span><span class="p">]</span><span class="c1"># ceph healthcheck history ls</span>
<span class="n">Healthcheck</span> <span class="n">Name</span>          <span class="n">First</span> <span class="n">Seen</span> <span class="p">(</span><span class="n">UTC</span><span class="p">)</span>      <span class="n">Last</span> <span class="n">seen</span> <span class="p">(</span><span class="n">UTC</span><span class="p">)</span>       <span class="n">Count</span>  <span class="n">Active</span>
<span class="n">OSDMAP_FLAGS</span>              <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">16</span> <span class="mi">03</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">47</span>   <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">16</span> <span class="mi">22</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">40</span>       <span class="mi">2</span>    <span class="n">No</span>
<span class="n">OSD_DOWN</span>                  <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">59</span>   <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">59</span>       <span class="mi">1</span>   <span class="n">Yes</span>
<span class="n">PG_DEGRADED</span>               <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">59</span>   <span class="mi">2021</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">59</span>       <span class="mi">1</span>   <span class="n">Yes</span>
<span class="mi">3</span> <span class="n">health</span> <span class="n">check</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">listed</span>
</pre></div>
</div>
</section>
<section id="rbd-io-statistics">
<h3>RBD IO statistics<a class="headerlink" href="#rbd-io-statistics" title="Permalink to this heading">¶</a></h3>
<p>The module can optionally collect RBD per-image IO statistics by enabling
dynamic OSD performance counters. The statistics are gathered for all images
in the pools that are specified in the <code class="docutils literal notranslate"><span class="pre">mgr/prometheus/rbd_stats_pools</span></code>
configuration parameter. The parameter is a comma or space separated list
of <code class="docutils literal notranslate"><span class="pre">pool[/namespace]</span></code> entries. If the namespace is not specified the
statistics are collected for all namespaces in the pool.</p>
<p>Example to activate the RBD-enabled pools <code class="docutils literal notranslate"><span class="pre">pool1</span></code>, <code class="docutils literal notranslate"><span class="pre">pool2</span></code> and <code class="docutils literal notranslate"><span class="pre">poolN</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/rbd_stats_pools<span class="w"> </span><span class="s2">&quot;pool1,pool2,poolN&quot;</span></span>
</pre></div></div><p>The wildcard can be used to indicate all pools or namespaces:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/rbd_stats_pools<span class="w"> </span><span class="s2">&quot;*&quot;</span></span>
</pre></div></div><p>The module makes the list of all available images scanning the specified
pools and namespaces and refreshes it periodically. The period is
configurable via the <code class="docutils literal notranslate"><span class="pre">mgr/prometheus/rbd_stats_pools_refresh_interval</span></code>
parameter (in sec) and is 300 sec (5 minutes) by default. The module will
force refresh earlier if it detects statistics from a previously unknown
RBD image.</p>
<p>Example to turn up the sync interval to 10 minutes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/rbd_stats_pools_refresh_interval<span class="w"> </span><span class="m">600</span></span>
</pre></div></div></section>
<section id="ceph-daemon-performance-counters-metrics">
<h3>Ceph daemon performance counters metrics<a class="headerlink" href="#ceph-daemon-performance-counters-metrics" title="Permalink to this heading">¶</a></h3>
<p>With the introduction of <code class="docutils literal notranslate"><span class="pre">ceph-exporter</span></code> daemon, the prometheus module will no longer export Ceph daemon
perf counters as prometheus metrics by default. However, one may re-enable exporting these metrics by setting
the module option <code class="docutils literal notranslate"><span class="pre">exclude_perf_counters</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>mgr<span class="w"> </span>mgr/prometheus/exclude_perf_counters<span class="w"> </span><span class="nb">false</span></span>
</pre></div></div></section>
</section>
<section id="statistic-names-and-labels">
<h2>Statistic names and labels<a class="headerlink" href="#statistic-names-and-labels" title="Permalink to this heading">¶</a></h2>
<p>The names of the stats are exactly as Ceph names them, with
illegal characters <code class="docutils literal notranslate"><span class="pre">.</span></code>, <code class="docutils literal notranslate"><span class="pre">-</span></code> and <code class="docutils literal notranslate"><span class="pre">::</span></code> translated to <code class="docutils literal notranslate"><span class="pre">_</span></code>,
and <code class="docutils literal notranslate"><span class="pre">ceph_</span></code> prefixed to all names.</p>
<p>All <em>daemon</em> statistics have a <code class="docutils literal notranslate"><span class="pre">ceph_daemon</span></code> label such as “osd.123”
that identifies the type and ID of the daemon they come from.  Some
statistics can come from different types of daemon, so when querying
e.g. an OSD’s RocksDB stats, you would probably want to filter
on ceph_daemon starting with “osd” to avoid mixing in the monitor
rocksdb stats.</p>
<p>The <em>cluster</em> statistics (i.e. those global to the Ceph cluster)
have labels appropriate to what they report on.  For example,
metrics relating to pools have a <code class="docutils literal notranslate"><span class="pre">pool_id</span></code> label.</p>
<p>The long running averages that represent the histograms from core Ceph
are represented by a pair of <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;_sum</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;_count</span></code> metrics.
This is similar to how histograms are represented in <a class="reference external" href="https://prometheus.io/docs/concepts/metric_types/#histogram">Prometheus</a>
and they can also be treated <a class="reference external" href="https://prometheus.io/docs/practices/histograms/">similarly</a>.</p>
<section id="pool-and-osd-metadata-series">
<h3>Pool and OSD metadata series<a class="headerlink" href="#pool-and-osd-metadata-series" title="Permalink to this heading">¶</a></h3>
<p>Special series are output to enable displaying and querying on
certain metadata fields.</p>
<p>Pools have a <code class="docutils literal notranslate"><span class="pre">ceph_pool_metadata</span></code> field like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph_pool_metadata</span><span class="p">{</span><span class="n">pool_id</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cephfs_metadata_a&quot;</span><span class="p">}</span> <span class="mf">1.0</span>
</pre></div>
</div>
<p>OSDs have a <code class="docutils literal notranslate"><span class="pre">ceph_osd_metadata</span></code> field like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph_osd_metadata</span><span class="p">{</span><span class="n">cluster_addr</span><span class="o">=</span><span class="s2">&quot;172.21.9.34:6802/19096&quot;</span><span class="p">,</span><span class="n">device_class</span><span class="o">=</span><span class="s2">&quot;ssd&quot;</span><span class="p">,</span><span class="n">ceph_daemon</span><span class="o">=</span><span class="s2">&quot;osd.0&quot;</span><span class="p">,</span><span class="n">public_addr</span><span class="o">=</span><span class="s2">&quot;172.21.9.34:6801/19096&quot;</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">}</span> <span class="mf">1.0</span>
</pre></div>
</div>
</section>
<section id="correlating-drive-statistics-with-node-exporter">
<h3>Correlating drive statistics with node_exporter<a class="headerlink" href="#correlating-drive-statistics-with-node-exporter" title="Permalink to this heading">¶</a></h3>
<p>The prometheus output from Ceph is designed to be used in conjunction
with the generic host monitoring from the Prometheus node_exporter.</p>
<p>To enable correlation of Ceph OSD statistics with node_exporter’s
drive statistics, special series are output like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph_disk_occupation_human</span><span class="p">{</span><span class="n">ceph_daemon</span><span class="o">=</span><span class="s2">&quot;osd.0&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;sdd&quot;</span><span class="p">,</span> <span class="n">exported_instance</span><span class="o">=</span><span class="s2">&quot;myhost&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>To use this to get disk statistics by OSD ID, use either the <code class="docutils literal notranslate"><span class="pre">and</span></code> operator or
the <code class="docutils literal notranslate"><span class="pre">*</span></code> operator in your prometheus query. All metadata metrics (like ``
ceph_disk_occupation_human`` have the value 1 so they act neutral with <code class="docutils literal notranslate"><span class="pre">*</span></code>. Using <code class="docutils literal notranslate"><span class="pre">*</span></code>
allows to use <code class="docutils literal notranslate"><span class="pre">group_left</span></code> and <code class="docutils literal notranslate"><span class="pre">group_right</span></code> grouping modifiers, so that
the resulting metric has additional labels from one side of the query.</p>
<p>See the
<a class="reference external" href="https://prometheus.io/docs/prometheus/latest/querying/basics">prometheus documentation</a> for more information about constructing queries.</p>
<p>The goal is to run a query like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rate</span><span class="p">(</span><span class="n">node_disk_bytes_written</span><span class="p">[</span><span class="mi">30</span><span class="n">s</span><span class="p">])</span> <span class="ow">and</span>
<span class="n">on</span> <span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="n">instance</span><span class="p">)</span> <span class="n">ceph_disk_occupation_human</span><span class="p">{</span><span class="n">ceph_daemon</span><span class="o">=</span><span class="s2">&quot;osd.0&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Out of the box the above query will not return any metrics since the <code class="docutils literal notranslate"><span class="pre">instance</span></code> labels of
both metrics don’t match. The <code class="docutils literal notranslate"><span class="pre">instance</span></code> label of <code class="docutils literal notranslate"><span class="pre">ceph_disk_occupation_human</span></code>
will be the currently active MGR node.</p>
<p>The following two section outline two approaches to remedy this.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you need to group on the <cite>ceph_daemon</cite> label instead of <cite>device</cite> and
<cite>instance</cite> labels, using <cite>ceph_disk_occupation_human</cite> may not work reliably.
It is advised that you use <cite>ceph_disk_occupation</cite> instead.</p>
<p>The difference is that <cite>ceph_disk_occupation_human</cite> may group several OSDs
into the value of a single <cite>ceph_daemon</cite> label in cases where multiple OSDs
share a disk.</p>
</div>
</section>
</section>
<section id="use-label-replace">
<h2>Use label_replace<a class="headerlink" href="#use-label-replace" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">label_replace</span></code> function (cp.
<a class="reference external" href="https://prometheus.io/docs/prometheus/latest/querying/functions/#label_replace">label_replace documentation</a>)
can add a label to, or alter a label of, a metric within a query.</p>
<p>To correlate an OSD and its disks write rate, the following query can be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">label_replace</span><span class="p">(</span>
    <span class="n">rate</span><span class="p">(</span><span class="n">node_disk_bytes_written</span><span class="p">[</span><span class="mi">30</span><span class="n">s</span><span class="p">]),</span>
    <span class="s2">&quot;exported_instance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;$1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;instance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;(.*):.*&quot;</span>
<span class="p">)</span> <span class="ow">and</span> <span class="n">on</span> <span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">exported_instance</span><span class="p">)</span> <span class="n">ceph_disk_occupation_human</span><span class="p">{</span><span class="n">ceph_daemon</span><span class="o">=</span><span class="s2">&quot;osd.0&quot;</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="configuring-prometheus-server">
<h2>Configuring Prometheus server<a class="headerlink" href="#configuring-prometheus-server" title="Permalink to this heading">¶</a></h2>
<section id="honor-labels">
<h3>honor_labels<a class="headerlink" href="#honor-labels" title="Permalink to this heading">¶</a></h3>
<p>To enable Ceph to output properly-labeled data relating to any host,
use the <code class="docutils literal notranslate"><span class="pre">honor_labels</span></code> setting when adding the ceph-mgr endpoints
to your prometheus configuration.</p>
<p>This allows Ceph to export the proper <code class="docutils literal notranslate"><span class="pre">instance</span></code> label without prometheus
overwriting it. Without this setting, Prometheus applies an <code class="docutils literal notranslate"><span class="pre">instance</span></code> label
that includes the hostname and port of the endpoint that the series came from.
Because Ceph clusters have multiple manager daemons, this results in an
<code class="docutils literal notranslate"><span class="pre">instance</span></code> label that changes spuriously when the active manager daemon
changes.</p>
<p>If this is undesirable a custom <code class="docutils literal notranslate"><span class="pre">instance</span></code> label can be set in the
Prometheus target configuration: you might wish to set it to the hostname
of your first mgr daemon, or something completely arbitrary like “ceph_cluster”.</p>
</section>
<section id="node-exporter-hostname-labels">
<h3>node_exporter hostname labels<a class="headerlink" href="#node-exporter-hostname-labels" title="Permalink to this heading">¶</a></h3>
<p>Set your <code class="docutils literal notranslate"><span class="pre">instance</span></code> labels to match what appears in Ceph’s OSD metadata
in the <code class="docutils literal notranslate"><span class="pre">instance</span></code> field.  This is generally the short hostname of the node.</p>
<p>This is only necessary if you want to correlate Ceph stats with host stats,
but you may find it useful to do it in all cases in case you want to do
the correlation in the future.</p>
</section>
<section id="example-configuration">
<h3>Example configuration<a class="headerlink" href="#example-configuration" title="Permalink to this heading">¶</a></h3>
<p>This example shows a single node configuration running ceph-mgr and
node_exporter on a server called <code class="docutils literal notranslate"><span class="pre">senta04</span></code>. Note that this requires one
to add an appropriate and unique <code class="docutils literal notranslate"><span class="pre">instance</span></code> label to each <code class="docutils literal notranslate"><span class="pre">node_exporter</span></code> target.</p>
<p>This is just an example: there are other ways to configure prometheus
scrape targets and label rewrite rules.</p>
<section id="prometheus-yml">
<h4>prometheus.yml<a class="headerlink" href="#prometheus-yml" title="Permalink to this heading">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">global</span><span class="p">:</span>
  <span class="n">scrape_interval</span><span class="p">:</span>     <span class="mi">15</span><span class="n">s</span>
  <span class="n">evaluation_interval</span><span class="p">:</span> <span class="mi">15</span><span class="n">s</span>

<span class="n">scrape_configs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">job_name</span><span class="p">:</span> <span class="s1">&#39;node&#39;</span>
    <span class="n">file_sd_configs</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">files</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">node_targets</span><span class="o">.</span><span class="n">yml</span>
  <span class="o">-</span> <span class="n">job_name</span><span class="p">:</span> <span class="s1">&#39;ceph&#39;</span>
    <span class="n">honor_labels</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">file_sd_configs</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">files</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">ceph_targets</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
</section>
<section id="ceph-targets-yml">
<h4>ceph_targets.yml<a class="headerlink" href="#ceph-targets-yml" title="Permalink to this heading">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;targets&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;senta04.mydomain.com:9283&quot;</span> <span class="p">],</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="node-targets-yml">
<h4>node_targets.yml<a class="headerlink" href="#node-targets-yml" title="Permalink to this heading">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;targets&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;senta04.mydomain.com:9100&quot;</span> <span class="p">],</span>
        <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;instance&quot;</span><span class="p">:</span> <span class="s2">&quot;senta04&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this heading">¶</a></h2>
<p>Counters and gauges are exported; currently histograms and long-running
averages are not.  It’s possible that Ceph’s 2-D histograms could be
reduced to two separate 1-D histograms, and that long-running averages
could be exported as Prometheus’ Summary type.</p>
<p>Timestamps, as with many Prometheus exporters, are established by
the server’s scrape time (Prometheus expects that it is polling the
actual counter process synchronously).  It is possible to supply a
timestamp along with the stat report, but the Prometheus team strongly
advises against this.  This means that timestamps will be delayed by
an unpredictable amount; it’s not clear if this will be problematic,
but it’s worth knowing about.</p>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph File System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph Manager Daemon</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../administrator/">Installation and Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/">Writing modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../orchestrator_modules/">Writing orchestrator plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dashboard/">Dashboard module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ceph_api/">Ceph RESTful API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../alerts/">Alerts module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../diskprediction/">DiskPrediction module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../localpool/">Local pool module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../restful/">RESTful module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zabbix/">Zabbix module</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Prometheus module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#enabling-prometheus-output">Enabling prometheus output</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ceph-health-checks">Ceph Health Checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rbd-io-statistics">RBD IO statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ceph-daemon-performance-counters-metrics">Ceph daemon performance counters metrics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#statistic-names-and-labels">Statistic names and labels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pool-and-osd-metadata-series">Pool and OSD metadata series</a></li>
<li class="toctree-l4"><a class="reference internal" href="#correlating-drive-statistics-with-node-exporter">Correlating drive statistics with node_exporter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#use-label-replace">Use label_replace</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-prometheus-server">Configuring Prometheus server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#honor-labels">honor_labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="#node-exporter-hostname-labels">node_exporter hostname labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-configuration">Example configuration</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#prometheus-yml">prometheus.yml</a></li>
<li class="toctree-l5"><a class="reference internal" href="#ceph-targets-yml">ceph_targets.yml</a></li>
<li class="toctree-l5"><a class="reference internal" href="#node-targets-yml">node_targets.yml</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../influx/">Influx module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hello/">Hello module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../telegraf/">Telegraf module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../telemetry/">Telemetry module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iostat/">Iostat module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../crash/">Crash module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../insights/">Insights module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../orchestrator/">Orchestrator module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rook/">Rook module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mds_autoscaler/">MDS Autoscaler module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nfs/">NFS module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cli_api/">CLI API Commands module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../influx/" title="Influx Module"
             >next</a> |</li>
        <li class="right" >
          <a href="../zabbix/" title="Zabbix Module"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph Manager Daemon</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Prometheus Module</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>