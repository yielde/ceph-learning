
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Capabilities in CephFS &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="CephFS APIs" href="../api/" />
    <link rel="prev" title="Journaler" href="../journaler/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../api/" title="CephFS APIs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../journaler/" title="Journaler"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Ceph File System</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Capabilities in CephFS</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="capabilities-in-cephfs">
<h1>Capabilities in CephFS<a class="headerlink" href="#capabilities-in-cephfs" title="Permalink to this heading">¶</a></h1>
<p>When a client wants to operate on an inode, it will query the MDS in various
ways, which will then grant the client a set of <strong>capabilities</strong>. These
grant the client permissions to operate on the inode in various ways. One
of the major differences from other network file systems (e.g NFS or SMB) is
that the capabilities granted are quite granular, and it’s possible that
multiple clients can hold different capabilities on the same inodes.</p>
<section id="types-of-capabilities">
<h2>Types of Capabilities<a class="headerlink" href="#types-of-capabilities" title="Permalink to this heading">¶</a></h2>
<p>There are several “generic” capability bits. These denote what sort of ability
the capability grants.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">generic</span> <span class="n">cap</span> <span class="n">bits</span> <span class="o">*/</span>
<span class="c1">#define CEPH_CAP_GSHARED     1  /* client can reads (s) */</span>
<span class="c1">#define CEPH_CAP_GEXCL       2  /* client can read and update (x) */</span>
<span class="c1">#define CEPH_CAP_GCACHE      4  /* (file) client can cache reads (c) */</span>
<span class="c1">#define CEPH_CAP_GRD         8  /* (file) client can read (r) */</span>
<span class="c1">#define CEPH_CAP_GWR        16  /* (file) client can write (w) */</span>
<span class="c1">#define CEPH_CAP_GBUFFER    32  /* (file) client can buffer writes (b) */</span>
<span class="c1">#define CEPH_CAP_GWREXTEND  64  /* (file) client can extend EOF (a) */</span>
<span class="c1">#define CEPH_CAP_GLAZYIO   128  /* (file) client can perform lazy io (l) */</span>
</pre></div>
</div>
<p>These are then shifted by a particular number of bits. These denote a part of
the inode’s data or metadata on which the capability is being granted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">per</span><span class="o">-</span><span class="n">lock</span> <span class="n">shift</span> <span class="o">*/</span>
<span class="c1">#define CEPH_CAP_SAUTH      2 /* A */</span>
<span class="c1">#define CEPH_CAP_SLINK      4 /* L */</span>
<span class="c1">#define CEPH_CAP_SXATTR     6 /* X */</span>
<span class="c1">#define CEPH_CAP_SFILE      8 /* F */</span>
</pre></div>
</div>
<p>Only certain generic cap types are ever granted for some of those “shifts”,
however. In particular, only the FILE shift ever has more than the first two
bits.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">|</span> <span class="n">AUTH</span> <span class="o">|</span> <span class="n">LINK</span> <span class="o">|</span> <span class="n">XATTR</span> <span class="o">|</span> <span class="n">FILE</span>
<span class="mi">2</span>      <span class="mi">4</span>      <span class="mi">6</span>       <span class="mi">8</span>
</pre></div>
</div>
<p>From the above, we get a number of constants, that are generated by taking
each bit value and shifting to the correct bit in the word:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define CEPH_CAP_AUTH_SHARED  (CEPH_CAP_GSHARED  &lt;&lt; CEPH_CAP_SAUTH)</span>
</pre></div>
</div>
<p>These bits can then be or’ed together to make a bitmask denoting a set of
capabilities.</p>
<p>There is one exception:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define CEPH_CAP_PIN  1  /* no specific capabilities beyond the pin */</span>
</pre></div>
</div>
<p>The “pin” just pins the inode into memory, without granting any other caps.</p>
<p>Graphically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+---+---+---+---+---+---+---+---+</span>
<span class="o">|</span> <span class="n">p</span> <span class="o">|</span> <span class="n">_</span> <span class="o">|</span><span class="n">As</span>   <span class="n">x</span> <span class="o">|</span><span class="n">Ls</span>   <span class="n">x</span> <span class="o">|</span><span class="n">Xs</span>   <span class="n">x</span> <span class="o">|</span>
<span class="o">+---+---+---+---+---+---+---+---+</span>
<span class="o">|</span><span class="n">Fs</span>   <span class="n">x</span>   <span class="n">c</span>   <span class="n">r</span>   <span class="n">w</span>   <span class="n">b</span>   <span class="n">a</span>   <span class="n">l</span> <span class="o">|</span>
<span class="o">+---+---+---+---+---+---+---+---+</span>
</pre></div>
</div>
<p>The second bit is currently unused.</p>
</section>
<section id="abilities-granted-by-each-cap">
<h2>Abilities granted by each cap<a class="headerlink" href="#abilities-granted-by-each-cap" title="Permalink to this heading">¶</a></h2>
<p>While that is how capabilities are granted (and communicated), the important
bit is what they actually allow the client to do:</p>
<ul class="simple">
<li><p>PIN: this just pins the inode into memory. This is sufficient to allow the
client to get to the inode number, as well as other immutable things like
major or minor numbers in a device inode, or symlink contents.</p></li>
<li><p>AUTH: this grants the ability to get to the authentication-related metadata.
In particular, the owner, group and mode. Note that doing a full permission
check may require getting at ACLs as well, which are stored in xattrs.</p></li>
<li><p>LINK: the link count of the inode</p></li>
<li><p>XATTR: ability to access or manipulate xattrs. Note that since ACLs are
stored in xattrs, it’s also sometimes necessary to access them when checking
permissions.</p></li>
<li><p>FILE: this is the big one. These allow the client to access and manipulate
file data. It also covers certain metadata relating to file data – the
size, mtime, atime and ctime, in particular.</p></li>
</ul>
</section>
<section id="shorthand">
<h2>Shorthand<a class="headerlink" href="#shorthand" title="Permalink to this heading">¶</a></h2>
<p>Note that the client logging can also present a compact representation of the
capabilities. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pAsLsXsFs</span>
</pre></div>
</div>
<p>The ‘p’ represents the pin. Each capital letter corresponds to the shift
values, and the lowercase letters after each shift are for the actual
capabilities granted in each shift.</p>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph File System</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../#getting-started-with-cephfs">Getting Started with CephFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#administration">Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#mounting-cephfs">Mounting CephFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#cephfs-concepts">CephFS Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#troubleshooting-and-disaster-recovery">Troubleshooting and Disaster Recovery</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../#developer-guides">Developer Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../journaler/"> Journaler Configuration</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"> Client's Capabilities</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#types-of-capabilities">Types of Capabilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#abilities-granted-by-each-cap">Abilities granted by each cap</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shorthand">Shorthand</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/"> Java and Python bindings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mantle/"> Mantle</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../#additional-details">Additional Details</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../api/" title="CephFS APIs"
             >next</a> |</li>
        <li class="right" >
          <a href="../journaler/" title="Journaler"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph File System</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Capabilities in CephFS</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>