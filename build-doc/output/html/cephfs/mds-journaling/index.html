
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>MDS Journaling &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="File layouts" href="../file-layouts/" />
    <link rel="prev" title="Differences from POSIX" href="../posix/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../file-layouts/" title="File layouts"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../posix/" title="Differences from POSIX"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Ceph File System</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MDS Journaling</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="mds-journaling">
<h1>MDS Journaling<a class="headerlink" href="#mds-journaling" title="Permalink to this heading">¶</a></h1>
<section id="cephfs-metadata-pool">
<h2>CephFS Metadata Pool<a class="headerlink" href="#cephfs-metadata-pool" title="Permalink to this heading">¶</a></h2>
<p>CephFS uses a separate (metadata) pool for managing file metadata (inodes and
dentries) in a Ceph File System. The metadata pool has all the information about
files in a Ceph File System including the File System hierarchy. Additionally,
CephFS maintains meta information related to other entities in a file system
such as file system journals, open file table, session map, etc.</p>
<p>This document describes how Ceph Metadata Servers use and rely on journaling.</p>
</section>
<section id="cephfs-mds-journaling">
<h2>CephFS MDS Journaling<a class="headerlink" href="#cephfs-mds-journaling" title="Permalink to this heading">¶</a></h2>
<p>CephFS metadata servers stream a journal of metadata events into RADOS in the metadata
pool prior to executing a file system operation. Active MDS daemon(s) manage metadata
for files and directories in CephFS.</p>
<p>CephFS uses journaling for couple of reasons:</p>
<ol class="arabic simple">
<li><p>Consistency: On an MDS failover, the journal events can be replayed to reach a
consistent file system state. Also, metadata operations that require multiple
updates to the backing store need to be journaled for crash consistency (along
with other consistency mechanisms such as locking, etc..).</p></li>
<li><p>Performance: Journal updates are (mostly) sequential, hence updates to journals
are fast. Furthermore, updates can be batched into single write, thereby saving
disk seek time involved in updates to different parts of a file. Having a large
journal also helps a standby MDS to warm its cache which helps indirectly during
MDS failover.</p></li>
</ol>
<p>Each active metadata server maintains its own journal in the metadata pool. Journals
are striped over multiple objects. Journal entries which are not required (deemed as
old) are trimmed by the metadata server.</p>
</section>
<section id="journal-events">
<h2>Journal Events<a class="headerlink" href="#journal-events" title="Permalink to this heading">¶</a></h2>
<p>Apart from journaling file system metadata updates, CephFS journals various other events
such as client session info and directory import/export state to name a few. These events
are used by the metadata sever to reestablish correct state as required, e.g., Ceph MDS
tries to reconnect clients on restart when journal events get replayed and a specific
event type in the journal specifies that a client entity type has a session with the MDS
before it was restarted.</p>
<p>To examine the list of such events recorded in the journal, CephFS provides a command
line utility <cite>cephfs-journal-tool</cite> which can be used as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cephfs</span><span class="o">-</span><span class="n">journal</span><span class="o">-</span><span class="n">tool</span> <span class="o">--</span><span class="n">rank</span><span class="o">=&lt;</span><span class="n">fs</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">rank</span><span class="o">&gt;</span> <span class="n">event</span> <span class="n">get</span> <span class="nb">list</span>
</pre></div>
</div>
<p><cite>cephfs-journal-tool</cite> is also used to discover and repair a damaged Ceph File System.
(See <a class="reference internal" href="../cephfs-journal-tool/"><span class="doc">cephfs-journal-tool</span></a> for more details)</p>
</section>
<section id="journal-event-types">
<h2>Journal Event Types<a class="headerlink" href="#journal-event-types" title="Permalink to this heading">¶</a></h2>
<p>Following are various event types that are journaled by the MDS.</p>
<ol class="arabic simple">
<li><p><cite>EVENT_COMMITTED</cite>: Mark a request (id) as committed.</p></li>
<li><p><cite>EVENT_EXPORT</cite>: Maps directories to an MDS rank.</p></li>
<li><p><cite>EVENT_FRAGMENT</cite>: Tracks various stages of directory fragmentation (split/merge).</p></li>
<li><p><cite>EVENT_IMPORTSTART</cite>: Logged when an MDS rank starts importing directory fragments.</p></li>
<li><p><cite>EVENT_IMPORTFINISH</cite>: Logged when an MDS rank finishes importing directory fragments.</p></li>
<li><p><cite>EVENT_NOOP</cite>: No operation event type for skipping over a journal region.</p></li>
<li><p><cite>EVENT_OPEN</cite>: Tracks which inodes have open file handles.</p></li>
<li><p><cite>EVENT_RESETJOURNAL</cite>: Used to mark a journal as <cite>reset</cite> post truncation.</p></li>
<li><p><cite>EVENT_SESSION</cite>: Tracks open client sessions.</p></li>
<li><p><cite>EVENT_SLAVEUPDATE</cite>: Logs various stages of an operation that has been forwarded to a (slave) mds.</p></li>
<li><p><cite>EVENT_SUBTREEMAP</cite>: Map of directory inodes to directory contents (subtree partition).</p></li>
<li><p><cite>EVENT_TABLECLIENT</cite>: Log transition states of MDSs view of client tables (snap/anchor).</p></li>
<li><p><cite>EVENT_TABLESERVER</cite>: Log transition states of MDSs view of server tables (snap/anchor).</p></li>
<li><p><cite>EVENT_UPDATE</cite>: Log file operations on an inode.</p></li>
</ol>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph File System</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../#getting-started-with-cephfs">Getting Started with CephFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#administration">Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#mounting-cephfs">Mounting CephFS</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../#cephfs-concepts">CephFS Concepts</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../mds-states/"> MDS States</a></li>
<li class="toctree-l3"><a class="reference internal" href="../posix/"> POSIX compatibility</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"> MDS Journaling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cephfs-metadata-pool">CephFS Metadata Pool</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cephfs-mds-journaling">CephFS MDS Journaling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#journal-events">Journal Events</a></li>
<li class="toctree-l4"><a class="reference internal" href="#journal-event-types">Journal Event Types</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../file-layouts/"> File layouts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mdcache/"> Distributed Metadata Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dynamic-metadata-management/"> Dynamic Metadata Management in CephFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cephfs-io-path/"> CephFS IO Path</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lazyio/"> LazyIO</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dirfrags/"> Directory fragmentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../multimds/"> Multiple active MDS daemons</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../#troubleshooting-and-disaster-recovery">Troubleshooting and Disaster Recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#developer-guides">Developer Guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#additional-details">Additional Details</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../file-layouts/" title="File layouts"
             >next</a> |</li>
        <li class="right" >
          <a href="../posix/" title="Differences from POSIX"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph File System</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MDS Journaling</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>