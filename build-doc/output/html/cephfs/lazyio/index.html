
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>LazyIO &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Configuring Directory fragmentation" href="../dirfrags/" />
    <link rel="prev" title="Ceph File System IO Path" href="../cephfs-io-path/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../dirfrags/" title="Configuring Directory fragmentation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../cephfs-io-path/" title="Ceph File System IO Path"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Ceph File System</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">LazyIO</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="lazyio">
<h1>LazyIO<a class="headerlink" href="#lazyio" title="Permalink to this heading">¶</a></h1>
<p>LazyIO relaxes POSIX semantics. Buffered reads/writes are allowed even when a
file is opened by multiple applications on multiple clients. Applications are
responsible for managing cache coherency themselves.</p>
<p>Libcephfs supports LazyIO since nautilus release.</p>
<section id="enable-lazyio">
<h2>Enable LazyIO<a class="headerlink" href="#enable-lazyio" title="Permalink to this heading">¶</a></h2>
<p>LazyIO can be enabled by following ways.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">client_force_lazyio</span></code> option enables LAZY_IO globally for libcephfs and
ceph-fuse mount.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ceph_lazyio(...)</span></code> and <code class="docutils literal notranslate"><span class="pre">ceph_ll_lazyio(...)</span></code> enable LAZY_IO for file handle
in libcephfs.</p></li>
</ul>
</section>
<section id="using-lazyio">
<h2>Using LazyIO<a class="headerlink" href="#using-lazyio" title="Permalink to this heading">¶</a></h2>
<p>LazyIO includes two methods <code class="docutils literal notranslate"><span class="pre">lazyio_propagate()</span></code> and <code class="docutils literal notranslate"><span class="pre">lazyio_synchronize()</span></code>.
With LazyIO enabled, writes may not be visble to other clients until
<code class="docutils literal notranslate"><span class="pre">lazyio_propagate()</span></code> is called. Reads may come from local cache (irrespective of
changes to the file by other clients) until <code class="docutils literal notranslate"><span class="pre">lazyio_synchronize()</span></code> is called.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lazyio_propagate(int</span> <span class="pre">fd,</span> <span class="pre">loff_t</span> <span class="pre">offset,</span> <span class="pre">size_t</span> <span class="pre">count)</span></code> - Ensures that any
buffered writes of the client, in the specific region (offset to offset+count),
has been propagated to the shared file. If offset and count are both 0, the
operation is performed on the entire file. Currently only this is supported.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lazyio_synchronize(int</span> <span class="pre">fd,</span> <span class="pre">loff_t</span> <span class="pre">offset,</span> <span class="pre">size_t</span> <span class="pre">count)</span></code> - Ensures that the
client is, in a subsequent read call, able to read the updated file with all
the propagated writes of the other clients. In CephFS this is facilitated by
invalidating the file caches pertaining to the inode and hence forces the
client to refetch/recache the data from the updated file. Also if the write cache
of the calling client is dirty (not propagated), lazyio_synchronize() flushes it as well.</p></li>
</ul>
<p>An example usage (utilizing libcephfs) is given below. This is a sample I/O loop for a
particular client/file descriptor in a parallel application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">Client</span> <span class="n">a</span> <span class="p">(</span><span class="n">ca</span><span class="p">)</span> <span class="n">opens</span> <span class="n">the</span> <span class="n">shared</span> <span class="n">file</span> <span class="n">file</span><span class="o">.</span><span class="n">txt</span> <span class="o">*/</span>
<span class="nb">int</span> <span class="n">fda</span> <span class="o">=</span> <span class="n">ceph_open</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="s2">&quot;shared_file.txt&quot;</span><span class="p">,</span> <span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span> <span class="mi">0644</span><span class="p">);</span>

<span class="o">/*</span> <span class="n">Enable</span> <span class="n">LazyIO</span> <span class="k">for</span> <span class="n">fda</span> <span class="o">*/</span>
<span class="n">ceph_lazyio</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">fda</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_iters</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">char</span> <span class="n">out_buf</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">&quot;fooooooooo&quot;</span><span class="p">;</span>

    <span class="n">ceph_write</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">fda</span><span class="p">,</span> <span class="n">out_buf</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">out_buf</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
    <span class="o">/*</span> <span class="n">Propagate</span> <span class="n">the</span> <span class="n">writes</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">fda</span> <span class="n">to</span> <span class="n">the</span> <span class="n">backing</span> <span class="n">storage</span><span class="o">*/</span>
    <span class="n">ceph_propagate</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">fda</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="o">/*</span> <span class="n">The</span> <span class="n">barrier</span> <span class="n">makes</span> <span class="n">sure</span> <span class="n">changes</span> <span class="n">associated</span> <span class="k">with</span> <span class="nb">all</span> <span class="n">file</span> <span class="n">descriptors</span>
    <span class="n">are</span> <span class="n">propagated</span> <span class="n">so</span> <span class="n">that</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">certainty</span> <span class="n">that</span> <span class="n">the</span> <span class="n">backing</span> <span class="n">file</span>
    <span class="ow">is</span> <span class="n">upto</span> <span class="n">date</span> <span class="o">*/</span>
    <span class="n">application_specific_barrier</span><span class="p">();</span>

    <span class="n">char</span> <span class="n">in_buf</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
    <span class="o">/*</span> <span class="n">Calling</span> <span class="n">ceph_lazyio_synchronize</span> <span class="n">here</span> <span class="n">will</span> <span class="n">ascertain</span> <span class="n">that</span> <span class="n">ca</span> <span class="n">will</span>
    <span class="n">read</span> <span class="n">the</span> <span class="n">updated</span> <span class="n">file</span> <span class="k">with</span> <span class="n">the</span> <span class="n">propagated</span> <span class="n">changes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">read</span>
    <span class="n">stale</span> <span class="n">cached</span> <span class="n">data</span> <span class="o">*/</span>
    <span class="n">ceph_lazyio_synchronize</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">fda</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">ceph_read</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">fda</span><span class="p">,</span> <span class="n">in_buf</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">in_buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

    <span class="o">/*</span> <span class="n">A</span> <span class="n">barrier</span> <span class="ow">is</span> <span class="n">required</span> <span class="n">here</span> <span class="n">before</span> <span class="n">returning</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">write</span>
    <span class="n">phase</span> <span class="n">so</span> <span class="k">as</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">overwriting</span> <span class="n">the</span> <span class="n">portion</span> <span class="n">of</span> <span class="n">the</span> <span class="n">shared</span> <span class="n">file</span> <span class="n">still</span>
    <span class="n">being</span> <span class="n">read</span> <span class="n">by</span> <span class="n">another</span> <span class="n">file</span> <span class="n">descriptor</span> <span class="o">*/</span>
    <span class="n">application_specific_barrier</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph File System</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../#getting-started-with-cephfs">Getting Started with CephFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#administration">Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#mounting-cephfs">Mounting CephFS</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../#cephfs-concepts">CephFS Concepts</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../mds-states/"> MDS States</a></li>
<li class="toctree-l3"><a class="reference internal" href="../posix/"> POSIX compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mds-journaling/"> MDS Journaling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../file-layouts/"> File layouts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mdcache/"> Distributed Metadata Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dynamic-metadata-management/"> Dynamic Metadata Management in CephFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cephfs-io-path/"> CephFS IO Path</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"> LazyIO</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#enable-lazyio">Enable LazyIO</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-lazyio">Using LazyIO</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dirfrags/"> Directory fragmentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../multimds/"> Multiple active MDS daemons</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../#troubleshooting-and-disaster-recovery">Troubleshooting and Disaster Recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#developer-guides">Developer Guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#additional-details">Additional Details</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../dirfrags/" title="Configuring Directory fragmentation"
             >next</a> |</li>
        <li class="right" >
          <a href="../cephfs-io-path/" title="Ceph File System IO Path"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph File System</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">LazyIO</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>