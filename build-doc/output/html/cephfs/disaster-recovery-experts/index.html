
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Advanced: Metadata repair tools &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Troubleshooting" href="../troubleshooting/" />
    <link rel="prev" title="Handling a full Ceph file system" href="../full/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../troubleshooting/" title="Troubleshooting"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../full/" title="Handling a full Ceph file system"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Ceph File System</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Advanced: Metadata repair tools</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="advanced-metadata-repair-tools">
<span id="disaster-recovery-experts"></span><h1>Advanced: Metadata repair tools<a class="headerlink" href="#advanced-metadata-repair-tools" title="Permalink to this heading">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you do not have expert knowledge of CephFS internals, you will
need to seek assistance before using any of these tools.</p>
<p>The tools mentioned here can easily cause damage as well as fixing it.</p>
<p>It is essential to understand exactly what has gone wrong with your
file system before attempting to repair it.</p>
<p>If you do not have access to professional support for your cluster,
consult the ceph-users mailing list or the #ceph IRC channel.</p>
</div>
<section id="journal-export">
<h2>Journal export<a class="headerlink" href="#journal-export" title="Permalink to this heading">¶</a></h2>
<p>Before attempting dangerous operations, make a copy of the journal like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cephfs</span><span class="o">-</span><span class="n">journal</span><span class="o">-</span><span class="n">tool</span> <span class="n">journal</span> <span class="n">export</span> <span class="n">backup</span><span class="o">.</span><span class="n">bin</span>
</pre></div>
</div>
<p>Note that this command may not always work if the journal is badly corrupted,
in which case a RADOS-level copy should be made (<a class="reference external" href="http://tracker.ceph.com/issues/9902">http://tracker.ceph.com/issues/9902</a>).</p>
</section>
<section id="dentry-recovery-from-journal">
<h2>Dentry recovery from journal<a class="headerlink" href="#dentry-recovery-from-journal" title="Permalink to this heading">¶</a></h2>
<p>If a journal is damaged or for any reason an MDS is incapable of replaying it,
attempt to recover what file metadata we can like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cephfs</span><span class="o">-</span><span class="n">journal</span><span class="o">-</span><span class="n">tool</span> <span class="n">event</span> <span class="n">recover_dentries</span> <span class="n">summary</span>
</pre></div>
</div>
<p>This command by default acts on MDS rank 0, pass –rank=&lt;n&gt; to operate on other ranks.</p>
<p>This command will write any inodes/dentries recoverable from the journal
into the backing store, if these inodes/dentries are higher-versioned
than the previous contents of the backing store.  If any regions of the journal
are missing/damaged, they will be skipped.</p>
<p>Note that in addition to writing out dentries and inodes, this command will update
the InoTables of each ‘in’ MDS rank, to indicate that any written inodes’ numbers
are now in use.  In simple cases, this will result in an entirely valid backing
store state.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The resulting state of the backing store is not guaranteed to be self-consistent,
and an online MDS scrub will be required afterwards.  The journal contents
will not be modified by this command, you should truncate the journal
separately after recovering what you can.</p>
</div>
</section>
<section id="journal-truncation">
<h2>Journal truncation<a class="headerlink" href="#journal-truncation" title="Permalink to this heading">¶</a></h2>
<p>If the journal is corrupt or MDSs cannot replay it for any reason, you can
truncate it like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cephfs</span><span class="o">-</span><span class="n">journal</span><span class="o">-</span><span class="n">tool</span> <span class="p">[</span><span class="o">--</span><span class="n">rank</span><span class="o">=</span><span class="n">N</span><span class="p">]</span> <span class="n">journal</span> <span class="n">reset</span>
</pre></div>
</div>
<p>Specify the MDS rank using the <code class="docutils literal notranslate"><span class="pre">--rank</span></code> option when the file system has/had
multiple active MDS.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Resetting the journal <em>will</em> lose metadata unless you have extracted
it by other means such as <code class="docutils literal notranslate"><span class="pre">recover_dentries</span></code>.  It is likely to leave
some orphaned objects in the data pool.  It may result in re-allocation
of already-written inodes, such that permissions rules could be violated.</p>
</div>
</section>
<section id="mds-table-wipes">
<h2>MDS table wipes<a class="headerlink" href="#mds-table-wipes" title="Permalink to this heading">¶</a></h2>
<p>After the journal has been reset, it may no longer be consistent with respect
to the contents of the MDS tables (InoTable, SessionMap, SnapServer).</p>
<p>To reset the SessionMap (erase all sessions), use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cephfs</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">tool</span> <span class="nb">all</span> <span class="n">reset</span> <span class="n">session</span>
</pre></div>
</div>
<p>This command acts on the tables of all ‘in’ MDS ranks.  Replace ‘all’ with an MDS
rank to operate on that rank only.</p>
<p>The session table is the table most likely to need resetting, but if you know you
also need to reset the other tables then replace ‘session’ with ‘snap’ or ‘inode’.</p>
</section>
<section id="mds-map-reset">
<h2>MDS map reset<a class="headerlink" href="#mds-map-reset" title="Permalink to this heading">¶</a></h2>
<p>Once the in-RADOS state of the file system (i.e. contents of the metadata pool)
is somewhat recovered, it may be necessary to update the MDS map to reflect
the contents of the metadata pool.  Use the following command to reset the MDS
map to a single MDS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">fs</span> <span class="n">reset</span> <span class="o">&lt;</span><span class="n">fs</span> <span class="n">name</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">yes</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="n">really</span><span class="o">-</span><span class="n">mean</span><span class="o">-</span><span class="n">it</span>
</pre></div>
</div>
<p>Once this is run, any in-RADOS state for MDS ranks other than 0 will be ignored:
as a result it is possible for this to result in data loss.</p>
<p>One might wonder what the difference is between ‘fs reset’ and ‘fs remove; fs new’.  The
key distinction is that doing a remove/new will leave rank 0 in ‘creating’ state, such
that it would overwrite any existing root inode on disk and orphan any existing files.  In
contrast, the ‘reset’ command will leave rank 0 in ‘active’ state such that the next MDS
daemon to claim the rank will go ahead and use the existing in-RADOS metadata.</p>
</section>
<section id="recovery-from-missing-metadata-objects">
<h2>Recovery from missing metadata objects<a class="headerlink" href="#recovery-from-missing-metadata-objects" title="Permalink to this heading">¶</a></h2>
<p>Depending on what objects are missing or corrupt, you may need to
run various commands to regenerate default versions of the
objects.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Session table</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">tool</span> <span class="mi">0</span> <span class="n">reset</span> <span class="n">session</span>
<span class="c1"># SnapServer</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">tool</span> <span class="mi">0</span> <span class="n">reset</span> <span class="n">snap</span>
<span class="c1"># InoTable</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">tool</span> <span class="mi">0</span> <span class="n">reset</span> <span class="n">inode</span>
<span class="c1"># Journal</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">journal</span><span class="o">-</span><span class="n">tool</span> <span class="o">--</span><span class="n">rank</span><span class="o">=</span><span class="mi">0</span> <span class="n">journal</span> <span class="n">reset</span>
<span class="c1"># Root inodes (&quot;/&quot; and MDS directory)</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">init</span>
</pre></div>
</div>
<p>Finally, you can regenerate metadata objects for missing files
and directories based on the contents of a data pool.  This is
a three-phase process.  First, scanning <em>all</em> objects to calculate
size and mtime metadata for inodes.  Second, scanning the first
object from every file to collect this metadata and inject it into
the metadata pool. Third, checking inode linkages and fixing found
errors.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_extents</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">data</span> <span class="n">pool</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">extra</span> <span class="n">data</span> <span class="n">pool</span><span class="o">&gt;</span> <span class="o">...</span><span class="p">]]</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_inodes</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">data</span> <span class="n">pool</span><span class="o">&gt;</span><span class="p">]</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_links</span>
</pre></div>
</div>
<p>‘scan_extents’ and ‘scan_inodes’ commands may take a <em>very long</em> time
if there are many files or very large files in the data pool.</p>
<p>To accelerate the process, run multiple instances of the tool.</p>
<p>Decide on a number of workers, and pass each worker a number within
the range 0-(worker_m - 1).</p>
<p>The example below shows how to run 4 workers simultaneously:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Worker 0</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_extents</span> <span class="o">--</span><span class="n">worker_n</span> <span class="mi">0</span> <span class="o">--</span><span class="n">worker_m</span> <span class="mi">4</span>
<span class="c1"># Worker 1</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_extents</span> <span class="o">--</span><span class="n">worker_n</span> <span class="mi">1</span> <span class="o">--</span><span class="n">worker_m</span> <span class="mi">4</span>
<span class="c1"># Worker 2</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_extents</span> <span class="o">--</span><span class="n">worker_n</span> <span class="mi">2</span> <span class="o">--</span><span class="n">worker_m</span> <span class="mi">4</span>
<span class="c1"># Worker 3</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_extents</span> <span class="o">--</span><span class="n">worker_n</span> <span class="mi">3</span> <span class="o">--</span><span class="n">worker_m</span> <span class="mi">4</span>

<span class="c1"># Worker 0</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_inodes</span> <span class="o">--</span><span class="n">worker_n</span> <span class="mi">0</span> <span class="o">--</span><span class="n">worker_m</span> <span class="mi">4</span>
<span class="c1"># Worker 1</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_inodes</span> <span class="o">--</span><span class="n">worker_n</span> <span class="mi">1</span> <span class="o">--</span><span class="n">worker_m</span> <span class="mi">4</span>
<span class="c1"># Worker 2</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_inodes</span> <span class="o">--</span><span class="n">worker_n</span> <span class="mi">2</span> <span class="o">--</span><span class="n">worker_m</span> <span class="mi">4</span>
<span class="c1"># Worker 3</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_inodes</span> <span class="o">--</span><span class="n">worker_n</span> <span class="mi">3</span> <span class="o">--</span><span class="n">worker_m</span> <span class="mi">4</span>
</pre></div>
</div>
<p>It is <strong>important</strong> to ensure that all workers have completed the
scan_extents phase before any workers enter the scan_inodes phase.</p>
<p>After completing the metadata recovery, you may want to run cleanup
operation to delete ancillary data geneated during recovery.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">cleanup</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">data</span> <span class="n">pool</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>Note, the data pool parameters for ‘scan_extents’, ‘scan_inodes’ and
‘cleanup’ commands are optional, and usually the tool will be able to
detect the pools automatically. Still you may override this. The
‘scan_extents’ command needs all data pools to be specified, while
‘scan_inodes’ and ‘cleanup’ commands need only the main data pool.</p>
</section>
<section id="using-an-alternate-metadata-pool-for-recovery">
<h2>Using an alternate metadata pool for recovery<a class="headerlink" href="#using-an-alternate-metadata-pool-for-recovery" title="Permalink to this heading">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There has not been extensive testing of this procedure. It should be
undertaken with great care.</p>
</div>
<p>If an existing file system is damaged and inoperative, it is possible to create
a fresh metadata pool and attempt to reconstruct the file system metadata into
this new pool, leaving the old metadata in place. This could be used to make a
safer attempt at recovery since the existing metadata pool would not be
modified.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>During this process, multiple metadata pools will contain data referring to
the same data pool. Extreme caution must be exercised to avoid changing the
data pool contents while this is the case. Once recovery is complete, the
damaged metadata pool should be archived or deleted.</p>
</div>
<p>To begin, the existing file system should be taken down, if not done already,
to prevent further modification of the data pool. Unmount all clients and then
mark the file system failed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">fs</span> <span class="n">fail</span> <span class="o">&lt;</span><span class="n">fs_name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Next, create a recovery file system in which we will populate a new metadata pool
backed by the original data pool.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">cephfs_recovery_meta</span>
<span class="n">ceph</span> <span class="n">fs</span> <span class="n">new</span> <span class="n">cephfs_recovery</span> <span class="n">recovery</span> <span class="o">&lt;</span><span class="n">data_pool</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">recover</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">dangerous</span><span class="o">-</span><span class="n">metadata</span><span class="o">-</span><span class="n">overlay</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--recover</span></code> flag prevents any MDS from joining the new file system.</p>
</div>
<p>Next, we will create the intial metadata for the fs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cephfs</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">tool</span> <span class="n">cephfs_recovery</span><span class="p">:</span><span class="mi">0</span> <span class="n">reset</span> <span class="n">session</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">tool</span> <span class="n">cephfs_recovery</span><span class="p">:</span><span class="mi">0</span> <span class="n">reset</span> <span class="n">snap</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">table</span><span class="o">-</span><span class="n">tool</span> <span class="n">cephfs_recovery</span><span class="p">:</span><span class="mi">0</span> <span class="n">reset</span> <span class="n">inode</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">journal</span><span class="o">-</span><span class="n">tool</span> <span class="o">--</span><span class="n">rank</span> <span class="n">cephfs_recovery</span><span class="p">:</span><span class="mi">0</span> <span class="n">journal</span> <span class="n">reset</span> <span class="o">--</span><span class="n">force</span>
</pre></div>
</div>
<p>Now perform the recovery of the metadata pool from the data pool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">init</span> <span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">init</span> <span class="o">--</span><span class="n">filesystem</span> <span class="n">cephfs_recovery</span> <span class="o">--</span><span class="n">alternate</span><span class="o">-</span><span class="n">pool</span> <span class="n">cephfs_recovery_meta</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_extents</span> <span class="o">--</span><span class="n">alternate</span><span class="o">-</span><span class="n">pool</span> <span class="n">cephfs_recovery_meta</span> <span class="o">--</span><span class="n">filesystem</span> <span class="o">&lt;</span><span class="n">fs_name</span><span class="o">&gt;</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_inodes</span> <span class="o">--</span><span class="n">alternate</span><span class="o">-</span><span class="n">pool</span> <span class="n">cephfs_recovery_meta</span> <span class="o">--</span><span class="n">filesystem</span> <span class="o">&lt;</span><span class="n">fs_name</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">force</span><span class="o">-</span><span class="n">corrupt</span>
<span class="n">cephfs</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">scan</span> <span class="n">scan_links</span> <span class="o">--</span><span class="n">filesystem</span> <span class="n">cephfs_recovery</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each scan procedure above goes through the entire data pool. This may take a
significant amount of time. See the previous section on how to distribute
this task among workers.</p>
</div>
<p>If the damaged file system contains dirty journal data, it may be recovered next
with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cephfs</span><span class="o">-</span><span class="n">journal</span><span class="o">-</span><span class="n">tool</span> <span class="o">--</span><span class="n">rank</span><span class="o">=&lt;</span><span class="n">fs_name</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">0</span> <span class="n">event</span> <span class="n">recover_dentries</span> <span class="nb">list</span> <span class="o">--</span><span class="n">alternate</span><span class="o">-</span><span class="n">pool</span> <span class="n">cephfs_recovery_meta</span>
</pre></div>
</div>
<p>After recovery, some recovered directories will have incorrect statistics.
Ensure the parameters <code class="docutils literal notranslate"><span class="pre">mds_verify_scatter</span></code> and <code class="docutils literal notranslate"><span class="pre">mds_debug_scatterstat</span></code> are
set to false (the default) to prevent the MDS from checking the statistics:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">config</span> <span class="n">rm</span> <span class="n">mds</span> <span class="n">mds_verify_scatter</span>
<span class="n">ceph</span> <span class="n">config</span> <span class="n">rm</span> <span class="n">mds</span> <span class="n">mds_debug_scatterstat</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Also verify the config has not been set globally or with a local ceph.conf file.</p>
</div>
<p>Now, allow an MDS to join the recovery file system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">fs</span> <span class="nb">set</span> <span class="n">cephfs_recovery</span> <span class="n">joinable</span> <span class="n">true</span>
</pre></div>
</div>
<p>Finally, run a forward <a class="reference internal" href="../scrub/"><span class="doc">scrub</span></a> to repair recursive statistics.
Ensure you have an MDS running and issue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">tell</span> <span class="n">mds</span><span class="o">.</span><span class="n">recovery_fs</span><span class="p">:</span><span class="mi">0</span> <span class="n">scrub</span> <span class="n">start</span> <span class="o">/</span> <span class="n">recursive</span><span class="p">,</span><span class="n">repair</span><span class="p">,</span><span class="n">force</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Symbolic links are recovered as empty regular files. <a class="reference external" href="https://tracker.ceph.com/issues/46166">Symbolic link recovery</a> is scheduled to be supported in
Pacific.</p>
</div>
<p>It is recommended to migrate any data from the recovery file system as soon as
possible. Do not restore the old file system while the recovery file system is
operational.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the data pool is also corrupt, some files may not be restored because
backtrace information is lost. If any data objects are missing (due to
issues like lost Placement Groups on the data pool), the recovered files
will contain holes in place of the missing data.</p>
</div>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph File System</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../#getting-started-with-cephfs">Getting Started with CephFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#administration">Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#mounting-cephfs">Mounting CephFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#cephfs-concepts">CephFS Concepts</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../#troubleshooting-and-disaster-recovery">Troubleshooting and Disaster Recovery</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../eviction/"> Client eviction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../scrub/"> Scrubbing the File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../full/"> Handling full file systems</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#"> Metadata repair</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#journal-export">Journal export</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dentry-recovery-from-journal">Dentry recovery from journal</a></li>
<li class="toctree-l4"><a class="reference internal" href="#journal-truncation">Journal truncation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mds-table-wipes">MDS table wipes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mds-map-reset">MDS map reset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#recovery-from-missing-metadata-objects">Recovery from missing metadata objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-an-alternate-metadata-pool-for-recovery">Using an alternate metadata pool for recovery</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting/"> Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../disaster-recovery/"> Disaster recovery</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cephfs-journal-tool/"> cephfs-journal-tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../recover-fs-after-mon-store-loss/"> Recovering file system after monitor store loss</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../#developer-guides">Developer Guides</a></li>
<li class="toctree-l2"><a class="reference internal" href="../#additional-details">Additional Details</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../troubleshooting/" title="Troubleshooting"
             >next</a> |</li>
        <li class="right" >
          <a href="../full/" title="Handling a full Ceph file system"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph File System</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Advanced: Metadata repair tools</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>