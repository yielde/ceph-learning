
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Troubleshooting PGs &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
    <link rel="next" title="Logging and Debugging" href="../log-and-debug/" />
    <link rel="prev" title="Troubleshooting OSDs" href="../troubleshooting-osd/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../log-and-debug/" title="Logging and Debugging"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../troubleshooting-osd/" title="Troubleshooting OSDs"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../" >Ceph Storage Cluster</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../operations/" accesskey="U">Cluster Operations</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Troubleshooting PGs</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="troubleshooting-pgs">
<h1>Troubleshooting PGs<a class="headerlink" href="#troubleshooting-pgs" title="Permalink to this heading">¶</a></h1>
<section id="placement-groups-never-get-clean">
<h2>Placement Groups Never Get Clean<a class="headerlink" href="#placement-groups-never-get-clean" title="Permalink to this heading">¶</a></h2>
<p>When you create a cluster and your cluster remains in <code class="docutils literal notranslate"><span class="pre">active</span></code>,
<code class="docutils literal notranslate"><span class="pre">active+remapped</span></code> or <code class="docutils literal notranslate"><span class="pre">active+degraded</span></code> status and never achieves an
<code class="docutils literal notranslate"><span class="pre">active+clean</span></code> status, you likely have a problem with your configuration.</p>
<p>You may need to review settings in the <a class="reference external" href="../../configuration/pool-pg-config-ref">Pool, PG and CRUSH Config Reference</a>
and make appropriate adjustments.</p>
<p>As a general rule, you should run your cluster with more than one OSD and a
pool size greater than 1 object replica.</p>
<section id="one-node-cluster">
<span id="id1"></span><h3>One Node Cluster<a class="headerlink" href="#one-node-cluster" title="Permalink to this heading">¶</a></h3>
<p>Ceph no longer provides documentation for operating on a single node, because
you would never deploy a system designed for distributed computing on a single
node. Additionally, mounting client kernel modules on a single node containing a
Ceph  daemon may cause a deadlock due to issues with the Linux kernel itself
(unless you use VMs for the clients). You can experiment with Ceph in a 1-node
configuration, in spite of the limitations as described herein.</p>
<p>If you are trying to create a cluster on a single node, you must change the
default of the <code class="docutils literal notranslate"><span class="pre">osd</span> <span class="pre">crush</span> <span class="pre">chooseleaf</span> <span class="pre">type</span></code> setting from <code class="docutils literal notranslate"><span class="pre">1</span></code> (meaning
<code class="docutils literal notranslate"><span class="pre">host</span></code> or <code class="docutils literal notranslate"><span class="pre">node</span></code>) to <code class="docutils literal notranslate"><span class="pre">0</span></code> (meaning <code class="docutils literal notranslate"><span class="pre">osd</span></code>) in your Ceph configuration
file before you create your monitors and OSDs. This tells Ceph that an OSD
can peer with another OSD on the same host. If you are trying to set up a
1-node cluster and <code class="docutils literal notranslate"><span class="pre">osd</span> <span class="pre">crush</span> <span class="pre">chooseleaf</span> <span class="pre">type</span></code> is greater than <code class="docutils literal notranslate"><span class="pre">0</span></code>,
Ceph will try to peer the PGs of one OSD with the PGs of another OSD on
another node, chassis, rack, row, or even datacenter depending on the setting.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>DO NOT mount kernel clients directly on the same node as your
Ceph Storage Cluster, because kernel conflicts can arise. However, you
can mount kernel clients within virtual machines (VMs) on a single node.</p>
</div>
<p>If you are creating OSDs using a single disk, you must create directories
for the data manually first.</p>
</section>
<section id="fewer-osds-than-replicas">
<h3>Fewer OSDs than Replicas<a class="headerlink" href="#fewer-osds-than-replicas" title="Permalink to this heading">¶</a></h3>
<p>If you have brought up two OSDs to an <code class="docutils literal notranslate"><span class="pre">up</span></code> and <code class="docutils literal notranslate"><span class="pre">in</span></code> state, but you still
don’t see <code class="docutils literal notranslate"><span class="pre">active</span> <span class="pre">+</span> <span class="pre">clean</span></code> placement groups, you may have an
<code class="docutils literal notranslate"><span class="pre">osd</span> <span class="pre">pool</span> <span class="pre">default</span> <span class="pre">size</span></code> set to greater than <code class="docutils literal notranslate"><span class="pre">2</span></code>.</p>
<p>There are a few ways to address this situation. If you want to operate your
cluster in an <code class="docutils literal notranslate"><span class="pre">active</span> <span class="pre">+</span> <span class="pre">degraded</span></code> state with two replicas, you can set the
<code class="docutils literal notranslate"><span class="pre">osd</span> <span class="pre">pool</span> <span class="pre">default</span> <span class="pre">min</span> <span class="pre">size</span></code> to <code class="docutils literal notranslate"><span class="pre">2</span></code> so that you can write objects in
an <code class="docutils literal notranslate"><span class="pre">active</span> <span class="pre">+</span> <span class="pre">degraded</span></code> state. You may also set the <code class="docutils literal notranslate"><span class="pre">osd</span> <span class="pre">pool</span> <span class="pre">default</span> <span class="pre">size</span></code>
setting to <code class="docutils literal notranslate"><span class="pre">2</span></code> so that you only have two stored replicas (the original and
one replica), in which case the cluster should achieve an <code class="docutils literal notranslate"><span class="pre">active</span> <span class="pre">+</span> <span class="pre">clean</span></code>
state.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can make the changes at runtime. If you make the changes in
your Ceph configuration file, you may need to restart your cluster.</p>
</div>
</section>
<section id="pool-size-1">
<h3>Pool Size = 1<a class="headerlink" href="#pool-size-1" title="Permalink to this heading">¶</a></h3>
<p>If you have the <code class="docutils literal notranslate"><span class="pre">osd</span> <span class="pre">pool</span> <span class="pre">default</span> <span class="pre">size</span></code> set to <code class="docutils literal notranslate"><span class="pre">1</span></code>, you will only have
one copy of the object. OSDs rely on other OSDs to tell them which objects
they should have. If a first OSD has a copy of an object and there is no
second copy, then no second OSD can tell the first OSD that it should have
that copy. For each placement group mapped to the first OSD (see
<code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">pg</span> <span class="pre">dump</span></code>), you can force the first OSD to notice the placement groups
it needs by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">force</span><span class="o">-</span><span class="n">create</span><span class="o">-</span><span class="n">pg</span> <span class="o">&lt;</span><span class="n">pgid</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="crush-map-errors">
<h3>CRUSH Map Errors<a class="headerlink" href="#crush-map-errors" title="Permalink to this heading">¶</a></h3>
<p>Another candidate for placement groups remaining unclean involves errors
in your CRUSH map.</p>
</section>
</section>
<section id="stuck-placement-groups">
<h2>Stuck Placement Groups<a class="headerlink" href="#stuck-placement-groups" title="Permalink to this heading">¶</a></h2>
<p>It is normal for placement groups to enter states like “degraded” or “peering”
following a failure.  Normally these states indicate the normal progression
through the failure recovery process. However, if a placement group stays in one
of these states for a long time this may be an indication of a larger problem.
For this reason, the monitor will warn when placement groups get “stuck” in a
non-optimal state.  Specifically, we check for:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">inactive</span></code> - The placement group has not been <code class="docutils literal notranslate"><span class="pre">active</span></code> for too long
(i.e., it hasn’t been able to service read/write requests).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unclean</span></code> - The placement group has not been <code class="docutils literal notranslate"><span class="pre">clean</span></code> for too long
(i.e., it hasn’t been able to completely recover from a previous failure).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stale</span></code> - The placement group status has not been updated by a <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code>,
indicating that all nodes storing this placement group may be <code class="docutils literal notranslate"><span class="pre">down</span></code>.</p></li>
</ul>
<p>You can explicitly list stuck placement groups with one of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump_stuck</span> <span class="n">stale</span>
<span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump_stuck</span> <span class="n">inactive</span>
<span class="n">ceph</span> <span class="n">pg</span> <span class="n">dump_stuck</span> <span class="n">unclean</span>
</pre></div>
</div>
<p>For stuck <code class="docutils literal notranslate"><span class="pre">stale</span></code> placement groups, it is normally a matter of getting the
right <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> daemons running again.  For stuck <code class="docutils literal notranslate"><span class="pre">inactive</span></code> placement
groups, it is usually a peering problem (see <a class="reference internal" href="#failures-osd-peering"><span class="std std-ref">Placement Group Down - Peering Failure</span></a>).  For
stuck <code class="docutils literal notranslate"><span class="pre">unclean</span></code> placement groups, there is usually something preventing
recovery from completing, like unfound objects (see
<a class="reference internal" href="#failures-osd-unfound"><span class="std std-ref">Unfound Objects</span></a>);</p>
</section>
<section id="placement-group-down-peering-failure">
<span id="failures-osd-peering"></span><h2>Placement Group Down - Peering Failure<a class="headerlink" href="#placement-group-down-peering-failure" title="Permalink to this heading">¶</a></h2>
<p>In certain cases, the <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> <cite>Peering</cite> process can run into
problems, preventing a PG from becoming active and usable.  For
example, <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">health</span></code> might report:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">health</span> <span class="n">detail</span>
<span class="n">HEALTH_ERR</span> <span class="mi">7</span> <span class="n">pgs</span> <span class="n">degraded</span><span class="p">;</span> <span class="mi">12</span> <span class="n">pgs</span> <span class="n">down</span><span class="p">;</span> <span class="mi">12</span> <span class="n">pgs</span> <span class="n">peering</span><span class="p">;</span> <span class="mi">1</span> <span class="n">pgs</span> <span class="n">recovering</span><span class="p">;</span> <span class="mi">6</span> <span class="n">pgs</span> <span class="n">stuck</span> <span class="n">unclean</span><span class="p">;</span> <span class="mi">114</span><span class="o">/</span><span class="mi">3300</span> <span class="n">degraded</span> <span class="p">(</span><span class="mf">3.455</span><span class="o">%</span><span class="p">);</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="ow">in</span> <span class="n">osds</span> <span class="n">are</span> <span class="n">down</span>
<span class="o">...</span>
<span class="n">pg</span> <span class="mf">0.5</span> <span class="ow">is</span> <span class="n">down</span><span class="o">+</span><span class="n">peering</span>
<span class="n">pg</span> <span class="mf">1.4</span> <span class="ow">is</span> <span class="n">down</span><span class="o">+</span><span class="n">peering</span>
<span class="o">...</span>
<span class="n">osd</span><span class="mf">.1</span> <span class="ow">is</span> <span class="n">down</span> <span class="n">since</span> <span class="n">epoch</span> <span class="mi">69</span><span class="p">,</span> <span class="n">last</span> <span class="n">address</span> <span class="mf">192.168.106.220</span><span class="p">:</span><span class="mi">6801</span><span class="o">/</span><span class="mi">8651</span>
</pre></div>
</div>
<p>We can query the cluster to determine exactly why the PG is marked <code class="docutils literal notranslate"><span class="pre">down</span></code> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">pg</span> <span class="mf">0.5</span> <span class="n">query</span>
</pre></div>
</div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;down+peering&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="s2">&quot;recovery_state&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Started\/Primary\/Peering\/GetInfo&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="s2">&quot;enter_time&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2012-03-06 14:40:16.169679&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="s2">&quot;requested_info_from&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[]},</span>
<span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Started\/Primary\/Peering&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="s2">&quot;enter_time&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2012-03-06 14:40:16.169659&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="s2">&quot;probing_osds&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">               </span><span class="mf">0</span><span class="p">,</span>
<span class="w">               </span><span class="mf">1</span><span class="p">],</span>
<span class="w">         </span><span class="s2">&quot;blocked&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;peering is blocked due to down osds&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="s2">&quot;down_osds_we_would_probe&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">               </span><span class="mf">1</span><span class="p">],</span>
<span class="w">         </span><span class="s2">&quot;peering_blocked_by&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">               </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;osd&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">                 </span><span class="s2">&quot;current_lost_at&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">                 </span><span class="s2">&quot;comment&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;starting or marking this osd lost may let us proceed&quot;</span><span class="p">}]},</span>
<span class="w">       </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Started&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="s2">&quot;enter_time&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2012-03-06 14:40:16.169513&quot;</span><span class="p">}</span>
<span class="w">   </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">recovery_state</span></code> section tells us that peering is blocked due to
down <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> daemons, specifically <code class="docutils literal notranslate"><span class="pre">osd.1</span></code>.  In this case, we can start that <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code>
and things will recover.</p>
<p>Alternatively, if there is a catastrophic failure of <code class="docutils literal notranslate"><span class="pre">osd.1</span></code> (e.g., disk
failure), we can tell the cluster that it is <code class="docutils literal notranslate"><span class="pre">lost</span></code> and to cope as
best it can.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This is dangerous in that the cluster cannot
guarantee that the other copies of the data are consistent
and up to date.</p>
</div>
<p>To instruct Ceph to continue anyway:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">lost</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Recovery will proceed.</p>
</section>
<section id="unfound-objects">
<span id="failures-osd-unfound"></span><h2>Unfound Objects<a class="headerlink" href="#unfound-objects" title="Permalink to this heading">¶</a></h2>
<p>Under certain combinations of failures Ceph may complain about
<code class="docutils literal notranslate"><span class="pre">unfound</span></code> objects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">health</span> <span class="n">detail</span>
<span class="n">HEALTH_WARN</span> <span class="mi">1</span> <span class="n">pgs</span> <span class="n">degraded</span><span class="p">;</span> <span class="mi">78</span><span class="o">/</span><span class="mi">3778</span> <span class="n">unfound</span> <span class="p">(</span><span class="mf">2.065</span><span class="o">%</span><span class="p">)</span>
<span class="n">pg</span> <span class="mf">2.4</span> <span class="ow">is</span> <span class="n">active</span><span class="o">+</span><span class="n">degraded</span><span class="p">,</span> <span class="mi">78</span> <span class="n">unfound</span>
</pre></div>
</div>
<p>This means that the storage cluster knows that some objects (or newer
copies of existing objects) exist, but it hasn’t found copies of them.
One example of how this might come about for a PG whose data is on ceph-osds
1 and 2:</p>
<ul class="simple">
<li><p>1 goes down</p></li>
<li><p>2 handles some writes, alone</p></li>
<li><p>1 comes up</p></li>
<li><p>1 and 2 repeer, and the objects missing on 1 are queued for recovery.</p></li>
<li><p>Before the new objects are copied, 2 goes down.</p></li>
</ul>
<p>Now 1 knows that these object exist, but there is no live <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> who
has a copy.  In this case, IO to those objects will block, and the
cluster will hope that the failed node comes back soon; this is
assumed to be preferable to returning an IO error to the user.</p>
<p>First, you can identify which objects are unfound with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">pg</span> <span class="mf">2.4</span> <span class="n">list_unfound</span> <span class="p">[</span><span class="n">starting</span> <span class="n">offset</span><span class="p">,</span> <span class="ow">in</span> <span class="n">json</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;num_missing&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;num_unfound&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;objects&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;oid&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="s2">&quot;oid&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;snapid&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">2</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;hash&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2249616407</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;max&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;pool&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;namespace&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="s2">&quot;need&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;43&#39;251&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;have&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0&#39;0&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;flags&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;clean_regions&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;clean_offsets: [], clean_omap: 0, new_object: 1&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;locations&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">              </span><span class="s2">&quot;0(3)&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="s2">&quot;4(2)&quot;</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="s2">&quot;state&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;NotRecovering&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;available_might_have_unfound&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;might_have_unfound&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">          </span><span class="s2">&quot;osd&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2(4)&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;osd is down&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="s2">&quot;more&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If there are too many objects to list in a single result, the <code class="docutils literal notranslate"><span class="pre">more</span></code>
field will be true and you can query for more.  (Eventually the
command line tool will hide this from you, but not yet.)</p>
<p>Second, you can identify which OSDs have been probed or might contain
data.</p>
<p>At the end of the listing (before <code class="docutils literal notranslate"><span class="pre">more</span></code> is false), <code class="docutils literal notranslate"><span class="pre">might_have_unfound</span></code> is provided
when <code class="docutils literal notranslate"><span class="pre">available_might_have_unfound</span></code> is true.  This is equivalent to the output
of <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">pg</span> <span class="pre">#.#</span> <span class="pre">query</span></code>.  This eliminates the need to use <code class="docutils literal notranslate"><span class="pre">query</span></code> directly.
The <code class="docutils literal notranslate"><span class="pre">might_have_unfound</span></code> information given behaves the same way as described below for <code class="docutils literal notranslate"><span class="pre">query</span></code>.
The only difference is that OSDs that have <code class="docutils literal notranslate"><span class="pre">already</span> <span class="pre">probed</span></code> status are ignored.</p>
<p>Use of <code class="docutils literal notranslate"><span class="pre">query</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">pg</span> <span class="mf">2.4</span> <span class="n">query</span>
</pre></div>
</div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;recovery_state&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">     </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Started\/Primary\/Active&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="s2">&quot;enter_time&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2012-03-06 15:15:46.713212&quot;</span><span class="p">,</span>
<span class="w">       </span><span class="s2">&quot;might_have_unfound&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">             </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;osd&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">               </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;osd is down&quot;</span><span class="p">}]},</span>
</pre></div>
</div>
<p>In this case, for example, the cluster knows that <code class="docutils literal notranslate"><span class="pre">osd.1</span></code> might have
data, but it is <code class="docutils literal notranslate"><span class="pre">down</span></code>.  The full range of possible states include:</p>
<ul class="simple">
<li><p>already probed</p></li>
<li><p>querying</p></li>
<li><p>OSD is down</p></li>
<li><p>not queried (yet)</p></li>
</ul>
<p>Sometimes it simply takes some time for the cluster to query possible
locations.</p>
<p>It is possible that there are other locations where the object can
exist that are not listed.  For example, if a ceph-osd is stopped and
taken out of the cluster, the cluster fully recovers, and due to some
future set of failures ends up with an unfound object, it won’t
consider the long-departed ceph-osd as a potential location to
consider.  (This scenario, however, is unlikely.)</p>
<p>If all possible locations have been queried and objects are still
lost, you may have to give up on the lost objects. This, again, is
possible given unusual combinations of failures that allow the cluster
to learn about writes that were performed before the writes themselves
are recovered.  To mark the “unfound” objects as “lost”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">pg</span> <span class="mf">2.5</span> <span class="n">mark_unfound_lost</span> <span class="n">revert</span><span class="o">|</span><span class="n">delete</span>
</pre></div>
</div>
<p>This the final argument specifies how the cluster should deal with
lost objects.</p>
<p>The “delete” option will forget about them entirely.</p>
<p>The “revert” option (not available for erasure coded pools) will
either roll back to a previous version of the object or (if it was a
new object) forget about it entirely.  Use this with caution, as it
may confuse applications that expected the object to exist.</p>
</section>
<section id="homeless-placement-groups">
<h2>Homeless Placement Groups<a class="headerlink" href="#homeless-placement-groups" title="Permalink to this heading">¶</a></h2>
<p>It is possible for all OSDs that had copies of a given placement groups to fail.
If that’s the case, that subset of the object store is unavailable, and the
monitor will receive no status updates for those placement groups.  To detect
this situation, the monitor marks any placement group whose primary OSD has
failed as <code class="docutils literal notranslate"><span class="pre">stale</span></code>.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">health</span>
<span class="n">HEALTH_WARN</span> <span class="mi">24</span> <span class="n">pgs</span> <span class="n">stale</span><span class="p">;</span> <span class="mi">3</span><span class="o">/</span><span class="mi">300</span> <span class="ow">in</span> <span class="n">osds</span> <span class="n">are</span> <span class="n">down</span>
</pre></div>
</div>
<p>You can identify which placement groups are <code class="docutils literal notranslate"><span class="pre">stale</span></code>, and what the last OSDs to
store them were, with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">health</span> <span class="n">detail</span>
<span class="n">HEALTH_WARN</span> <span class="mi">24</span> <span class="n">pgs</span> <span class="n">stale</span><span class="p">;</span> <span class="mi">3</span><span class="o">/</span><span class="mi">300</span> <span class="ow">in</span> <span class="n">osds</span> <span class="n">are</span> <span class="n">down</span>
<span class="o">...</span>
<span class="n">pg</span> <span class="mf">2.5</span> <span class="ow">is</span> <span class="n">stuck</span> <span class="n">stale</span><span class="o">+</span><span class="n">active</span><span class="o">+</span><span class="n">remapped</span><span class="p">,</span> <span class="n">last</span> <span class="n">acting</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="o">...</span>
<span class="n">osd</span><span class="mf">.10</span> <span class="ow">is</span> <span class="n">down</span> <span class="n">since</span> <span class="n">epoch</span> <span class="mi">23</span><span class="p">,</span> <span class="n">last</span> <span class="n">address</span> <span class="mf">192.168.106.220</span><span class="p">:</span><span class="mi">6800</span><span class="o">/</span><span class="mi">11080</span>
<span class="n">osd</span><span class="mf">.11</span> <span class="ow">is</span> <span class="n">down</span> <span class="n">since</span> <span class="n">epoch</span> <span class="mi">13</span><span class="p">,</span> <span class="n">last</span> <span class="n">address</span> <span class="mf">192.168.106.220</span><span class="p">:</span><span class="mi">6803</span><span class="o">/</span><span class="mi">11539</span>
<span class="n">osd</span><span class="mf">.12</span> <span class="ow">is</span> <span class="n">down</span> <span class="n">since</span> <span class="n">epoch</span> <span class="mi">24</span><span class="p">,</span> <span class="n">last</span> <span class="n">address</span> <span class="mf">192.168.106.220</span><span class="p">:</span><span class="mi">6806</span><span class="o">/</span><span class="mi">11861</span>
</pre></div>
</div>
<p>If we want to get placement group 2.5 back online, for example, this tells us that
it was last managed by <code class="docutils literal notranslate"><span class="pre">osd.0</span></code> and <code class="docutils literal notranslate"><span class="pre">osd.2</span></code>.  Restarting those <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code>
daemons will allow the cluster to recover that placement group (and, presumably,
many others).</p>
</section>
<section id="only-a-few-osds-receive-data">
<h2>Only a Few OSDs Receive Data<a class="headerlink" href="#only-a-few-osds-receive-data" title="Permalink to this heading">¶</a></h2>
<p>If you have many nodes in your cluster and only a few of them receive data,
<a class="reference external" href="../../operations/placement-groups#get-the-number-of-placement-groups">check</a> the number of placement groups in your pool. Since placement groups get
mapped to OSDs, a small number of placement groups will not distribute across
your cluster. Try creating a pool with a placement group count that is a
multiple of the number of OSDs. See <a class="reference external" href="../../operations/placement-groups">Placement Groups</a> for details. The default
placement group count for pools is not useful, but you can change it <a class="reference external" href="../../configuration/pool-pg-config-ref">here</a>.</p>
</section>
<section id="can-t-write-data">
<h2>Can’t Write Data<a class="headerlink" href="#can-t-write-data" title="Permalink to this heading">¶</a></h2>
<p>If your cluster is up, but some OSDs are down and you cannot write data,
check to ensure that you have the minimum number of OSDs running for the
placement group. If you don’t have the minimum number of OSDs running,
Ceph will not allow you to write data because there is no guarantee
that Ceph can replicate your data. See <code class="docutils literal notranslate"><span class="pre">osd</span> <span class="pre">pool</span> <span class="pre">default</span> <span class="pre">min</span> <span class="pre">size</span></code>
in the <a class="reference external" href="../../configuration/pool-pg-config-ref">Pool, PG and CRUSH Config Reference</a> for details.</p>
</section>
<section id="pgs-inconsistent">
<h2>PGs Inconsistent<a class="headerlink" href="#pgs-inconsistent" title="Permalink to this heading">¶</a></h2>
<p>If you receive an <code class="docutils literal notranslate"><span class="pre">active</span> <span class="pre">+</span> <span class="pre">clean</span> <span class="pre">+</span> <span class="pre">inconsistent</span></code> state, this may happen
due to an error during scrubbing. As always, we can identify the inconsistent
placement group(s) with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph health detail
HEALTH_ERR 1 pgs inconsistent; 2 scrub errors
pg 0.6 is active+clean+inconsistent, acting [0,1,2]
2 scrub errors
</pre></div>
</div>
<p>Or if you prefer inspecting the output in a programmatic way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ rados list-inconsistent-pg rbd
[&quot;0.6&quot;]
</pre></div>
</div>
<p>There is only one consistent state, but in the worst case, we could have
different inconsistencies in multiple perspectives found in more than one
objects. If an object named <code class="docutils literal notranslate"><span class="pre">foo</span></code> in PG <code class="docutils literal notranslate"><span class="pre">0.6</span></code> is truncated, we will have:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ rados list-inconsistent-obj 0.6 --format=json-pretty
</pre></div>
</div>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;epoch&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">14</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;inconsistents&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;object&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;foo&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;nspace&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;locator&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;snap&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;head&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="s2">&quot;errors&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;data_digest_mismatch&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;size_mismatch&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="s2">&quot;union_shard_errors&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;data_digest_mismatch_info&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;size_mismatch_info&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="s2">&quot;selected_object_info&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0:602f83fe:::foo:head(16&#39;1 client.4110.0:1 dirty|data_digest|omap_digest s 968 uv 1 dd e978e67f od ffffffff alloc_hint [0 0 0])&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;shards&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;osd&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;errors&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">                    </span><span class="s2">&quot;size&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">968</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;omap_digest&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0xffffffff&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;data_digest&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0xe978e67f&quot;</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;osd&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;errors&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">                    </span><span class="s2">&quot;size&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">968</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;omap_digest&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0xffffffff&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;data_digest&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0xe978e67f&quot;</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="s2">&quot;osd&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;errors&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                        </span><span class="s2">&quot;data_digest_mismatch_info&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="s2">&quot;size_mismatch_info&quot;</span>
<span class="w">                    </span><span class="p">],</span>
<span class="w">                    </span><span class="s2">&quot;size&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;omap_digest&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0xffffffff&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;data_digest&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0xffffffff&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this case, we can learn from the output:</p>
<ul class="simple">
<li><p>The only inconsistent object is named <code class="docutils literal notranslate"><span class="pre">foo</span></code>, and it is its head that has
inconsistencies.</p></li>
<li><p>The inconsistencies fall into two categories:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">errors</span></code>: these errors indicate inconsistencies between shards without a
determination of which shard(s) are bad. Check for the <code class="docutils literal notranslate"><span class="pre">errors</span></code> in the
<cite>shards</cite> array, if available, to pinpoint the problem.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">data_digest_mismatch</span></code>: the digest of the replica read from OSD.2 is
different from the ones of OSD.0 and OSD.1</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">size_mismatch</span></code>: the size of the replica read from OSD.2 is 0, while
the size reported by OSD.0 and OSD.1 is 968.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">union_shard_errors</span></code>: the union of all shard specific <code class="docutils literal notranslate"><span class="pre">errors</span></code> in
<code class="docutils literal notranslate"><span class="pre">shards</span></code> array. The <code class="docutils literal notranslate"><span class="pre">errors</span></code> are set for the given shard that has the
problem. They include errors like <code class="docutils literal notranslate"><span class="pre">read_error</span></code>. The <code class="docutils literal notranslate"><span class="pre">errors</span></code> ending in
<code class="docutils literal notranslate"><span class="pre">oi</span></code> indicate a comparison with <code class="docutils literal notranslate"><span class="pre">selected_object_info</span></code>. Look at the
<code class="docutils literal notranslate"><span class="pre">shards</span></code> array to determine which shard has which error(s).</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">data_digest_mismatch_info</span></code>: the digest stored in the object-info is not
<code class="docutils literal notranslate"><span class="pre">0xffffffff</span></code>, which is calculated from the shard read from OSD.2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">size_mismatch_info</span></code>: the size stored in the object-info is different
from the one read from OSD.2. The latter is 0.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>You can repair the inconsistent placement group by executing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">pg</span> <span class="n">repair</span> <span class="p">{</span><span class="n">placement</span><span class="o">-</span><span class="n">group</span><span class="o">-</span><span class="n">ID</span><span class="p">}</span>
</pre></div>
</div>
<p>Which overwrites the <cite>bad</cite> copies with the <cite>authoritative</cite> ones. In most cases,
Ceph is able to choose authoritative copies from all available replicas using
some predefined criteria. But this does not always work. For example, the stored
data digest could be missing, and the calculated digest will be ignored when
choosing the authoritative copies. So, please use the above command with caution.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">read_error</span></code> is listed in the <code class="docutils literal notranslate"><span class="pre">errors</span></code> attribute of a shard, the
inconsistency is likely due to disk errors. You might want to check your disk
used by that OSD.</p>
<p>If you receive <code class="docutils literal notranslate"><span class="pre">active</span> <span class="pre">+</span> <span class="pre">clean</span> <span class="pre">+</span> <span class="pre">inconsistent</span></code> states periodically due to
clock skew, you may consider configuring your <a class="reference external" href="https://en.wikipedia.org/wiki/Network_Time_Protocol">NTP</a> daemons on your
monitor hosts to act as peers. See <a class="reference external" href="http://www.ntp.org/">The Network Time Protocol</a> and Ceph
<a class="reference external" href="../../configuration/mon-config-ref/#clock">Clock Settings</a> for additional details.</p>
</section>
<section id="erasure-coded-pgs-are-not-active-clean">
<h2>Erasure Coded PGs are not active+clean<a class="headerlink" href="#erasure-coded-pgs-are-not-active-clean" title="Permalink to this heading">¶</a></h2>
<p>When CRUSH fails to find enough OSDs to map to a PG, it will show as a
<code class="docutils literal notranslate"><span class="pre">2147483647</span></code> which is ITEM_NONE or <code class="docutils literal notranslate"><span class="pre">no</span> <span class="pre">OSD</span> <span class="pre">found</span></code>. For instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">2147483647</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
<section id="not-enough-osds">
<h3>Not enough OSDs<a class="headerlink" href="#not-enough-osds" title="Permalink to this heading">¶</a></h3>
<p>If the Ceph cluster only has 8 OSDs and the erasure coded pool needs
9, that is what it will show. You can either create another erasure
coded pool that requires less OSDs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure</span><span class="o">-</span><span class="n">code</span><span class="o">-</span><span class="n">profile</span> <span class="nb">set</span> <span class="n">myprofile</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span> <span class="n">m</span><span class="o">=</span><span class="mi">3</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">erasurepool</span> <span class="n">erasure</span> <span class="n">myprofile</span>
</pre></div>
</div>
<p>or add a new OSDs and the PG will automatically use them.</p>
</section>
<section id="crush-constraints-cannot-be-satisfied">
<h3>CRUSH constraints cannot be satisfied<a class="headerlink" href="#crush-constraints-cannot-be-satisfied" title="Permalink to this heading">¶</a></h3>
<p>If the cluster has enough OSDs, it is possible that the CRUSH rule
imposes constraints that cannot be satisfied. If there are 10 OSDs on
two hosts and the CRUSH rule requires that no two OSDs from the
same host are used in the same PG, the mapping may fail because only
two OSDs will be found. You can check the constraint by displaying (“dumping”)
the rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph osd crush rule ls
[
    &quot;replicated_rule&quot;,
    &quot;erasurepool&quot;]
$ ceph osd crush rule dump erasurepool
{ &quot;rule_id&quot;: 1,
  &quot;rule_name&quot;: &quot;erasurepool&quot;,
  &quot;ruleset&quot;: 1,
  &quot;type&quot;: 3,
  &quot;min_size&quot;: 3,
  &quot;max_size&quot;: 20,
  &quot;steps&quot;: [
        { &quot;op&quot;: &quot;take&quot;,
          &quot;item&quot;: -1,
          &quot;item_name&quot;: &quot;default&quot;},
        { &quot;op&quot;: &quot;chooseleaf_indep&quot;,
          &quot;num&quot;: 0,
          &quot;type&quot;: &quot;host&quot;},
        { &quot;op&quot;: &quot;emit&quot;}]}
</pre></div>
</div>
<p>You can resolve the problem by creating a new pool in which PGs are allowed
to have OSDs residing on the same host with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">erasure</span><span class="o">-</span><span class="n">code</span><span class="o">-</span><span class="n">profile</span> <span class="nb">set</span> <span class="n">myprofile</span> <span class="n">crush</span><span class="o">-</span><span class="n">failure</span><span class="o">-</span><span class="n">domain</span><span class="o">=</span><span class="n">osd</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">pool</span> <span class="n">create</span> <span class="n">erasurepool</span> <span class="n">erasure</span> <span class="n">myprofile</span>
</pre></div>
</div>
</section>
<section id="crush-gives-up-too-soon">
<h3>CRUSH gives up too soon<a class="headerlink" href="#crush-gives-up-too-soon" title="Permalink to this heading">¶</a></h3>
<p>If the Ceph cluster has just enough OSDs to map the PG (for instance a
cluster with a total of 9 OSDs and an erasure coded pool that requires
9 OSDs per PG), it is possible that CRUSH gives up before finding a
mapping. It can be resolved by:</p>
<ul class="simple">
<li><p>lowering the erasure coded pool requirements to use less OSDs per PG
(that requires the creation of another pool as erasure code profiles
cannot be dynamically modified).</p></li>
<li><p>adding more OSDs to the cluster (that does not require the erasure
coded pool to be modified, it will become clean automatically)</p></li>
<li><p>use a handmade CRUSH rule that tries more times to find a good
mapping. This can be done by setting <code class="docutils literal notranslate"><span class="pre">set_choose_tries</span></code> to a value
greater than the default.</p></li>
</ul>
<p>You should first verify the problem with <code class="docutils literal notranslate"><span class="pre">crushtool</span></code> after
extracting the crushmap from the cluster so your experiments do not
modify the Ceph cluster and only work on a local files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ceph osd crush rule dump erasurepool
{ &quot;rule_name&quot;: &quot;erasurepool&quot;,
  &quot;ruleset&quot;: 1,
  &quot;type&quot;: 3,
  &quot;min_size&quot;: 3,
  &quot;max_size&quot;: 20,
  &quot;steps&quot;: [
        { &quot;op&quot;: &quot;take&quot;,
          &quot;item&quot;: -1,
          &quot;item_name&quot;: &quot;default&quot;},
        { &quot;op&quot;: &quot;chooseleaf_indep&quot;,
          &quot;num&quot;: 0,
          &quot;type&quot;: &quot;host&quot;},
        { &quot;op&quot;: &quot;emit&quot;}]}
$ ceph osd getcrushmap &gt; crush.map
got crush map from osdmap epoch 13
$ crushtool -i crush.map --test --show-bad-mappings \
   --rule 1 \
   --num-rep 9 \
   --min-x 1 --max-x $((1024 * 1024))
bad mapping rule 8 x 43 num_rep 9 result [3,2,7,1,2147483647,8,5,6,0]
bad mapping rule 8 x 79 num_rep 9 result [6,0,2,1,4,7,2147483647,5,8]
bad mapping rule 8 x 173 num_rep 9 result [0,4,6,8,2,1,3,7,2147483647]
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">--num-rep</span></code> is the number of OSDs the erasure code CRUSH
rule needs, <code class="docutils literal notranslate"><span class="pre">--rule</span></code> is the value of the <code class="docutils literal notranslate"><span class="pre">ruleset</span></code> field
displayed by <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">osd</span> <span class="pre">crush</span> <span class="pre">rule</span> <span class="pre">dump</span></code>.  The test will try mapping
one million values (i.e. the range defined by <code class="docutils literal notranslate"><span class="pre">[--min-x,--max-x]</span></code>)
and must display at least one bad mapping. If it outputs nothing it
means all mappings are successful and you can stop right there: the
problem is elsewhere.</p>
<p>The CRUSH rule can be edited by decompiling the crush map:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ crushtool --decompile crush.map &gt; crush.txt
</pre></div>
</div>
<p>and adding the following line to the rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="n">set_choose_tries</span> <span class="mi">100</span>
</pre></div>
</div>
<p>The relevant part of the <code class="docutils literal notranslate"><span class="pre">crush.txt</span></code> file should look something
like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">erasurepool</span> <span class="p">{</span>
        <span class="n">ruleset</span> <span class="mi">1</span>
        <span class="nb">type</span> <span class="n">erasure</span>
        <span class="n">min_size</span> <span class="mi">3</span>
        <span class="n">max_size</span> <span class="mi">20</span>
        <span class="n">step</span> <span class="n">set_chooseleaf_tries</span> <span class="mi">5</span>
        <span class="n">step</span> <span class="n">set_choose_tries</span> <span class="mi">100</span>
        <span class="n">step</span> <span class="n">take</span> <span class="n">default</span>
        <span class="n">step</span> <span class="n">chooseleaf</span> <span class="n">indep</span> <span class="mi">0</span> <span class="nb">type</span> <span class="n">host</span>
        <span class="n">step</span> <span class="n">emit</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It can then be compiled and tested again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ crushtool --compile crush.txt -o better-crush.map
</pre></div>
</div>
<p>When all mappings succeed, an histogram of the number of tries that
were necessary to find all of them can be displayed with the
<code class="docutils literal notranslate"><span class="pre">--show-choose-tries</span></code> option of <code class="docutils literal notranslate"><span class="pre">crushtool</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ crushtool -i better-crush.map --test --show-bad-mappings \
   --show-choose-tries \
   --rule 1 \
   --num-rep 9 \
   --min-x 1 --max-x $((1024 * 1024))
...
11:        42
12:        44
13:        54
14:        45
15:        35
16:        34
17:        30
18:        25
19:        19
20:        22
21:        20
22:        17
23:        13
24:        16
25:        13
26:        11
27:        11
28:        13
29:        11
30:        10
31:         6
32:         5
33:        10
34:         3
35:         7
36:         5
37:         2
38:         5
39:         5
40:         2
41:         5
42:         4
43:         1
44:         2
45:         2
46:         3
47:         1
48:         0
...
102:         0
103:         1
104:         0
...
</pre></div>
</div>
<p>It took 11 tries to map 42 PGs, 12 tries to map 44 PGs etc. The highest number of tries is the minimum value of <code class="docutils literal notranslate"><span class="pre">set_choose_tries</span></code> that prevents bad mappings (i.e. 103 in the above output because it did not take more than 103 tries for any PG to be mapped).</p>
</section>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../">
              <img class="logo" src="../../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cephadm/">Cephadm</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../">Ceph Storage Cluster</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../configuration/">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cephadm/">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/">Man Pages</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">Troubleshooting</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../community/">The Ceph Community</a></li>
<li class="toctree-l3"><a class="reference internal" href="../log-and-debug/">Logging and Debugging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting-mon/">Troubleshooting Monitors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting-osd/">Troubleshooting OSDs</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Troubleshooting PGs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#placement-groups-never-get-clean">Placement Groups Never Get Clean</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#one-node-cluster">One Node Cluster</a></li>
<li class="toctree-l5"><a class="reference internal" href="#fewer-osds-than-replicas">Fewer OSDs than Replicas</a></li>
<li class="toctree-l5"><a class="reference internal" href="#pool-size-1">Pool Size = 1</a></li>
<li class="toctree-l5"><a class="reference internal" href="#crush-map-errors">CRUSH Map Errors</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#stuck-placement-groups">Stuck Placement Groups</a></li>
<li class="toctree-l4"><a class="reference internal" href="#placement-group-down-peering-failure">Placement Group Down - Peering Failure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unfound-objects">Unfound Objects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#homeless-placement-groups">Homeless Placement Groups</a></li>
<li class="toctree-l4"><a class="reference internal" href="#only-a-few-osds-receive-data">Only a Few OSDs Receive Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#can-t-write-data">Can’t Write Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pgs-inconsistent">PGs Inconsistent</a></li>
<li class="toctree-l4"><a class="reference internal" href="#erasure-coded-pgs-are-not-active-clean">Erasure Coded PGs are not active+clean</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#not-enough-osds">Not enough OSDs</a></li>
<li class="toctree-l5"><a class="reference internal" href="#crush-constraints-cannot-be-satisfied">CRUSH constraints cannot be satisfied</a></li>
<li class="toctree-l5"><a class="reference internal" href="#crush-gives-up-too-soon">CRUSH gives up too soon</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../memory-profiling/">Memory Profiling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cpu-profiling/">CPU Profiling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/">APIs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cephfs/">Ceph File System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../log-and-debug/" title="Logging and Debugging"
             >next</a> |</li>
        <li class="right" >
          <a href="../troubleshooting-osd/" title="Troubleshooting OSDs"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../" >Ceph Storage Cluster</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../operations/" >Cluster Operations</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Troubleshooting PGs</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>