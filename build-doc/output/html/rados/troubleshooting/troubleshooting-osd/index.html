
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Troubleshooting OSDs &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
    <link rel="next" title="Troubleshooting PGs" href="../troubleshooting-pg/" />
    <link rel="prev" title="Troubleshooting Monitors" href="../troubleshooting-mon/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../troubleshooting-pg/" title="Troubleshooting PGs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../troubleshooting-mon/" title="Troubleshooting Monitors"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../" >Ceph Storage Cluster</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../operations/" accesskey="U">Cluster Operations</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Troubleshooting OSDs</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="troubleshooting-osds">
<h1>Troubleshooting OSDs<a class="headerlink" href="#troubleshooting-osds" title="Permalink to this heading">¶</a></h1>
<p>Before troubleshooting your OSDs, first check your monitors and network. If
you execute <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">health</span></code> or <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">-s</span></code> on the command line and Ceph shows
<code class="docutils literal notranslate"><span class="pre">HEALTH_OK</span></code>, it means that the monitors have a quorum.
If you don’t have a monitor quorum or if there are errors with the monitor
status, <a class="reference external" href="../troubleshooting-mon">address the monitor issues first</a>.
Check your networks to ensure they
are running properly, because networks may have a significant impact on OSD
operation and performance. Look for dropped packets on the host side
and CRC errors on the switch side.</p>
<section id="obtaining-data-about-osds">
<h2>Obtaining Data About OSDs<a class="headerlink" href="#obtaining-data-about-osds" title="Permalink to this heading">¶</a></h2>
<p>A good first step in troubleshooting your OSDs is to obtain topology information in
addition to the information you collected while <a class="reference external" href="../../operations/monitoring-osd-pg">monitoring your OSDs</a>
(e.g., <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">osd</span> <span class="pre">tree</span></code>).</p>
<section id="ceph-logs">
<h3>Ceph Logs<a class="headerlink" href="#ceph-logs" title="Permalink to this heading">¶</a></h3>
<p>If you haven’t changed the default path, you can find Ceph log files at
<code class="docutils literal notranslate"><span class="pre">/var/log/ceph</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">ceph</span>
</pre></div>
</div>
<p>If you don’t see enough log detail you can change your logging level.  See
<a class="reference external" href="../log-and-debug">Logging and Debugging</a> for details to ensure that Ceph performs adequately
under high logging volume.</p>
</section>
<section id="admin-socket">
<h3>Admin Socket<a class="headerlink" href="#admin-socket" title="Permalink to this heading">¶</a></h3>
<p>Use the admin socket tool to retrieve runtime information. For details, list
the sockets for your Ceph daemons:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">ceph</span>
</pre></div>
</div>
<p>Then, execute the following, replacing <code class="docutils literal notranslate"><span class="pre">{daemon-name}</span></code> with an actual
daemon (e.g., <code class="docutils literal notranslate"><span class="pre">osd.0</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">daemon</span> <span class="n">osd</span><span class="mf">.0</span> <span class="n">help</span>
</pre></div>
</div>
<p>Alternatively, you can specify a <code class="docutils literal notranslate"><span class="pre">{socket-file}</span></code> (e.g., something in <code class="docutils literal notranslate"><span class="pre">/var/run/ceph</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">daemon</span> <span class="p">{</span><span class="n">socket</span><span class="o">-</span><span class="n">file</span><span class="p">}</span> <span class="n">help</span>
</pre></div>
</div>
<p>The admin socket, among other things, allows you to:</p>
<ul class="simple">
<li><p>List your configuration at runtime</p></li>
<li><p>Dump historic operations</p></li>
<li><p>Dump the operation priority queue state</p></li>
<li><p>Dump operations in flight</p></li>
<li><p>Dump perfcounters</p></li>
</ul>
</section>
<section id="display-freespace">
<h3>Display Freespace<a class="headerlink" href="#display-freespace" title="Permalink to this heading">¶</a></h3>
<p>Filesystem issues may arise. To display your file system’s free space, execute
<code class="docutils literal notranslate"><span class="pre">df</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
<p>Execute <code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">--help</span></code> for additional usage.</p>
</section>
<section id="i-o-statistics">
<h3>I/O Statistics<a class="headerlink" href="#i-o-statistics" title="Permalink to this heading">¶</a></h3>
<p>Use <a class="reference external" href="https://en.wikipedia.org/wiki/Iostat">iostat</a> to identify I/O-related issues.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iostat</span> <span class="o">-</span><span class="n">x</span>
</pre></div>
</div>
</section>
<section id="diagnostic-messages">
<h3>Diagnostic Messages<a class="headerlink" href="#diagnostic-messages" title="Permalink to this heading">¶</a></h3>
<p>To retrieve diagnostic messages from the kernel, use <code class="docutils literal notranslate"><span class="pre">dmesg</span></code> with <code class="docutils literal notranslate"><span class="pre">less</span></code>, <code class="docutils literal notranslate"><span class="pre">more</span></code>, <code class="docutils literal notranslate"><span class="pre">grep</span></code>
or <code class="docutils literal notranslate"><span class="pre">tail</span></code>.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dmesg</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">scsi</span>
</pre></div>
</div>
</section>
</section>
<section id="stopping-w-out-rebalancing">
<h2>Stopping w/out Rebalancing<a class="headerlink" href="#stopping-w-out-rebalancing" title="Permalink to this heading">¶</a></h2>
<p>Periodically, you may need to perform maintenance on a subset of your cluster,
or resolve a problem that affects a failure domain (e.g., a rack). If you do not
want CRUSH to automatically rebalance the cluster as you stop OSDs for
maintenance, set the cluster to <code class="docutils literal notranslate"><span class="pre">noout</span></code> first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set</span> <span class="n">noout</span>
</pre></div>
</div>
<p>On Luminous or newer releases it is safer to set the flag only on affected OSDs.
You can do this individually</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">add</span><span class="o">-</span><span class="n">noout</span> <span class="n">osd</span><span class="mf">.0</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">rm</span><span class="o">-</span><span class="n">noout</span>  <span class="n">osd</span><span class="mf">.0</span>
</pre></div>
</div>
<p>Or an entire CRUSH bucket at a time.  Say you’re going to take down
<code class="docutils literal notranslate"><span class="pre">prod-ceph-data1701</span></code> to add RAM</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set</span><span class="o">-</span><span class="n">group</span> <span class="n">noout</span> <span class="n">prod</span><span class="o">-</span><span class="n">ceph</span><span class="o">-</span><span class="n">data1701</span>
</pre></div>
</div>
<p>Once the flag is set you can stop the OSDs and any other colocated Ceph
services within the failure domain that requires maintenance work.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">stop</span> <span class="n">ceph</span>\<span class="o">*.</span><span class="n">service</span> <span class="n">ceph</span>\<span class="o">*.</span><span class="n">target</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Placement groups within the OSDs you stop will become <code class="docutils literal notranslate"><span class="pre">degraded</span></code>
while you are addressing issues with within the failure domain.</p>
</div>
<p>Once you have completed your maintenance, restart the OSDs and any other
daemons.  If you rebooted the host as part of the maintenance, these should
come back on their own without intervention.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">ceph</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<p>Finally, you must unset the cluster-wide``noout`` flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">unset</span> <span class="n">noout</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">unset</span><span class="o">-</span><span class="n">group</span> <span class="n">noout</span> <span class="n">prod</span><span class="o">-</span><span class="n">ceph</span><span class="o">-</span><span class="n">data1701</span>
</pre></div>
</div>
<p>Note that most Linux distributions that Ceph supports today employ <code class="docutils literal notranslate"><span class="pre">systemd</span></code>
for service management.  For other or older operating systems you may need
to issue equivalent <code class="docutils literal notranslate"><span class="pre">service</span></code> or <code class="docutils literal notranslate"><span class="pre">start</span></code>/<code class="docutils literal notranslate"><span class="pre">stop</span></code> commands.</p>
</section>
<section id="osd-not-running">
<span id="id1"></span><h2>OSD Not Running<a class="headerlink" href="#osd-not-running" title="Permalink to this heading">¶</a></h2>
<p>Under normal circumstances, simply restarting the <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> daemon will
allow it to rejoin the cluster and recover.</p>
<section id="an-osd-won-t-start">
<h3>An OSD Won’t Start<a class="headerlink" href="#an-osd-won-t-start" title="Permalink to this heading">¶</a></h3>
<p>If you start your cluster and an OSD won’t start, check the following:</p>
<ul>
<li><p><strong>Configuration File:</strong> If you were not able to get OSDs running from
a new installation, check your configuration file to ensure it conforms
(e.g., <code class="docutils literal notranslate"><span class="pre">host</span></code> not <code class="docutils literal notranslate"><span class="pre">hostname</span></code>, etc.).</p></li>
<li><p><strong>Check Paths:</strong> Check the paths in your configuration, and the actual
paths themselves for data and metadata (journals, WAL, DB). If you separate the OSD data from
the metadata and there are errors in your configuration file or in the
actual mounts, you may have trouble starting OSDs. If you want to store the
metadata on a separate block device, you should partition or LVM your
drive and assign one partition per OSD.</p></li>
<li><p><strong>Check Max Threadcount:</strong> If you have a node with a lot of OSDs, you may be
hitting the default maximum number of threads (e.g., usually 32k), especially
during recovery. You can increase the number of threads using <code class="docutils literal notranslate"><span class="pre">sysctl</span></code> to
see if increasing the maximum number of threads to the maximum possible
number of threads allowed (i.e.,  4194303) will help. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sysctl</span> <span class="o">-</span><span class="n">w</span> <span class="n">kernel</span><span class="o">.</span><span class="n">pid_max</span><span class="o">=</span><span class="mi">4194303</span>
</pre></div>
</div>
<p>If increasing the maximum thread count resolves the issue, you can make it
permanent by including a <code class="docutils literal notranslate"><span class="pre">kernel.pid_max</span></code> setting in a file under <code class="docutils literal notranslate"><span class="pre">/etc/sysctl.d</span></code> or
within the master <code class="docutils literal notranslate"><span class="pre">/etc/sysctl.conf</span></code> file. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span><span class="o">.</span><span class="n">pid_max</span> <span class="o">=</span> <span class="mi">4194303</span>
</pre></div>
</div>
</li>
<li><p><strong>Check ``nf_conntrack``:</strong> This connection tracking and limiting system
is the bane of many production Ceph clusters, and can be insidious in that
everything is fine at first. As cluster topology and client workload
grow, mysterious and intermittent connection failures and performance
glitches manifest, becoming worse over time and at certain times of day.
Check <code class="docutils literal notranslate"><span class="pre">syslog</span></code> history for table fillage events.  You can mitigate this
bother by raising <code class="docutils literal notranslate"><span class="pre">nf_conntrack_max</span></code> to a much higher value via <code class="docutils literal notranslate"><span class="pre">sysctl</span></code>.
Be sure to raise <code class="docutils literal notranslate"><span class="pre">nf_conntrack_buckets</span></code> accordingly to
<code class="docutils literal notranslate"><span class="pre">nf_conntrack_max</span> <span class="pre">/</span> <span class="pre">4</span></code>, which may require action outside of <code class="docutils literal notranslate"><span class="pre">sysctl</span></code> e.g.
<code class="docutils literal notranslate"><span class="pre">&quot;echo</span> <span class="pre">131072</span> <span class="pre">&gt;</span> <span class="pre">/sys/module/nf_conntrack/parameters/hashsize</span></code>
More interdictive but fussier is to blacklist the associated kernel modules
to disable processing altogether.  This is fragile in that the modules
vary among kernel versions, as does the order in which they must be listed.
Even when blacklisted there are situations in which <code class="docutils literal notranslate"><span class="pre">iptables</span></code> or <code class="docutils literal notranslate"><span class="pre">docker</span></code>
may activate connection tracking anyway, so a “set and forget” strategy for
the tunables is advised.  On modern systems this will not consume appreciable
resources.</p></li>
<li><p><strong>Kernel Version:</strong> Identify the kernel version and distribution you
are using. Ceph uses some third party tools by default, which may be
buggy or may conflict with certain distributions and/or kernel
versions (e.g., Google <code class="docutils literal notranslate"><span class="pre">gperftools</span></code> and <code class="docutils literal notranslate"><span class="pre">TCMalloc</span></code>). Check the
<a class="reference external" href="../../../start/os-recommendations">OS recommendations</a> and the release notes for each Ceph version
to ensure you have addressed any issues related to your kernel.</p></li>
<li><p><strong>Segment Fault:</strong> If there is a segment fault, increase log levels
and start the problematic daemon(s) again. If segment faults recur,
search the Ceph bug tracker <a class="reference external" href="https://tracker.ceph.com/projects/ceph/">https://tracker.ceph/com/projects/ceph</a>
and the <code class="docutils literal notranslate"><span class="pre">dev</span></code> and <code class="docutils literal notranslate"><span class="pre">ceph-users</span></code> mailing list archives <a class="reference external" href="https://ceph.io/resources">https://ceph.io/resources</a>.
If this is truly a new and unique
failure, post to the <code class="docutils literal notranslate"><span class="pre">dev</span></code> email list and provide the specific Ceph
release being run, <code class="docutils literal notranslate"><span class="pre">ceph.conf</span></code> (with secrets XXX’d out),
your monitor status output and excerpts from your log file(s).</p></li>
</ul>
</section>
<section id="an-osd-failed">
<h3>An OSD Failed<a class="headerlink" href="#an-osd-failed" title="Permalink to this heading">¶</a></h3>
<p>When a <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> process dies, surviving <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> daemons will report
to the mons that it appears down, which will in turn surface the new status
via the <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">health</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">health</span>
<span class="n">HEALTH_WARN</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="ow">in</span> <span class="n">osds</span> <span class="n">are</span> <span class="n">down</span>
</pre></div>
</div>
<p>Specifically, you will get a warning whenever there are OSDs marked <code class="docutils literal notranslate"><span class="pre">in</span></code>
and <code class="docutils literal notranslate"><span class="pre">down</span></code>.  You can identify which  are <code class="docutils literal notranslate"><span class="pre">down</span></code> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">health</span> <span class="n">detail</span>
<span class="n">HEALTH_WARN</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span> <span class="ow">in</span> <span class="n">osds</span> <span class="n">are</span> <span class="n">down</span>
<span class="n">osd</span><span class="mf">.0</span> <span class="ow">is</span> <span class="n">down</span> <span class="n">since</span> <span class="n">epoch</span> <span class="mi">23</span><span class="p">,</span> <span class="n">last</span> <span class="n">address</span> <span class="mf">192.168.106.220</span><span class="p">:</span><span class="mi">6800</span><span class="o">/</span><span class="mi">11080</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">tree</span> <span class="n">down</span>
</pre></div>
</div>
<p>If there is a drive
failure or other fault preventing <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> from functioning or
restarting, an error message should be present in its log file under
<code class="docutils literal notranslate"><span class="pre">/var/log/ceph</span></code>.</p>
<p>If the daemon stopped because of a heartbeat failure or <code class="docutils literal notranslate"><span class="pre">suicide</span> <span class="pre">timeout</span></code>,
the underlying drive or filesystem may be unresponsive. Check <code class="docutils literal notranslate"><span class="pre">dmesg</span></code>
and <cite>syslog</cite>  output for drive or other kernel errors.  You may need to
specify something like <code class="docutils literal notranslate"><span class="pre">dmesg</span> <span class="pre">-T</span></code> to get timestamps, otherwise it’s
easy to mistake old errors for new.</p>
<p>If the problem is a software error (failed assertion or other
unexpected error), search the archives and tracker as above, and
report it to the <a class="reference external" href="mailto:ceph-devel&#37;&#52;&#48;vger&#46;kernel&#46;org">ceph-devel</a> email list if there’s no clear fix or
existing bug.</p>
</section>
<section id="no-free-drive-space">
<span id="id2"></span><h3>No Free Drive Space<a class="headerlink" href="#no-free-drive-space" title="Permalink to this heading">¶</a></h3>
<p>Ceph prevents you from writing to a full OSD so that you don’t lose data.
In an operational cluster, you should receive a warning when your cluster’s OSDs
and pools approach the full ratio. The <code class="docutils literal notranslate"><span class="pre">mon</span> <span class="pre">osd</span> <span class="pre">full</span> <span class="pre">ratio</span></code> defaults to
<code class="docutils literal notranslate"><span class="pre">0.95</span></code>, or 95% of capacity before it stops clients from writing data.
The <code class="docutils literal notranslate"><span class="pre">mon</span> <span class="pre">osd</span> <span class="pre">backfillfull</span> <span class="pre">ratio</span></code> defaults to <code class="docutils literal notranslate"><span class="pre">0.90</span></code>, or 90 % of
capacity above which backfills will not start. The
OSD nearfull ratio defaults to <code class="docutils literal notranslate"><span class="pre">0.85</span></code>, or 85% of capacity
when it generates a health warning.</p>
<p>Note that individual OSDs within a cluster will vary in how much data Ceph
allocates to them.  This utilization can be displayed for each OSD with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">df</span>
</pre></div>
</div>
<p>Overall cluster / pool fullness can be checked with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">df</span>
</pre></div>
</div>
<p>Pay close attention to the <strong>most full</strong> OSDs, not the percentage of raw space
used as reported by <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">df</span></code>.  It only takes one outlier OSD filling up to
fail writes to its pool.  The space available to each pool as reported by
<code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">df</span></code> considers the ratio settings relative to the <em>most full</em> OSD that
is part of a given pool.  The distribution can be flattened by progressively
moving data from overfull or to underfull OSDs using the <code class="docutils literal notranslate"><span class="pre">reweight-by-utilization</span></code>
command.  With Ceph releases beginning with later revisions of Luminous one can also
exploit the <code class="docutils literal notranslate"><span class="pre">ceph-mgr</span></code> <code class="docutils literal notranslate"><span class="pre">balancer</span></code> module to perform this task automatically
and rather effectively.</p>
<p>The ratios can be adjusted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set</span><span class="o">-</span><span class="n">nearfull</span><span class="o">-</span><span class="n">ratio</span> <span class="o">&lt;</span><span class="nb">float</span><span class="p">[</span><span class="mf">0.0</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">&gt;</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set</span><span class="o">-</span><span class="n">full</span><span class="o">-</span><span class="n">ratio</span> <span class="o">&lt;</span><span class="nb">float</span><span class="p">[</span><span class="mf">0.0</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">&gt;</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set</span><span class="o">-</span><span class="n">backfillfull</span><span class="o">-</span><span class="n">ratio</span> <span class="o">&lt;</span><span class="nb">float</span><span class="p">[</span><span class="mf">0.0</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Full cluster issues can arise when an OSD fails either as a test or organically
within small and/or very full or unbalanced cluster. When an OSD or node
holds an outsize percentage of the cluster’s data, the <code class="docutils literal notranslate"><span class="pre">nearfull</span></code> and <code class="docutils literal notranslate"><span class="pre">full</span></code>
ratios may be exceeded as a result of component failures or even natural growth.
If you are testing how Ceph reacts to OSD failures on a small
cluster, you should leave ample free disk space and consider temporarily
lowering the OSD <code class="docutils literal notranslate"><span class="pre">full</span> <span class="pre">ratio</span></code>, OSD <code class="docutils literal notranslate"><span class="pre">backfillfull</span> <span class="pre">ratio</span></code> and
OSD <code class="docutils literal notranslate"><span class="pre">nearfull</span> <span class="pre">ratio</span></code></p>
<p>Full <code class="docutils literal notranslate"><span class="pre">ceph-osds</span></code> will be reported by <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">health</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">health</span>
<span class="n">HEALTH_WARN</span> <span class="mi">1</span> <span class="n">nearfull</span> <span class="n">osd</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">health</span> <span class="n">detail</span>
<span class="n">HEALTH_ERR</span> <span class="mi">1</span> <span class="n">full</span> <span class="n">osd</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="mi">1</span> <span class="n">backfillfull</span> <span class="n">osd</span><span class="p">(</span><span class="n">s</span><span class="p">);</span> <span class="mi">1</span> <span class="n">nearfull</span> <span class="n">osd</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">osd</span><span class="mf">.3</span> <span class="ow">is</span> <span class="n">full</span> <span class="n">at</span> <span class="mi">97</span><span class="o">%</span>
<span class="n">osd</span><span class="mf">.4</span> <span class="ow">is</span> <span class="n">backfill</span> <span class="n">full</span> <span class="n">at</span> <span class="mi">91</span><span class="o">%</span>
<span class="n">osd</span><span class="mf">.2</span> <span class="ow">is</span> <span class="n">near</span> <span class="n">full</span> <span class="n">at</span> <span class="mi">87</span><span class="o">%</span>
</pre></div>
</div>
<p>The best way to deal with a full cluster is to add capacity via new OSDs, enabling
the cluster to redistribute data to newly available storage.</p>
<p>If you cannot start a legacy Filestore OSD because it is full, you may reclaim
some space deleting a few placement group directories in the full OSD.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you choose to delete a placement group directory on a full OSD,
<strong>DO NOT</strong> delete the same placement group directory on another full OSD, or
<strong>YOU WILL LOSE DATA</strong>. You <strong>MUST</strong> maintain at least one copy of your data on
at least one OSD.  This is a rare and extreme intervention, and is not to be
undertaken lightly.</p>
</div>
<p>See <a class="reference external" href="../../configuration/mon-config-ref">Monitor Config Reference</a> for additional details.</p>
</section>
</section>
<section id="osds-are-slow-unresponsive">
<h2>OSDs are Slow/Unresponsive<a class="headerlink" href="#osds-are-slow-unresponsive" title="Permalink to this heading">¶</a></h2>
<p>A common issue involves slow or unresponsive OSDs. Ensure that you
have eliminated other troubleshooting possibilities before delving into OSD
performance issues. For example, ensure that your network(s) is working properly
and your OSDs are running. Check to see if OSDs are throttling recovery traffic.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Newer versions of Ceph provide better recovery handling by preventing
recovering OSDs from using up system resources so that <code class="docutils literal notranslate"><span class="pre">up</span></code> and <code class="docutils literal notranslate"><span class="pre">in</span></code>
OSDs are not available or are otherwise slow.</p>
</div>
<section id="networking-issues">
<h3>Networking Issues<a class="headerlink" href="#networking-issues" title="Permalink to this heading">¶</a></h3>
<p>Ceph is a distributed storage system, so it relies upon networks for OSD peering
and replication, recovery from faults, and periodic heartbeats. Networking
issues can cause OSD latency and flapping OSDs. See <a class="reference internal" href="#flapping-osds">Flapping OSDs</a> for
details.</p>
<p>Ensure that Ceph processes and Ceph-dependent processes are connected and/or
listening.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netstat</span> <span class="o">-</span><span class="n">a</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">ceph</span>
<span class="n">netstat</span> <span class="o">-</span><span class="n">l</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">ceph</span>
<span class="n">sudo</span> <span class="n">netstat</span> <span class="o">-</span><span class="n">p</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">ceph</span>
</pre></div>
</div>
<p>Check network statistics.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netstat</span> <span class="o">-</span><span class="n">s</span>
</pre></div>
</div>
</section>
<section id="drive-configuration">
<h3>Drive Configuration<a class="headerlink" href="#drive-configuration" title="Permalink to this heading">¶</a></h3>
<p>A SAS or SATA storage drive should only house one OSD; NVMe drives readily
handle two or more. Read and write throughput can bottleneck if other processes
share the drive, including journals / metadata, operating systems, Ceph monitors,
<cite>syslog</cite> logs, other OSDs, and non-Ceph processes.</p>
<p>Ceph acknowledges writes <em>after</em> journaling, so fast SSDs are an
attractive option to accelerate the response time–particularly when
using the <code class="docutils literal notranslate"><span class="pre">XFS</span></code> or <code class="docutils literal notranslate"><span class="pre">ext4</span></code> file systems for legacy Filestore OSDs.
By contrast, the <code class="docutils literal notranslate"><span class="pre">Btrfs</span></code>
file system can write and journal simultaneously.  (Note, however, that
we recommend against using <code class="docutils literal notranslate"><span class="pre">Btrfs</span></code> for production deployments.)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Partitioning a drive does not change its total throughput or
sequential read/write limits. Running a journal in a separate partition
may help, but you should prefer a separate physical drive.</p>
</div>
</section>
<section id="bad-sectors-fragmented-disk">
<h3>Bad Sectors / Fragmented Disk<a class="headerlink" href="#bad-sectors-fragmented-disk" title="Permalink to this heading">¶</a></h3>
<p>Check your drives for bad blocks, fragmentation, and other errors that can cause
performance to drop substantially.  Invaluable tools include <code class="docutils literal notranslate"><span class="pre">dmesg</span></code>, <code class="docutils literal notranslate"><span class="pre">syslog</span></code>
logs, and <code class="docutils literal notranslate"><span class="pre">smartctl</span></code> (from the <code class="docutils literal notranslate"><span class="pre">smartmontools</span></code> package).</p>
</section>
<section id="co-resident-monitors-osds">
<h3>Co-resident Monitors/OSDs<a class="headerlink" href="#co-resident-monitors-osds" title="Permalink to this heading">¶</a></h3>
<p>Monitors are relatively lightweight processes, but they issue lots of
<code class="docutils literal notranslate"><span class="pre">fsync()</span></code> calls,
which can interfere with other workloads, particularly if monitors run on the
same drive as an OSD. Additionally, if you run monitors on the same host as
OSDs, you may incur performance issues related to:</p>
<ul class="simple">
<li><p>Running an older kernel (pre-3.0)</p></li>
<li><p>Running a kernel with no <code class="docutils literal notranslate"><span class="pre">syncfs(2)</span></code> syscall.</p></li>
</ul>
<p>In these cases, multiple OSDs running on the same host can drag each other down
by doing lots of commits. That often leads to the bursty writes.</p>
</section>
<section id="co-resident-processes">
<h3>Co-resident Processes<a class="headerlink" href="#co-resident-processes" title="Permalink to this heading">¶</a></h3>
<p>Spinning up co-resident processes (convergence) such as a cloud-based solution, virtual
machines and other applications that write data to Ceph while operating on the
same hardware as OSDs can introduce significant OSD latency. Generally, we
recommend optimizing hosts for use with Ceph and using other hosts for other
processes. The practice of separating Ceph operations from other applications
may help improve performance and may streamline troubleshooting and maintenance.</p>
</section>
<section id="logging-levels">
<h3>Logging Levels<a class="headerlink" href="#logging-levels" title="Permalink to this heading">¶</a></h3>
<p>If you turned logging levels up to track an issue and then forgot to turn
logging levels back down, the OSD may be putting a lot of logs onto the disk. If
you intend to keep logging levels high, you may consider mounting a drive to the
default path for logging (i.e., <code class="docutils literal notranslate"><span class="pre">/var/log/ceph/$cluster-$name.log</span></code>).</p>
</section>
<section id="recovery-throttling">
<h3>Recovery Throttling<a class="headerlink" href="#recovery-throttling" title="Permalink to this heading">¶</a></h3>
<p>Depending upon your configuration, Ceph may reduce recovery rates to maintain
performance or it may increase recovery rates to the point that recovery
impacts OSD performance. Check to see if the OSD is recovering.</p>
</section>
<section id="kernel-version">
<h3>Kernel Version<a class="headerlink" href="#kernel-version" title="Permalink to this heading">¶</a></h3>
<p>Check the kernel version you are running. Older kernels may not receive
new backports that Ceph depends upon for better performance.</p>
</section>
<section id="kernel-issues-with-syncfs">
<h3>Kernel Issues with SyncFS<a class="headerlink" href="#kernel-issues-with-syncfs" title="Permalink to this heading">¶</a></h3>
<p>Try running one OSD per host to see if performance improves. Old kernels
might not have a recent enough version of <code class="docutils literal notranslate"><span class="pre">glibc</span></code> to support <code class="docutils literal notranslate"><span class="pre">syncfs(2)</span></code>.</p>
</section>
<section id="filesystem-issues">
<h3>Filesystem Issues<a class="headerlink" href="#filesystem-issues" title="Permalink to this heading">¶</a></h3>
<p>Currently, we recommend deploying clusters with the BlueStore back end.
When running a pre-Luminous release or if you have a specific reason to deploy
OSDs with the previous Filestore backend, we recommend <code class="docutils literal notranslate"><span class="pre">XFS</span></code>.</p>
<p>We recommend against using <code class="docutils literal notranslate"><span class="pre">Btrfs</span></code> or <code class="docutils literal notranslate"><span class="pre">ext4</span></code>.  The <code class="docutils literal notranslate"><span class="pre">Btrfs</span></code> filesystem has
many attractive features, but bugs may lead to
performance issues and spurious ENOSPC errors.  We do not recommend
<code class="docutils literal notranslate"><span class="pre">ext4</span></code> for Filestore OSDs because <code class="docutils literal notranslate"><span class="pre">xattr</span></code> limitations break support for long
object names, which are needed for RGW.</p>
<p>For more information, see <a class="reference external" href="../configuration/filesystem-recommendations">Filesystem Recommendations</a>.</p>
</section>
<section id="insufficient-ram">
<h3>Insufficient RAM<a class="headerlink" href="#insufficient-ram" title="Permalink to this heading">¶</a></h3>
<p>We recommend a <em>minimum</em> of 4GB of RAM per OSD daemon and suggest rounding up
from 6-8GB.  You may notice that during normal operations, <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code>
processes only use a fraction of that amount.
Unused RAM makes it tempting to use the excess RAM for co-resident
applications or to skimp on each node’s memory capacity.  However,
when OSDs experience recovery their memory utilization spikes. If
there is insufficient RAM available, OSD performance will slow considerably
and the daemons may even crash or be killed by the Linux <code class="docutils literal notranslate"><span class="pre">OOM</span> <span class="pre">Killer</span></code>.</p>
</section>
<section id="blocked-requests-or-slow-requests">
<h3>Blocked Requests or Slow Requests<a class="headerlink" href="#blocked-requests-or-slow-requests" title="Permalink to this heading">¶</a></h3>
<p>If a <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> daemon is slow to respond to a request, messages will be logged
noting ops that are taking too long.  The warning threshold
defaults to 30 seconds and is configurable via the <code class="docutils literal notranslate"><span class="pre">osd</span> <span class="pre">op</span> <span class="pre">complaint</span> <span class="pre">time</span></code>
setting.  When this happens, the cluster log will receive messages.</p>
<p>Legacy versions of Ceph complain about <code class="docutils literal notranslate"><span class="pre">old</span> <span class="pre">requests</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">osd</span><span class="mf">.0</span> <span class="mf">192.168.106.220</span><span class="p">:</span><span class="mi">6800</span><span class="o">/</span><span class="mi">18813</span> <span class="mi">312</span> <span class="p">:</span> <span class="p">[</span><span class="n">WRN</span><span class="p">]</span> <span class="n">old</span> <span class="n">request</span> <span class="n">osd_op</span><span class="p">(</span><span class="n">client</span><span class="mf">.5099.0</span><span class="p">:</span><span class="mi">790</span> <span class="n">fatty_26485_object789</span> <span class="p">[</span><span class="n">write</span> <span class="mi">0</span><span class="o">~</span><span class="mi">4096</span><span class="p">]</span> <span class="mf">2.5e54</span><span class="n">f643</span><span class="p">)</span> <span class="n">v4</span> <span class="n">received</span> <span class="n">at</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">06</span> <span class="mi">15</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mf">56.054801</span> <span class="n">currently</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">sub</span> <span class="n">ops</span>
</pre></div>
</div>
<p>New versions of Ceph complain about <code class="docutils literal notranslate"><span class="pre">slow</span> <span class="pre">requests</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">date</span><span class="p">}</span> <span class="p">{</span><span class="n">osd</span><span class="o">.</span><span class="n">num</span><span class="p">}</span> <span class="p">[</span><span class="n">WRN</span><span class="p">]</span> <span class="mi">1</span> <span class="n">slow</span> <span class="n">requests</span><span class="p">,</span> <span class="mi">1</span> <span class="n">included</span> <span class="n">below</span><span class="p">;</span> <span class="n">oldest</span> <span class="n">blocked</span> <span class="k">for</span> <span class="o">&gt;</span> <span class="mf">30.005692</span> <span class="n">secs</span>
<span class="p">{</span><span class="n">date</span><span class="p">}</span> <span class="p">{</span><span class="n">osd</span><span class="o">.</span><span class="n">num</span><span class="p">}</span>  <span class="p">[</span><span class="n">WRN</span><span class="p">]</span> <span class="n">slow</span> <span class="n">request</span> <span class="mf">30.005692</span> <span class="n">seconds</span> <span class="n">old</span><span class="p">,</span> <span class="n">received</span> <span class="n">at</span> <span class="p">{</span><span class="n">date</span><span class="o">-</span><span class="n">time</span><span class="p">}:</span> <span class="n">osd_op</span><span class="p">(</span><span class="n">client</span><span class="mf">.4240.0</span><span class="p">:</span><span class="mi">8</span> <span class="n">benchmark_data_ceph</span><span class="o">-</span><span class="mi">1_39426</span><span class="n">_object7</span> <span class="p">[</span><span class="n">write</span> <span class="mi">0</span><span class="o">~</span><span class="mi">4194304</span><span class="p">]</span> <span class="mf">0.69848840</span><span class="p">)</span> <span class="n">v4</span> <span class="n">currently</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">subops</span> <span class="kn">from</span><span class="w"> </span><span class="p">[</span><span class="mi">610</span><span class="p">]</span>
</pre></div>
</div>
<p>Possible causes include:</p>
<ul class="simple">
<li><p>A failing drive (check <code class="docutils literal notranslate"><span class="pre">dmesg</span></code> output)</p></li>
<li><p>A bug in the kernel file system (check <code class="docutils literal notranslate"><span class="pre">dmesg</span></code> output)</p></li>
<li><p>An overloaded cluster (check system load, iostat, etc.)</p></li>
<li><p>A bug in the <code class="docutils literal notranslate"><span class="pre">ceph-osd</span></code> daemon.</p></li>
</ul>
<p>Possible solutions:</p>
<ul class="simple">
<li><p>Remove VMs from Ceph hosts</p></li>
<li><p>Upgrade kernel</p></li>
<li><p>Upgrade Ceph</p></li>
<li><p>Restart OSDs</p></li>
<li><p>Replace failed or failing components</p></li>
</ul>
</section>
<section id="debugging-slow-requests">
<h3>Debugging Slow Requests<a class="headerlink" href="#debugging-slow-requests" title="Permalink to this heading">¶</a></h3>
<p>If you run <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">daemon</span> <span class="pre">osd.&lt;id&gt;</span> <span class="pre">dump_historic_ops</span></code> or <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">daemon</span> <span class="pre">osd.&lt;id&gt;</span> <span class="pre">dump_ops_in_flight</span></code>,
you will see a set of operations and a list of events each operation went
through. These are briefly described below.</p>
<p>Events from the Messenger layer:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">header_read</span></code>: When the messenger first started reading the message off the wire.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">throttled</span></code>: When the messenger tried to acquire memory throttle space to read
the message into memory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_read</span></code>: When the messenger finished reading the message off the wire.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dispatched</span></code>: When the messenger gave the message to the OSD.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">initiated</span></code>: This is identical to <code class="docutils literal notranslate"><span class="pre">header_read</span></code>. The existence of both is a
historical oddity.</p></li>
</ul>
<p>Events from the OSD as it processes ops:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">queued_for_pg</span></code>: The op has been put into the queue for processing by its PG.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reached_pg</span></code>: The PG has started doing the op.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">waiting</span> <span class="pre">for</span> <span class="pre">\*</span></code>: The op is waiting for some other work to complete before it
can proceed (e.g. a new OSDMap; for its object target to scrub; for the PG to
finish peering; all as specified in the message).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">started</span></code>: The op has been accepted as something the OSD should do and
is now being performed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">waiting</span> <span class="pre">for</span> <span class="pre">subops</span> <span class="pre">from</span></code>: The op has been sent to replica OSDs.</p></li>
</ul>
<p>Events from <code class="docutils literal notranslate"><span class="pre">`Filestore`</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">commit_queued_for_journal_write</span></code>: The op has been given to the FileStore.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">write_thread_in_journal_buffer</span></code>: The op is in the journal’s buffer and waiting
to be persisted (as the next disk write).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">journaled_completion_queued</span></code>: The op was journaled to disk and its callback
queued for invocation.</p></li>
</ul>
<p>Events from the OSD after data has been given to underlying storage:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">op_commit</span></code>: The op has been committed (i.e. written to journal) by the
primary OSD.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">op_applied</span></code>: The op has been <a class="reference external" href="https://www.freebsd.org/cgi/man.cgi?write(2)">write()’en</a> to the backing FS (i.e.   applied in memory but not flushed out to disk) on the primary.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sub_op_applied</span></code>: <code class="docutils literal notranslate"><span class="pre">op_applied</span></code>, but for a replica’s “subop”.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sub_op_committed</span></code>: <code class="docutils literal notranslate"><span class="pre">op_commit</span></code>, but for a replica’s subop (only for EC pools).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sub_op_commit_rec/sub_op_apply_rec</span> <span class="pre">from</span> <span class="pre">&lt;X&gt;</span></code>: The primary marks this when it
hears about the above, but for a particular replica (i.e. <code class="docutils literal notranslate"><span class="pre">&lt;X&gt;</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">commit_sent</span></code>: We sent a reply back to the client (or primary OSD, for sub ops).</p></li>
</ul>
<p>Many of these events are seemingly redundant, but cross important boundaries in
the internal code (such as passing data across locks into new threads).</p>
</section>
</section>
<section id="flapping-osds">
<h2>Flapping OSDs<a class="headerlink" href="#flapping-osds" title="Permalink to this heading">¶</a></h2>
<p>When OSDs peer and check heartbeats, they use the cluster (back-end)
network when it’s available. See <a class="reference external" href="../../configuration/mon-osd-interaction">Monitor/OSD Interaction</a> for details.</p>
<p>We have tradtionally recommended separate <em>public</em> (front-end) and <em>private</em>
(cluster / back-end / replication) networks:</p>
<ol class="arabic simple">
<li><p>Segregation of heartbeat and replication / recovery traffic (private)
from client and OSD &lt;-&gt; mon traffic (public).  This helps keep one
from DoS-ing the other, which could in turn result in a cascading failure.</p></li>
<li><p>Additional throughput for both public and private traffic.</p></li>
</ol>
<p>When common networking technloogies were 100Mb/s and 1Gb/s, this separation
was often critical.  With today’s 10Gb/s, 40Gb/s, and 25/50/100Gb/s
networks, the above capacity concerns are often diminished or even obviated.
For example, if your OSD nodes have two network ports, dedicating one to
the public and the other to the private network means no path redundancy.
This degrades your ability to weather network maintenance and failures without
significant cluster or client impact.  Consider instead using both links
for just a public network:  with bonding (LACP) or equal-cost routing (e.g. FRR)
you reap the benefits of increased throughput headroom, fault tolerance, and
reduced OSD flapping.</p>
<p>When a private network (or even a single host link) fails or degrades while the
public network operates normally, OSDs may not handle this situation well. What
happens is that OSDs use the public network to report each other <code class="docutils literal notranslate"><span class="pre">down</span></code> to
the monitors, while marking themselves <code class="docutils literal notranslate"><span class="pre">up</span></code>. The monitors then send out,
again on the public network, an updated cluster map with affected OSDs marked
<cite>down</cite>. These OSDs reply to the monitors “I’m not dead yet!”, and the cycle
repeats.  We call this scenario ‘flapping`, and it can be difficult to isolate
and remediate.  With no private network, this irksome dynamic is avoided:
OSDs are generally either <code class="docutils literal notranslate"><span class="pre">up</span></code> or <code class="docutils literal notranslate"><span class="pre">down</span></code> without flapping.</p>
<p>If something does cause OSDs to ‘flap’ (repeatedly getting marked <code class="docutils literal notranslate"><span class="pre">down</span></code> and
then <code class="docutils literal notranslate"><span class="pre">up</span></code> again), you can force the monitors to halt the flapping by
temporarily freezing their states:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set</span> <span class="n">noup</span>      <span class="c1"># prevent OSDs from getting marked up</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="nb">set</span> <span class="n">nodown</span>    <span class="c1"># prevent OSDs from getting marked down</span>
</pre></div>
</div>
<p>These flags are recorded in the osdmap:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">dump</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">flags</span>
<span class="n">flags</span> <span class="n">no</span><span class="o">-</span><span class="n">up</span><span class="p">,</span><span class="n">no</span><span class="o">-</span><span class="n">down</span>
</pre></div>
</div>
<p>You can clear the flags with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ceph</span> <span class="n">osd</span> <span class="n">unset</span> <span class="n">noup</span>
<span class="n">ceph</span> <span class="n">osd</span> <span class="n">unset</span> <span class="n">nodown</span>
</pre></div>
</div>
<p>Two other flags are supported, <code class="docutils literal notranslate"><span class="pre">noin</span></code> and <code class="docutils literal notranslate"><span class="pre">noout</span></code>, which prevent
booting OSDs from being marked <code class="docutils literal notranslate"><span class="pre">in</span></code> (allocated data) or protect OSDs
from eventually being marked <code class="docutils literal notranslate"><span class="pre">out</span></code> (regardless of what the current value for
<code class="docutils literal notranslate"><span class="pre">mon</span> <span class="pre">osd</span> <span class="pre">down</span> <span class="pre">out</span> <span class="pre">interval</span></code> is).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">noup</span></code>, <code class="docutils literal notranslate"><span class="pre">noout</span></code>, and <code class="docutils literal notranslate"><span class="pre">nodown</span></code> are temporary in the
sense that once the flags are cleared, the action they were blocking
should occur shortly after.  The <code class="docutils literal notranslate"><span class="pre">noin</span></code> flag, on the other hand,
prevents OSDs from being marked <code class="docutils literal notranslate"><span class="pre">in</span></code> on boot, and any daemons that
started while the flag was set will remain that way.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The causes and effects of flapping can be somewhat mitigated through
careful adjustments to the <code class="docutils literal notranslate"><span class="pre">mon_osd_down_out_subtree_limit</span></code>,
<code class="docutils literal notranslate"><span class="pre">mon_osd_reporter_subtree_level</span></code>, and <code class="docutils literal notranslate"><span class="pre">mon_osd_min_down_reporters</span></code>.
Derivation of optimal settings depends on cluster size, topology, and the
Ceph  release in use. Their interactions are subtle and beyond the scope of
this document.</p>
</div>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../">
              <img class="logo" src="../../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cephadm/">Cephadm</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../">Ceph Storage Cluster</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../configuration/">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cephadm/">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/">Man Pages</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">Troubleshooting</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../community/">The Ceph Community</a></li>
<li class="toctree-l3"><a class="reference internal" href="../log-and-debug/">Logging and Debugging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting-mon/">Troubleshooting Monitors</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Troubleshooting OSDs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#obtaining-data-about-osds">Obtaining Data About OSDs</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#ceph-logs">Ceph Logs</a></li>
<li class="toctree-l5"><a class="reference internal" href="#admin-socket">Admin Socket</a></li>
<li class="toctree-l5"><a class="reference internal" href="#display-freespace">Display Freespace</a></li>
<li class="toctree-l5"><a class="reference internal" href="#i-o-statistics">I/O Statistics</a></li>
<li class="toctree-l5"><a class="reference internal" href="#diagnostic-messages">Diagnostic Messages</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#stopping-w-out-rebalancing">Stopping w/out Rebalancing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#osd-not-running">OSD Not Running</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#an-osd-won-t-start">An OSD Won’t Start</a></li>
<li class="toctree-l5"><a class="reference internal" href="#an-osd-failed">An OSD Failed</a></li>
<li class="toctree-l5"><a class="reference internal" href="#no-free-drive-space">No Free Drive Space</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#osds-are-slow-unresponsive">OSDs are Slow/Unresponsive</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#networking-issues">Networking Issues</a></li>
<li class="toctree-l5"><a class="reference internal" href="#drive-configuration">Drive Configuration</a></li>
<li class="toctree-l5"><a class="reference internal" href="#bad-sectors-fragmented-disk">Bad Sectors / Fragmented Disk</a></li>
<li class="toctree-l5"><a class="reference internal" href="#co-resident-monitors-osds">Co-resident Monitors/OSDs</a></li>
<li class="toctree-l5"><a class="reference internal" href="#co-resident-processes">Co-resident Processes</a></li>
<li class="toctree-l5"><a class="reference internal" href="#logging-levels">Logging Levels</a></li>
<li class="toctree-l5"><a class="reference internal" href="#recovery-throttling">Recovery Throttling</a></li>
<li class="toctree-l5"><a class="reference internal" href="#kernel-version">Kernel Version</a></li>
<li class="toctree-l5"><a class="reference internal" href="#kernel-issues-with-syncfs">Kernel Issues with SyncFS</a></li>
<li class="toctree-l5"><a class="reference internal" href="#filesystem-issues">Filesystem Issues</a></li>
<li class="toctree-l5"><a class="reference internal" href="#insufficient-ram">Insufficient RAM</a></li>
<li class="toctree-l5"><a class="reference internal" href="#blocked-requests-or-slow-requests">Blocked Requests or Slow Requests</a></li>
<li class="toctree-l5"><a class="reference internal" href="#debugging-slow-requests">Debugging Slow Requests</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="#flapping-osds">Flapping OSDs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting-pg/">Troubleshooting PGs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../memory-profiling/">Memory Profiling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cpu-profiling/">CPU Profiling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/">APIs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cephfs/">Ceph File System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../troubleshooting-pg/" title="Troubleshooting PGs"
             >next</a> |</li>
        <li class="right" >
          <a href="../troubleshooting-mon/" title="Troubleshooting Monitors"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../" >Ceph Storage Cluster</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../operations/" >Cluster Operations</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Troubleshooting OSDs</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>