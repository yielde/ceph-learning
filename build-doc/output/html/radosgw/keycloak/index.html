
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Integrating Keycloak with RadosGW &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Session tags for Attribute Based Access Control in STS" href="../session-tags/" />
    <link rel="prev" title="STS Lite" href="../STSLite/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../session-tags/" title="Session tags for Attribute Based Access Control in STS"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../STSLite/" title="STS Lite"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Ceph Object Gateway</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Integrating Keycloak with RadosGW</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="integrating-keycloak-with-radosgw">
<span id="radosgw-keycloak"></span><h1>Integrating Keycloak with RadosGW<a class="headerlink" href="#integrating-keycloak-with-radosgw" title="Permalink to this heading">¶</a></h1>
<p>If Keycloak is set up as an OpenID Connect Identity Provider, it can be used by
mobile apps and web apps to authenticate their users. By using the web token
returned by the authentication process, a mobile app or web app can call
AssumeRoleWithWebIdentity, receive a set of temporary S3 credentials, and use
those credentials to make S3 calls.</p>
<section id="setting-up-keycloak">
<h2>Setting up Keycloak<a class="headerlink" href="#setting-up-keycloak" title="Permalink to this heading">¶</a></h2>
<p>Documentation for installing and operating Keycloak can be found here:
<a class="reference external" href="https://www.keycloak.org/guides">https://www.keycloak.org/guides</a>.</p>
</section>
<section id="configuring-keycloak-to-talk-to-rgw">
<h2>Configuring Keycloak to talk to RGW<a class="headerlink" href="#configuring-keycloak-to-talk-to-rgw" title="Permalink to this heading">¶</a></h2>
<p>To configure Keycloak to talk to RGW, add the following configurables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">client</span><span class="o">.</span><span class="n">radosgw</span><span class="o">.</span><span class="n">gateway</span><span class="p">]</span>
<span class="n">rgw</span> <span class="n">sts</span> <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="n">sts</span> <span class="n">key</span> <span class="k">for</span> <span class="n">encrypting</span><span class="o">/</span> <span class="n">decrypting</span> <span class="n">the</span> <span class="n">session</span> <span class="n">token</span><span class="p">}</span>
<span class="n">rgw</span> <span class="n">s3</span> <span class="n">auth</span> <span class="n">use</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
</section>
<section id="fetching-a-web-token-with-keycloak">
<h2>Fetching a web token with Keycloak<a class="headerlink" href="#fetching-a-web-token-with-keycloak" title="Permalink to this heading">¶</a></h2>
<p>Several examples of apps authenticating with Keycloak can be found here:
<a class="reference external" href="https://github.com/keycloak/keycloak-quickstarts/blob/latest/docs/getting-started.md">https://github.com/keycloak/keycloak-quickstarts/blob/latest/docs/getting-started.md</a>.</p>
<p>Here you might consider the example of the app-profile-jee-jsp app (in the link
above). To fetch the access token (web token) for such an application using the
grant type ‘client_credentials’, one can use client id and client secret as
follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>KC_REALM=demo
KC_CLIENT=&lt;client id&gt;
KC_CLIENT_SECRET=&lt;client secret&gt;
KC_SERVER=&lt;host&gt;:8080
KC_CONTEXT=auth

# Request Tokens for credentials
KC_RESPONSE=$( \
curl -k -v -X POST \
-H &quot;Content-Type: application/x-www-form-urlencoded&quot; \
-d &quot;scope=openid&quot; \
-d &quot;grant_type=client_credentials&quot; \
-d &quot;client_id=$KC_CLIENT&quot; \
-d &quot;client_secret=$KC_CLIENT_SECRET&quot; \
&quot;http://$KC_SERVER/$KC_CONTEXT/realms/$KC_REALM/protocol/openid-connect/token&quot; \
| jq .
)

KC_ACCESS_TOKEN=$(echo $KC_RESPONSE| jq -r .access_token)
</pre></div>
</div>
<p>It is also possible to fetch an access token for a particular user with the
grant type ‘password’. To fetch such an access token, use client id, client
secret, username, and password as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> KC_REALM=demo
 KC_USERNAME=&lt;username&gt;
 KC_PASSWORD=&lt;userpassword&gt;
 KC_CLIENT=&lt;client id&gt;
 KC_CLIENT_SECRET=&lt;client secret&gt;
 KC_SERVER=&lt;host&gt;:8080
 KC_CONTEXT=auth

# Request Tokens for credentials
 KC_RESPONSE=$( \
 curl -k -v -X POST \
 -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \
 -d &quot;scope=openid&quot; \
 -d &quot;grant_type=password&quot; \
 -d &quot;client_id=$KC_CLIENT&quot; \
 -d &quot;client_secret=$KC_CLIENT_SECRET&quot; \
 -d &quot;username=$KC_USERNAME&quot; \
 -d &quot;password=$KC_PASSWORD&quot; \
 &quot;http://$KC_SERVER/$KC_CONTEXT/realms/$KC_REALM/protocol/openid-connect/token&quot; \
 | jq .
 )

 KC_ACCESS_TOKEN=$(echo $KC_RESPONSE| jq -r .access_token)
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">KC_ACCESS_TOKEN</span></code> can be used to invoke <code class="docutils literal notranslate"><span class="pre">AssumeRoleWithWebIdentity</span></code>: see
<a class="reference internal" href="../STS/"><span class="doc">STS in Ceph</span></a>.</p>
</section>
<section id="adding-tags-to-a-user-in-keycloak">
<h2>Adding tags to a user in Keycloak<a class="headerlink" href="#adding-tags-to-a-user-in-keycloak" title="Permalink to this heading">¶</a></h2>
<p>To create a user in Keycloak and add tags to it as its attributes, follow these
steps:</p>
<ol class="arabic">
<li><p>Add a user:</p>
<img alt="../../_images/keycloak-adduser.png" class="align-center" src="../../_images/keycloak-adduser.png" />
</li>
<li><p>Add user details:</p>
<img alt="../../_images/keycloak-userdetails.png" class="align-center" src="../../_images/keycloak-userdetails.png" />
</li>
<li><p>Add user credentials:</p>
<img alt="../../_images/keycloak-usercredentials.png" class="align-center" src="../../_images/keycloak-usercredentials.png" />
</li>
<li><p>Add tags to the ‘attributes’ tab of the user:</p>
<img alt="../../_images/keycloak-usertags.png" class="align-center" src="../../_images/keycloak-usertags.png" />
</li>
<li><p>Add a protocol mapper that maps the user attribute to a client:</p>
<img alt="../../_images/keycloak-userclientmapper.png" class="align-center" src="../../_images/keycloak-userclientmapper.png" />
</li>
</ol>
<p>After these steps have been completed, the tag ‘Department’ will appear in the
JWT (web token), under the ‘<a class="reference external" href="https://aws.amazon.com/tags">https://aws.amazon.com/tags</a>’ namespace.</p>
<p>Tags can be verified by performing token introspection on a JWT. To introspect
a token, use <code class="docutils literal notranslate"><span class="pre">client</span> <span class="pre">id</span></code> and <code class="docutils literal notranslate"><span class="pre">client</span> <span class="pre">secret</span></code> as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KC_REALM</span><span class="o">=</span><span class="n">demo</span>
<span class="n">KC_CLIENT</span><span class="o">=&lt;</span><span class="n">client</span> <span class="nb">id</span><span class="o">&gt;</span>
<span class="n">KC_CLIENT_SECRET</span><span class="o">=&lt;</span><span class="n">client</span> <span class="n">secret</span><span class="o">&gt;</span>
<span class="n">KC_SERVER</span><span class="o">=&lt;</span><span class="n">host</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">8080</span>
<span class="n">KC_CONTEXT</span><span class="o">=</span><span class="n">auth</span>

<span class="n">curl</span> <span class="o">-</span><span class="n">k</span> <span class="o">-</span><span class="n">v</span> \
<span class="o">-</span><span class="n">X</span> <span class="n">POST</span> \
<span class="o">-</span><span class="n">u</span> <span class="s2">&quot;$KC_CLIENT:$KC_CLIENT_SECRET&quot;</span> \
<span class="o">-</span><span class="n">d</span> <span class="s2">&quot;token=$KC_ACCESS_TOKEN&quot;</span> \
<span class="s2">&quot;http://$KC_SERVER/$KC_CONTEXT/realms/$KC_REALM/protocol/openid-connect/token/introspect&quot;</span> \
<span class="o">|</span> <span class="n">jq</span> <span class="o">.</span>
</pre></div>
</div>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph File System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph Block Device</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph Object Gateway</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../frontends/">HTTP Frontends</a></li>
<li class="toctree-l2"><a class="reference internal" href="../placement/">Pool Placement and Storage Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multisite/">Multisite Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multisite-sync-policy/">Multisite Sync Policy Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pools/">Configuring Pools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config-ref/">Config Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin/">Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s3/">S3 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rgw-cache/">Data caching and CDN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../swift/">Swift API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../adminops/">Admin Ops API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/">Python binding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nfs/">Export over NFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../keystone/">OpenStack Keystone Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../barbican/">OpenStack Barbican Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vault/">HashiCorp Vault Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kmip/">KMIP Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../opa/">Open Policy Agent Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multitenancy/">Multi-tenancy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compression/">Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ldap-auth/">LDAP Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../encryption/">Server-Side Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bucketpolicy/">Bucket Policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dynamicresharding/">Dynamic bucket index resharding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mfa/">Multi factor authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sync-modules/">Sync Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notifications/">Bucket Notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/">Data Layout in RADOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../STS/">STS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../STSLite/">STS Lite</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Keycloak</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-keycloak">Setting up Keycloak</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-keycloak-to-talk-to-rgw">Configuring Keycloak to talk to RGW</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fetching-a-web-token-with-keycloak">Fetching a web token with Keycloak</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-tags-to-a-user-in-keycloak">Adding tags to a user in Keycloak</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../session-tags/">Session Tags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../role/">Role</a></li>
<li class="toctree-l2"><a class="reference internal" href="../orphans/">Orphan List and Associated Tooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oidc/">OpenID Connect Provider</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/radosgw/">Manpage radosgw</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/radosgw-admin/">Manpage radosgw-admin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qat-accel/">QAT Acceleration for Encryption and Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s3select/">S3-select</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lua-scripting/">Lua Scripting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../session-tags/" title="Session tags for Attribute Based Access Control in STS"
             >next</a> |</li>
        <li class="right" >
          <a href="../STSLite/" title="STS Lite"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph Object Gateway</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Integrating Keycloak with RadosGW</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>