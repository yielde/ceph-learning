
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Open Policy Agent Integration &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="RGW Multi-tenancy" href="../multitenancy/" />
    <link rel="prev" title="KMIP Integration" href="../kmip/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../multitenancy/" title="RGW Multi-tenancy"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../kmip/" title="KMIP Integration"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Ceph Object Gateway</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Open Policy Agent Integration</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="open-policy-agent-integration">
<h1>Open Policy Agent Integration<a class="headerlink" href="#open-policy-agent-integration" title="Permalink to this heading">¶</a></h1>
<p>Open Policy Agent (OPA) is a lightweight general-purpose policy engine
that can be co-located with a service. OPA can be integrated as a
sidecar, host-level daemon, or library.</p>
<p>Services can offload policy decisions to OPA by executing queries. Hence,
policy enforcement can be decoupled from policy decisions.</p>
<section id="configure-opa">
<h2>Configure OPA<a class="headerlink" href="#configure-opa" title="Permalink to this heading">¶</a></h2>
<p>To configure OPA, load custom policies into OPA that control the resources users
are allowed to access. Relevant data or context can also be loaded into OPA to make decisions.</p>
<dl class="simple">
<dt>Policies and data can be loaded into OPA in the following ways::</dt><dd><ul class="simple">
<li><p>OPA’s RESTful APIs</p></li>
<li><p>OPA’s <em>bundle</em> feature that downloads policies and data from remote HTTP servers</p></li>
<li><p>Filesystem</p></li>
</ul>
</dd>
</dl>
</section>
<section id="configure-the-ceph-object-gateway">
<h2>Configure the Ceph Object Gateway<a class="headerlink" href="#configure-the-ceph-object-gateway" title="Permalink to this heading">¶</a></h2>
<p>The following configuration options are available for OPA integration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rgw</span> <span class="n">use</span> <span class="n">opa</span> <span class="n">authz</span> <span class="o">=</span> <span class="p">{</span><span class="n">use</span> <span class="n">opa</span> <span class="n">server</span> <span class="n">to</span> <span class="n">authorize</span> <span class="n">client</span> <span class="n">requests</span><span class="p">}</span>
<span class="n">rgw</span> <span class="n">opa</span> <span class="n">url</span> <span class="o">=</span> <span class="p">{</span><span class="n">opa</span> <span class="n">server</span> <span class="n">url</span><span class="p">:</span><span class="n">opa</span> <span class="n">server</span> <span class="n">port</span><span class="p">}</span>
<span class="n">rgw</span> <span class="n">opa</span> <span class="n">token</span> <span class="o">=</span> <span class="p">{</span><span class="n">opa</span> <span class="n">bearer</span> <span class="n">token</span><span class="p">}</span>
<span class="n">rgw</span> <span class="n">opa</span> <span class="n">verify</span> <span class="n">ssl</span> <span class="o">=</span> <span class="p">{</span><span class="n">verify</span> <span class="n">opa</span> <span class="n">server</span> <span class="n">ssl</span> <span class="n">certificate</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="how-does-the-rgw-opa-integration-work">
<h2>How does the RGW-OPA integration work<a class="headerlink" href="#how-does-the-rgw-opa-integration-work" title="Permalink to this heading">¶</a></h2>
<p>After a user is authenticated, OPA can be used to check if the user is authorized
to perform the given action on the resource. OPA responds with an allow or deny
decision which is sent back to the RGW which enforces the decision.</p>
<p>Example request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">ceph</span><span class="o">/</span><span class="n">authz</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">opa</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">8181</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span>

<span class="p">{</span>
    <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="s2">&quot;subuser&quot;</span><span class="p">:</span> <span class="s2">&quot;subuser&quot;</span><span class="p">,</span>
        <span class="s2">&quot;user_info&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;john&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;John&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;bucket_info&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;bucket&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Testbucket&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bucket_id&quot;</span><span class="p">:</span> <span class="s2">&quot;testbucket&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;owner&quot;</span><span class="p">:</span> <span class="s2">&quot;john&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">}</span>
</pre></div>
</div>
<p>The above is a sample request sent to OPA which contains information about the
user, resource and the action to be performed on the resource. Based on the polices
and data loaded into OPA, it will verify whether the request should be allowed or denied.
In the sample request, RGW makes a POST request to the endpoint <em>/v1/data/ceph/authz</em>,
where <em>ceph</em> is the package name and <em>authz</em> is the rule name.</p>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephadm/">Cephadm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph File System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph Block Device</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Ceph Object Gateway</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../frontends/">HTTP Frontends</a></li>
<li class="toctree-l2"><a class="reference internal" href="../placement/">Pool Placement and Storage Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multisite/">Multisite Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../multisite-sync-policy/">Multisite Sync Policy Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pools/">Configuring Pools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config-ref/">Config Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin/">Admin Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s3/">S3 API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rgw-cache/">Data caching and CDN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../swift/">Swift API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../adminops/">Admin Ops API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/">Python binding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nfs/">Export over NFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../keystone/">OpenStack Keystone Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../barbican/">OpenStack Barbican Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vault/">HashiCorp Vault Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kmip/">KMIP Integration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Open Policy Agent Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configure-opa">Configure OPA</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-the-ceph-object-gateway">Configure the Ceph Object Gateway</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-does-the-rgw-opa-integration-work">How does the RGW-OPA integration work</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../multitenancy/">Multi-tenancy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../compression/">Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ldap-auth/">LDAP Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../encryption/">Server-Side Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bucketpolicy/">Bucket Policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dynamicresharding/">Dynamic bucket index resharding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mfa/">Multi factor authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sync-modules/">Sync Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notifications/">Bucket Notifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/">Data Layout in RADOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../STS/">STS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../STSLite/">STS Lite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../keycloak/">Keycloak</a></li>
<li class="toctree-l2"><a class="reference internal" href="../session-tags/">Session Tags</a></li>
<li class="toctree-l2"><a class="reference internal" href="../role/">Role</a></li>
<li class="toctree-l2"><a class="reference internal" href="../orphans/">Orphan List and Associated Tooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oidc/">OpenID Connect Provider</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/radosgw/">Manpage radosgw</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../man/8/radosgw-admin/">Manpage radosgw-admin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../qat-accel/">QAT Acceleration for Encryption and Compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s3select/">S3-select</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lua-scripting/">Lua Scripting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../multitenancy/" title="RGW Multi-tenancy"
             >next</a> |</li>
        <li class="right" >
          <a href="../kmip/" title="KMIP Integration"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Ceph Object Gateway</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Open Policy Agent Integration</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>