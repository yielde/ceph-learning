
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Converting an existing cluster to cephadm &#8212; Ceph Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/ceph.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Host Management" href="../host-management/" />
    <link rel="prev" title="Compatibility and Stability" href="../compatibility/" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../host-management/" title="Host Management"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../compatibility/" title="Compatibility and Stability"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" accesskey="U">Cephadm</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Converting an existing cluster to cephadm</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div id="docubetter" align="right" style="padding: 15px; font-weight: bold;">
    <a href="https://pad.ceph.com/p/Report_Documentation_Bugs">Report a Documentation Bug</a>
  </div>

  
  <section id="converting-an-existing-cluster-to-cephadm">
<span id="cephadm-adoption"></span><h1>Converting an existing cluster to cephadm<a class="headerlink" href="#converting-an-existing-cluster-to-cephadm" title="Permalink to this heading">¶</a></h1>
<p>It is possible to convert some existing clusters so that they can be managed
with <code class="docutils literal notranslate"><span class="pre">cephadm</span></code>. This statment applies to some clusters that were deployed
with <code class="docutils literal notranslate"><span class="pre">ceph-deploy</span></code>, <code class="docutils literal notranslate"><span class="pre">ceph-ansible</span></code>, or <code class="docutils literal notranslate"><span class="pre">DeepSea</span></code>.</p>
<p>This section of the documentation explains how to determine whether your
clusters can be converted to a state in which they can be managed by
<code class="docutils literal notranslate"><span class="pre">cephadm</span></code> and how to perform those conversions.</p>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Cephadm works only with BlueStore OSDs. FileStore OSDs that are in your
cluster cannot be managed with <code class="docutils literal notranslate"><span class="pre">cephadm</span></code>.</p></li>
</ul>
</section>
<section id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this heading">¶</a></h2>
<ol class="arabic">
<li><p>Make sure that the <code class="docutils literal notranslate"><span class="pre">cephadm</span></code> command line tool is available on each host
in the existing cluster.  See <a class="reference internal" href="../install/#get-cephadm"><span class="std std-ref">Install cephadm</span></a> to learn how.</p></li>
<li><p>Prepare each host for use by <code class="docutils literal notranslate"><span class="pre">cephadm</span></code> by running this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><style type="text/css">
span.prompt1:before {
  content: "# ";
}
</style><span class="prompt1">cephadm<span class="w"> </span>prepare-host</span>
</pre></div></div></li>
<li><p>Choose a version of Ceph to use for the conversion. This procedure will work
with any release of Ceph that is Octopus (15.2.z) or later, inclusive.  The
latest stable release of Ceph is the default. You might be upgrading from an
earlier Ceph release at the same time that you’re performing this
conversion; if you are upgrading from an earlier release, make sure to
follow any upgrade-related instructions for that release.</p>
<p>Pass the image to cephadm with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">cephadm<span class="w"> </span>--image<span class="w"> </span><span class="nv">$IMAGE</span><span class="w"> </span>&lt;rest<span class="w"> </span>of<span class="w"> </span><span class="nb">command</span><span class="w"> </span>goes<span class="w"> </span>here&gt;</span>
</pre></div></div><p>The conversion begins.</p>
</li>
<li><p>Confirm that the conversion is underway by running <code class="docutils literal notranslate"><span class="pre">cephadm</span> <span class="pre">ls</span></code> and
making sure that the style of the daemons is changed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">cephadm<span class="w"> </span>ls</span>
</pre></div></div><p>Before starting the converstion process, <code class="docutils literal notranslate"><span class="pre">cephadm</span> <span class="pre">ls</span></code> shows all existing
daemons to have a style of <code class="docutils literal notranslate"><span class="pre">legacy</span></code>. As the adoption process progresses,
adopted daemons will appear with a style of <code class="docutils literal notranslate"><span class="pre">cephadm:v1</span></code>.</p>
</li>
</ol>
</section>
<section id="adoption-process">
<h2>Adoption process<a class="headerlink" href="#adoption-process" title="Permalink to this heading">¶</a></h2>
<ol class="arabic">
<li><p>Make sure that the ceph configuration has been migrated to use the cluster
config database.  If the <code class="docutils literal notranslate"><span class="pre">/etc/ceph/ceph.conf</span></code> is identical on each host,
then the following command can be run on one single host and will affect all
hosts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span>assimilate-conf<span class="w"> </span>-i<span class="w"> </span>/etc/ceph/ceph.conf</span>
</pre></div></div><p>If there are configuration variations between hosts, you will need to repeat
this command on each host. During this adoption process, view the cluster’s
configuration to confirm that it is complete by running the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>config<span class="w"> </span>dump</span>
</pre></div></div></li>
<li><p>Adopt each monitor:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">cephadm<span class="w"> </span>adopt<span class="w"> </span>--style<span class="w"> </span>legacy<span class="w"> </span>--name<span class="w"> </span>mon.&lt;hostname&gt;</span>
</pre></div></div><p>Each legacy monitor should stop, quickly restart as a cephadm
container, and rejoin the quorum.</p>
</li>
<li><p>Adopt each manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">cephadm<span class="w"> </span>adopt<span class="w"> </span>--style<span class="w"> </span>legacy<span class="w"> </span>--name<span class="w"> </span>mgr.&lt;hostname&gt;</span>
</pre></div></div></li>
<li><p>Enable cephadm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>mgr<span class="w"> </span>module<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>cephadm</span>
<span class="prompt1">ceph<span class="w"> </span>orch<span class="w"> </span><span class="nb">set</span><span class="w"> </span>backend<span class="w"> </span>cephadm</span>
</pre></div></div></li>
<li><p>Generate an SSH key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>cephadm<span class="w"> </span>generate-key</span>
<span class="prompt1">ceph<span class="w"> </span>cephadm<span class="w"> </span>get-pub-key<span class="w"> </span>&gt;<span class="w"> </span>~/ceph.pub</span>
</pre></div></div></li>
<li><p>Install the cluster SSH key on each host in the cluster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ssh-copy-id<span class="w"> </span>-f<span class="w"> </span>-i<span class="w"> </span>~/ceph.pub<span class="w"> </span>root@&lt;host&gt;</span>
</pre></div></div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is also possible to import an existing SSH key. See
<a class="reference internal" href="../troubleshooting/#cephadm-ssh-errors"><span class="std std-ref">SSH errors</span></a> in the troubleshooting
document for instructions that describe how to import existing
SSH keys.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is also possible to have cephadm use a non-root user to SSH
into cluster hosts. This user needs to have passwordless sudo access.
Use <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">cephadm</span> <span class="pre">set-user</span> <span class="pre">&lt;user&gt;</span></code> and copy the SSH key to that user.
See <a class="reference internal" href="../host-management/#cephadm-ssh-user"><span class="std std-ref">Configuring a different SSH user</span></a></p>
</div>
</li>
<li><p>Tell cephadm which hosts to manage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>orch<span class="w"> </span>host<span class="w"> </span>add<span class="w"> </span>&lt;hostname&gt;<span class="w"> </span><span class="o">[</span>ip-address<span class="o">]</span></span>
</pre></div></div><p>This will perform a <code class="docutils literal notranslate"><span class="pre">cephadm</span> <span class="pre">check-host</span></code> on each host before adding it;
this check ensures that the host is functioning properly. The IP address
argument is recommended; if not provided, then the host name will be resolved
via DNS.</p>
</li>
<li><p>Verify that the adopted monitor and manager daemons are visible:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>orch<span class="w"> </span>ps</span>
</pre></div></div></li>
<li><p>Adopt all OSDs in the cluster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">cephadm<span class="w"> </span>adopt<span class="w"> </span>--style<span class="w"> </span>legacy<span class="w"> </span>--name<span class="w"> </span>&lt;name&gt;</span>
</pre></div></div><p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">cephadm<span class="w"> </span>adopt<span class="w"> </span>--style<span class="w"> </span>legacy<span class="w"> </span>--name<span class="w"> </span>osd.1</span>
<span class="prompt1">cephadm<span class="w"> </span>adopt<span class="w"> </span>--style<span class="w"> </span>legacy<span class="w"> </span>--name<span class="w"> </span>osd.2</span>
</pre></div></div></li>
<li><p>Redeploy MDS daemons by telling cephadm how many daemons to run for
each file system. List file systems by name with the command <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">fs</span>
<span class="pre">ls</span></code>. Run the following command on the master nodes to redeploy the MDS
daemons:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>mds<span class="w"> </span>&lt;fs-name&gt;<span class="w"> </span><span class="o">[</span>--placement<span class="o">=</span>&lt;placement&gt;<span class="o">]</span></span>
</pre></div></div><p>For example, in a cluster with a single file system called <cite>foo</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>fs<span class="w"> </span>ls</span>
</pre></div></div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>name:<span class="w"> </span>foo,<span class="w"> </span>metadata<span class="w"> </span>pool:<span class="w"> </span>foo_metadata,<span class="w"> </span>data<span class="w"> </span>pools:<span class="w"> </span><span class="o">[</span>foo_data<span class="w"> </span><span class="o">]</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>mds<span class="w"> </span>foo<span class="w"> </span><span class="m">2</span></span>
</pre></div></div><p>Confirm that the new MDS daemons have started:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>orch<span class="w"> </span>ps<span class="w"> </span>--daemon-type<span class="w"> </span>mds</span>
</pre></div></div><p>Finally, stop and remove the legacy MDS daemons:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">systemctl<span class="w"> </span>stop<span class="w"> </span>ceph-mds.target</span>
<span class="prompt1">rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/ceph/mds/ceph-*</span>
</pre></div></div></li>
<li><p>Redeploy RGW daemons. Cephadm manages RGW daemons by zone. For each
zone, deploy new RGW daemons with cephadm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">ceph<span class="w"> </span>orch<span class="w"> </span>apply<span class="w"> </span>rgw<span class="w"> </span>&lt;svc_id&gt;<span class="w"> </span><span class="o">[</span>--realm<span class="o">=</span>&lt;realm&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>--zone<span class="o">=</span>&lt;zone&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>--port<span class="o">=</span>&lt;port&gt;<span class="o">]</span><span class="w"> </span><span class="o">[</span>--ssl<span class="o">]</span><span class="w"> </span><span class="o">[</span>--placement<span class="o">=</span>&lt;placement&gt;<span class="o">]</span></span>
</pre></div></div><p>where <em>&lt;placement&gt;</em> can be a simple daemon count, or a list of
specific hosts (see <a class="reference internal" href="../services/#orchestrator-cli-placement-spec"><span class="std std-ref">Daemon Placement</span></a>), and the
zone and realm arguments are needed only for a multisite setup.</p>
<p>After the daemons have started and you have confirmed that they are
functioning, stop and remove the old, legacy daemons:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span class="prompt1">systemctl<span class="w"> </span>stop<span class="w"> </span>ceph-rgw.target</span>
<span class="prompt1">rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/ceph/radosgw/ceph-*</span>
</pre></div></div></li>
<li><p>Check the output of the command <code class="docutils literal notranslate"><span class="pre">ceph</span> <span class="pre">health</span> <span class="pre">detail</span></code> for cephadm warnings
about stray cluster daemons or hosts that are not yet managed by cephadm.</p></li>
</ol>
</section>
</section>



            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../start/intro/">Intro to Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/">Installing Ceph</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Cephadm</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../compatibility/">Compatibility and Stability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../install/">Deploying a new Ceph cluster</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Converting an existing cluster to cephadm</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#limitations">Limitations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preparation">Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adoption-process">Adoption process</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../host-management/">Host Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../services/">Service Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../upgrade/">Upgrading Ceph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../operations/">Cephadm operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../client-setup/">Client Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/cephadm/">Cephadm Feature Planning</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../rados/">Ceph Storage Cluster</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../rados/configuration/">Configuration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../">Deployment</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../compatibility/">Compatibility and Stability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../install/">Deploying a new Ceph cluster</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Converting an existing cluster to cephadm</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#limitations">Limitations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparation">Preparation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adoption-process">Adoption process</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../host-management/">Host Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../services/">Service Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../upgrade/">Upgrading Ceph</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operations/">Cephadm operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../client-setup/">Client Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../dev/cephadm/">Cephadm Feature Planning</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../rados/operations/">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rados/man/">Man Pages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rados/troubleshooting/">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../rados/api/">APIs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cephfs/">Ceph File System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rbd/">Ceph Block Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../radosgw/">Ceph Object Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/">Ceph Manager Daemon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mgr/dashboard/">Ceph Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/developer_guide/">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev/internals/">Ceph Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../foundation/">Ceph Foundation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ceph-volume/">ceph-volume</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/general/">Ceph Releases (general)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.ceph.com/en/latest/releases/">Ceph Releases (index)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>


<!-- ugly kludge to make genindex look like it's part of the toc -->
<ul style="margin-top: -10px"><li class="toctree-l1"><a class="reference internal" href="../../genindex/">Index</a></li></ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../http-routingtable/" title="HTTP Routing Table"
             >routing table</a> |</li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../host-management/" title="Host Management"
             >next</a> |</li>
        <li class="right" >
          <a href="../compatibility/" title="Compatibility and Stability"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../">Ceph Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../" >Cephadm</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Converting an existing cluster to cephadm</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Ceph authors and contributors. Licensed under Creative Commons Attribution Share Alike 3.0 (CC-BY-SA-3.0).
    </div>
  </body>
</html>